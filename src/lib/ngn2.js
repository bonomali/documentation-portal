!function(){"use strict";var t=function(n){function e(e){n.call(this),Object.defineProperty(this,"frameFilter",NGN.privateconst(function(e){return NGN.nodelike?e.getFileName()!==__filename&&e.getFileName():e.getFileName()})),(e="string"==typeof(e=e||{})?{message:e}:e).custom=e.custom||{};var r=this;for(var t in this.name=e.name||"NgnError",this.type=e.type||"TypeError",this.severity=e.severity||"minor",this.message=e.message||"Unknown Error",this.category=e.category||"operational",this.name=this.name.replace(/[^a-zA-Z0-9_]/gi,""),e.custom)e.custom.hasOwnProperty(t)&&(this[t]=e.custom[t]);if(this.hasOwnProperty("custom")&&delete this.custom,NGN.nodelike||n.prepareStackTrace){n.prepareStackTrace=function(e,t){return t};var i=new n;n.captureStackTrace(i,this),this.rawstack=i.stack,n.prepareStackTrace=function(e,t){return r.cause&&console.warn(r.cause),r.help&&console.info(r.help),r.name+": "+r.message+"\n"+t.filter(r.frameFilter).map(function(e){return"    at "+e}).join("\n")},n.captureStackTrace(this)}}n&&(e.__proto__=n),(e.prototype=Object.create(n&&n.prototype)).constructor=e;var t={trace:{configurable:!0}};return t.trace.get=function(){return this.rawstack.filter(this.frameFilter).map(function(e){return{filename:e.getFileName(),line:e.getLineNumber(),column:e.getColumnNumber(),functionname:e.getFunctionName(),native:e.isNative(),eval:e.isEval(),type:e.getTypeName()}})},Object.defineProperties(e.prototype,t),e}(Error),n=Object.defineProperties({get global(){return window}},{define:{enumerable:!1,writable:!1,configurable:!1,value:function(e,t,r,i){return{enumerable:e,writable:t,configurable:r,value:i}}},version:{enumerable:!0,writable:!1,configurable:!1,value:"#VERSION#"}});Object.defineProperties(n,{public:n.define(!1,!1,!1,function(e){return n.define(!0,"function"!=typeof e,!1,e)}),private:n.define(!1,!1,!1,function(e){return n.define(!1,"function"!=typeof e,!1,e)}),const:n.define(!1,!1,!1,function(e){return n.define(!0,!1,!1,e)}),privateconst:n.define(!1,!1,!1,function(e){return n.define(!1,!1,!1,e)}),get:n.define(!1,!1,!1,function(e){return{enumerable:!1,get:e}}),set:n.define(!1,!1,!1,function(e){return{enumerable:!1,set:e}}),getset:n.define(!1,!1,!1,function(e,t){return{enumerable:!1,get:e,set:t}}),LEDGER_EVENT:n.define(!1,!1,!1,function(i){return function(){for(var e,t=arguments.length,r=Array(t);t--;)r[t]=arguments[t];(e=n.BUS).emit.apply(e,[i].concat(r))}})}),Object.defineProperties(n,{extend:n.privateconst(function(e,t){"object"==typeof e?Object.defineProperties(this,e):Object.defineProperty(this,e,t)}),inherit:n.const(function(r,i){(void 0===r&&(r=null),void 0===i&&(i=null),r&&i)&&(r="function"==typeof r?r.prototype:r,i="function"==typeof i?i.prototype:i,Object.getOwnPropertyNames(r).forEach(function(e){var t=Object.getOwnPropertyDescriptor(r,e);Object.defineProperty(i,e,t)}),Object.getOwnPropertyNames(Object.getPrototypeOf(r)).filter(function(e){return"constructor"!==e.trim().toLowerCase()&&!i.hasOwnProperty(e)}).forEach(function(e){void 0===Object.getOwnPropertyDescriptor(r,e)&&"function"==typeof r[e]&&Object.defineProperty(i,e,n.public(function(){return r[e].apply(this,arguments)}))}))}),slice:n.private(function(e){return Array.prototype.slice.call(e)}),splice:n.private(function(e){return Array.prototype.splice.call(e)}),nullIf:n.public(function(t,r){void 0===r&&(r="");try{if(t!==r){if(typeof t!=typeof r)return t;if("string"==typeof t&&t.trim()!==r.trim())return t}return t===r?null:t}catch(e){return n.WARN("nullIf threw an error ("+e.message+") when comparing '"+t+"' to '"+r+"'."),null}}),nullif:n.public(function(){var e;return(e=this).nullIf.apply(e,arguments)}),converge:n.private(function(){var e=arguments;if(arguments.length<2)return null;if(2===arguments.length)return void 0===arguments[1]?null:arguments[0]?n.nullIf(arguments[1]):arguments[1];for(var t=1;t<arguments.length;t++)if(void 0!==e[t]&&null!==(e[0]?n.nullIf(e[t]):e[t])&&void 0!==e[t])return e[t];return null}),coalesce:n.public(function(){for(var e=arguments.length,t=Array(e);e--;)t[e]=arguments[e];return n.converge.apply(n,[!1].concat(t))}),coalesceb:n.public(function(){for(var e=arguments.length,t=Array(e);e--;)t[e]=arguments[e];return n.converge.apply(n,[!0].concat(t))}),nodelike:n.const(void 0!==n.global.process),dedupe:n.const(function(e){for(var t=[],r=0;r<e.length;r++)e.indexOf(e[r])===r&&t.push(e[r]);return e=null,t}),typeof:n.const(function(e){if(void 0===e)return"undefined";if(null===e)return"null";var t=Object.prototype.toString.call(e).split(" ")[1].replace(/[^A-Za-z]/gi,"").toLowerCase();if("function"===t||"function"==typeof e){if(!e.name){var r=n.coalesceb(e.toString().replace(/\n/gi,"").replace(/^function\s|\(.*$/gim,"").toLowerCase(),"function");return 0<=r.indexOf(" ")?"function":r}t=n.coalesceb(e.name,"function")}return t.toLowerCase()}),forceArray:n.const(function(e){return null===e?[]:"array"===n.typeof(e)?e:[e]}),forceBoolean:n.const(function(e){switch(n.typeof(e)){case"boolean":return e;case"number":return 0!==e;case"string":return"false"!==(e=e.trim().toLowerCase());default:return null!==n.coalesceb(e)}}),forceNumber:n.const(function(e,t){void 0===t&&(t=null);try{switch(n.typeof(e)){case"boolean":return e?1:0;case"number":return e;case"date":return e.getTime();case"string":return null!==t?parseInt(e,t):parseFloat(e);default:return NaN}}catch(e){return n.ERROR(e),NaN}}),processStackItem:n.privateconst(function(e,t){return e.replace(/at.*\(|\)/gi,"").replace(t,"./").replace(/\/{2,100}/gi,"/").trim().split(":")}),stack:n.get(function(){var r=this,e=((new Error).stack.split("\n"),(new Error).stack.split("\n")||[]),i=/at.*\(/gi;return 0!==(e=e.filter(function(e){return 1<e.split(":").length}).map(function(e){var t=i.exec(e);return t&&(t=t[0].replace(/^at\s{1,100}|\s{1,100}\($/gi,"").replace("<anonymous>","console")),r.nodelike?{path:(e=r.processStackItem(e.toString(),process.cwd())).join(":").replace("./",process.cwd()+"/"),file:e[0].substr(0,e[0].length),line:parseInt(e[1],10),column:parseInt(e[2],10),operation:t}:{path:(e=r.processStackItem(e.toString(),window.location.origin))[0].substr(1,e[0].length-1)+":"+e[1]+":"+e[2],file:e[0].substr(1,e[0].length-1),line:parseInt(e[1],10),column:parseInt(e[2],10),operation:t}})).length?this.nodelike?e.reverse():e:[{path:"unknown",file:"unknown",line:0,column:0}]}),isFn:n.privateconst(function(e){return"function"==typeof e}),wrap:n.privateconst(function(e,t){return function(){e.apply(void 0,arguments),t.apply(void 0,arguments)}}),wrapClass:n.privateconst(function(r,i){return function(){for(var e=arguments.length,t=Array(e);e--;)t[e]=arguments[e];return r.apply(void 0,arguments),new(Function.prototype.bind.apply(i,[null].concat(t)))}}),deprecate:n.privateconst(function(e,t){return void 0===t&&(t="The method has been deprecated."),this.wrap(function(){return n.WARN("DEPRECATED.METHOD",t)},e)}),deprecateClass:n.privateconst(function(e,t){return void 0===t&&(t="The class has been deprecated."),this.wrapClass(function(){return n.WARN("DEPRECATED.CLASS",t)},e)}),needs:n.private(function(){for(var e=arguments.length,t=Array(e);e--;)t[e]=arguments[e];var r=n.getObjectMissingPropertyNames.apply(n,[n].concat(t));if(0!==r.length&&0<r.length)throw new MissingNgnDependencyError(("Missing NGN dependencies: "+r.join(", ")).replace(/\s{2,100}/gi," "))}),getObjectMissingPropertyNames:n.private(function(){for(var e=arguments,t=[],r=Object.keys(arguments[0]),i=1;i<arguments.length;i++)r.indexOf(e[i])<0&&t.push(e[i]);return t}),getObjectExtraneousPropertyNames:n.private(function(){for(var e=arguments,t=Object.keys(arguments[0]),r=1;r<arguments.length;r++){var i=t.indexOf(e[r]);0<=i&&t.splice(i,1)}return t}),objectHasAll:n.const(function(){for(var e=arguments,t=Object.keys(arguments[0]),r=1;r<arguments.length;r++)if(t.indexOf(e[r])<0)return!1;return!0}),objectHasAny:n.const(function(){for(var e=arguments,t=Object.keys(arguments[0]),r=1;r<arguments.length;r++)if(0<=t.indexOf(e[r]))return!0;return!1}),objectHasExactly:n.const(function(){if(0!==this.getObjectMissingPropertyNames(arguments[0]).length)return!1;var e=Object.keys(arguments[0]),t=n.slice(arguments);t.shift();for(var r=0;r<e.length;r++)if(t.indexOf(e[r])<0)return!1;for(var i=0;i<t.length;i++)if(e.indexOf(t[i])<0)return!1;return!0}),objectRequires:n.const(function(){var e,t=(e=this).objectHasAll.apply(e,arguments);if(!t)throw new Error(arguments[0].constructor.name+" is missing the following attributes: "+t.missing.join(", "))}),createAlias:n.private(function(e,t,r){Object.defineProperty(e,t,n.get(function(){return r}))}),WARNING_EVENT:n.privateconst(Symbol("NGN.WARN")),WARN:n.privateconst(function(e){return n.LEDGER_EVENT(n.WARNING_EVENT)(e)}),INFO_EVENT:n.privateconst(Symbol.for("NGN.INFO")),INFO:n.privateconst(function(e){return n.LEDGER_EVENT(n.INFO_EVENT)(e)}),ERROR_EVENT:n.privateconst(Symbol.for("NGN.ERROR")),ERROR:n.privateconst(function(e){return n.LEDGER_EVENT(n.ERROR_EVENT)(e)}),INTERNAL_EVENT:n.privateconst(Symbol.for("NGN.INTERNAL")),INTERNAL:n.privateconst(function(){n.LEDGER_EVENT(n.INTERNAL_EVENT).apply(void 0,arguments)}),createException:n.const(function(e){(e="string"==typeof(e=e||{})?{message:e}:e).name=e.name||"NgnError",n.global[e.name]=function(){return 0<arguments.length&&(e.message=arguments[0]),new t(e)}}),getType:n.const(function(e,t){switch(e.trim().toLowerCase()){case"number":return Number;case"regex":n.WARN("regex is not a valid JavaScript type. Using regexp instead.");case"regexp":return RegExp;case"boolean":return Boolean;case"symbol":return Symbol;case"date":return Date;case"array":return Array;case"object":return Object;case"function":return Function;case"string":return String;default:return t||void 0}}),platform:n.get(function(){var e,t=(e=navigator.platform).toLowerCase();return{name:e,type:t=0<=t.indexOf("ios")||t.indexOf("like mac")?"ios":0<=t.indexOf("mac")?"mac":0<=t.indexOf("win")?"windows":0<=t.indexOf("android")?"android":0<=t.indexOf("linux")?"linux":"other",version:/\((.*)\)/i.exec(navigator.userAgent)[1].split(";")[0].split(/\s+/i).pop()}})}),n.createException({name:"MissingNgnDependencyError",type:"MissingNgnDependencyError",severity:"critical",message:"An NGN dependency is missing or could not be found.",category:"programmer",custom:{help:"Include the missing library.",cause:"A required dependency was not included, or it was not included in the correct sequence."}}),n.createException({name:"ReservedWordError",type:"ReservedWordError",severity:"critical",message:"An attempt to use a reserved word failed.",category:"programmer",custom:{help:"Use an alternative word.",cause:"A word was used to define an attribute, method, field, or other element that already exists."}}),n.createException({name:"InvalidConfigurationError",type:"InvalidConfigurationError",severity:"critical",message:"Invalid configuration.",category:"programmer",custom:{help:"See the documentation for the proper configuration.",cause:"The configuration specified was marked as invalid or caused an error during instantiation."}}),n.global.NGN=n;var e=function(e){e=e||{},Object.defineProperties(this,{handlers:NGN.private({}),adhoc:NGN.private({}),maxlisteners:NGN.private(e.defaultMaxListeners||25)})},r={subscribers:{configurable:!0},defaultMaxListeners:{configurable:!0}};r.subscribers.get=function(){var e={};for(var t in this.handlers)e[t]={handler:this.handlers[t].length,adhoc:0};for(var r in this.adhoc)e[r]=e[r]||{handler:0},e[r].adhoc=this.adhoc[r].length;return e},r.defaultMaxListeners.get=function(){return this.maxlisteners},r.defaultMaxListeners.set=function(e){this.maxlisteners=e},e.prototype.listenerCount=function(e){return(this.handlers[e]||[]).length+(this.adhoc[e]||[]).length},e.prototype.getMaxListeners=function(){return this.defaultMaxListeners},e.prototype.setMaxListeners=function(e){this.defaultMaxListeners=e},e.prototype.eventNames=function(){var e=Object.keys(this.handlers),t=Object.keys(this.adhoc);return NGN.dedupe(e.concat(t))},e.prototype.listeners=function(e){var t=this.handlers[e]||[],r=this.adhoc[e]||[];return t.concat(r)},e.prototype.addListener=function(e,t){if("object"==typeof e)return this.pool(e);if(this.handlers[e]=this.handlers[e]||[],this.handlers[e].unshift(t),this.emit("newListener",e,t),this.listenerCount(e)>this.maxlisteners)throw new Error("Maximum event listeners exceeded. Use setMaxListeners() to adjust the level.")},e.prototype.prependListener=function(e,t){if("object"==typeof e)return this.pool(e);if(this.handlers[e]=this.handlers[e]||[],this.handlers[e].push(t),this.emit("newListener",e,t),this.listenerCount(e)>this.maxlisteners)throw new Error("Maximum event listeners exceeded. Use setMaxListeners() to adjust the level.")},e.prototype.once=function(e,t){if(this.adhoc[e]=this.adhoc[e]||[],this.adhoc[e].push(t),this.emit("newListener",e,t),this.listenerCount(e)>this.maxlisteners)throw new Error("Maximum event listeners exceeded. Use setMaxListeners() to adjust the level.")},e.prototype.prependOnceListener=function(e,t){if(this.adhoc[e]=this.adhoc[e]||[],this.adhoc[e].unshift(t),this.emit("newListener",e,t),this.listenerCount(e)>this.maxlisteners)throw new Error("Maximum event listeners exceeded. Use setMaxListeners() to adjust the level.")},e.prototype.removeListener=function(e,t){this.deleteEventHandler("handlers",e,t),this.deleteEventHandler("adhoc",e,t)},e.prototype.deleteEventHandler=function(e,t,r){var i=this[e];if(i[t]){if(!r)return void delete i[t];var n=[];if(i[t].forEach(function(e){e.toString()!==r.toString()&&n.push(e)}),0===n.length)return void delete i[t];i[t]=n}},e.prototype.removeAllListeners=function(e){void 0===e&&(e=null),null!==e?(delete this.handlers[e],delete this.adhoc[e]):(this.handlers={},this.adhoc={})},e.prototype.emit=function(){var e=NGN.slice(arguments),t=e.shift(),r=this.getAllEvents(t);"symbol"==typeof t&&r.push(t);for(var i={event:t},n=0;n<r.length;n++){var o=this.adhoc[r[n]];if(o)for(delete this.adhoc[r[n]];0<o.length;){var s=o.pop();(i.handler=s).apply(i,e)}var a=this.handlers[r[n]];if(a)for(var l=0;l<a.length;l++)i.handler=a[l],a[l].apply(i,e)}},e.prototype.getAllEvents=function(t){var e=Object.keys(this.handlers),r=Object.keys(this.adhoc),i=NGN.dedupe(e.concat(r));return i=i.filter(function(e){return e===t||("regexp"===NGN.typeof(e)||0<=e.indexOf("*"))&&("regexp"!==NGN.typeof(e)&&(e=new RegExp(e.replace(/\./g,"\\.").replace(/\*/g,".*"),"g")),e.test(t))})},Object.defineProperties(e.prototype,r);var i=function(l){function e(){var s=this;l.call(this),Object.defineProperties(this,{META:NGN.private({queued:{},collectionQueue:{},thresholdQueue:{},defaultTTL:-1,wildcardEvents:new Set}),setTTL:NGN.const(function(e){void 0===e&&(e=-1),0!==e?s.META.defaultTTL=e:NGN.WARN("NGN.EventEmitter#TTL cannot be 0.")}),off:NGN.public(function(e,t){if("array"!==NGN.typeof(e)){var r=s.listeners(e);if(!NGN.isFn(t))return s.clear(e);var i=s.wrapEventHandlerWithScope(e,t);if(r.indexOf(i)<0){for(var n=0;n<r.length;n++)if(r[n].toString()===i.toString()){s.META.wildcardEvents.delete(e),s.removeListener(e,r[n],!1);break}}else s.META.wildcardEvents.delete(e),s.removeListener(e,t)}else for(var o=0;o<e.length;o++)s.off(e[o],t)}),deprecate:NGN.const(function(t,r){var i=s;s.on(t,function(){if(NGN.WARN(t+" is deprecated. "+(r?"Use "+r+" instead.":"")),r){var e=NGN.slice(arguments);e.shift(),e.unshift(r),i.emit.apply(i,e)}})}),pool:NGN.privateconst(function(e,t){"string"!=typeof e&&(t=e,e="");var r={};for(var i in t){var n=""+NGN.coalesce(e,"")+i;NGN.isFn(t[i])?(this.increaseMaxListeners(),r[i]=this.on(n,t[i])):"object"==typeof t[i]?this.pool(n+".",t[i]):NGN.WARN(n+" could not be pooled in the event emitter because it's value is not a function.")}}),attach:NGN.const(function(r,i){for(var n=arguments,o=this,e=arguments.length,t=Array(e);e--;)t[e]=arguments[e];return i=NGN.coalesce(i,!1),function(e){var t;i&&!NGN.nodelike&&e.preventDefault(),(t=o).emit.apply(t,[r].concat(n))}}),increaseMaxListeners:NGN.private(function(e){void 0===e&&(e=1),s.setMaxListeners(s.getMaxListeners()+e)}),decreaseMaxListeners:NGN.private(function(e){void 0===e&&(e=1),s.setMaxListeners(s.getMaxListeners()-e)}),forward:NGN.const(function(e,t,r){var i=this;t=NGN.forceArray(t);var n=this,o=function(){var e=NGN.slice(arguments);r&&e.push(r),n.emit.apply(n,[t].concat(e))};return this.increaseMaxListeners(),this.on(e,o),{remove:function(){i.decreaseMaxListeners(),i.off(e,o)}}}),relay:NGN.const(function(e,r,i,n){void 0===i&&(i=null),void 0===n&&(n=null);for(var t=NGN.forceArray(e),o=0;o<t.length;o++){var s=t[o];this.on(s,function(){for(var e=arguments.length,t=Array(e);e--;)t[e]=arguments[e];"symbol"===NGN.typeof(this.event)?(null===i&&null===n||NGN.INFO("Cannot relay a symbol-based event with a prefix/postfix."),r.emit.apply(r,arguments)):r.emit.apply(r,[""+NGN.coalesce(i,"")+this.event+NGN.coalesce(n,"")].concat(t))})}}),relayOnce:NGN.const(function(e,r,i,n){void 0===i&&(i=null),void 0===n&&(n=null);for(var t=NGN.forceArray(e),o=0;o<t.length;o++){var s=t[o];this.once(s,function(){for(var e=arguments.length,t=Array(e);e--;)t[e]=arguments[e];"symbol"===NGN.typeof(this.event)?(null===i&&null===n||NGN.INFO("Cannot relay a symbol-based event with a prefix/postfix."),r.emit.apply(r,arguments)):r.emit.apply(r,[""+NGN.coalesce(i,"")+this.event+NGN.coalesce(n,"")].concat(t))})}}),delayEmit:NGN.const(function(t,e){var r=this;if(!this.META.queued.hasOwnProperty(t)){var i=NGN.slice(arguments);i.splice(1,1),this.META.queued[t]=setTimeout(function(){var e;r.META.queued[t](e=r).emit.apply(e,i)},e)}}),getInternalCollectionId:NGN.privateconst(function(e){return Symbol(e)}),handleCollectionTrigger:NGN.privateconst(function(t,r){var i=this;return function(){setTimeout(function(){var e=i.META.collectionQueue;e[r]&&(e[r].remainingqueue.delete(t),0===e[r].remainingqueue.size&&(e[r].remainingqueue=e[r].masterqueue,NGN.isFn(e[r].eventName)?e[r].eventName(e[r].payload):i.emit(e[r].eventName,e[r].payload)))},0)}}),funnel:NGN.const(function(e,t,r){if(void 0===r&&(r=null),"array"!==NGN.typeof(e))throw new Error("NGN.BUS.funnel expected an array of events, but received a(n) "+NGN.typeof(e));var i=new Set(e),n=s.getInternalCollectionId(s.META.collectionQueue);return s.META.collectionQueue[n]={},Object.defineProperties(s.META.collectionQueue[n],{masterqueue:NGN.const(new Set(e)),remainingqueue:NGN.private(i),eventName:NGN.const(t),remove:NGN.const(function(){s.META.collectionQueue[n].masterqueue.forEach(function(e){s.off(e,s.handleCollectionTrigger(e,n))}),s.decreaseMaxListeners(s.META.collectionQueue[n].masterqueue.size),delete s.META.collectionQueue[n]}),payload:NGN.const(r)}),s.increaseMaxListeners(i.size),i.forEach(function(e){s.on(e,s.handleCollectionTrigger(e,n))}),s.META.collectionQueue[n]}),funnelOnce:NGN.const(function(e,t,r){void 0===r&&(r=null);var i="::NGNFUNNEL::"+(new Date).getTime()+"::"+t,n=s.funnel(e,i,r);s.increaseMaxListeners(),s.once(i,function(){n.remove(),n=null,s.emit(t,r)})}),threshold:NGN.const(function(e,t,r,i){var n=this;if(void 0===i&&(i=null),"string"!=typeof e)throw new Error("The threshold event name must be a string (received "+typeof e+")");var o=this.getInternalCollectionId(this.META.thresholdQueue);return this.META.thresholdQueue[o]={},Object.defineProperties(this.META.thresholdQueue[o],{key:NGN.const(o),eventName:NGN.const(e),limit:NGN.const(t),count:NGN.private(0),finalEventName:NGN.const(r),remove:NGN.const(function(){var e=n.META.thresholdQueue[o].eventName;delete n.META.thresholdQueue[o],n.decreaseMaxListeners(),n.off(e,n.handleThresholdTrigger(o))}),payload:NGN.const(i)}),this.increaseMaxListeners(),this.on(e,this.handleThresholdTrigger(o)),this.META.thresholdQueue[o]}),thresholdOnce:NGN.const(function(e,t,r,i){void 0===i&&(i=null);var n="::NGNTHRESHOLD::"+(new Date).getTime()+"::"+r,o=this.threshold(e,t,n,i),s=this;this.once(n,function(){o.remove(),o=null,NGN.isFn(r)?r(i):s.emit(r,i)})}),handleThresholdTrigger:NGN.const(function(e){var t=this;return function(){setTimeout(function(){t.META.thresholdQueue.hasOwnProperty(e)&&(t.META.thresholdQueue[e].count++,t.META.thresholdQueue[e].count===t.META.thresholdQueue[e].limit&&(NGN.isFn(t.META.thresholdQueue[e].finalEventName)?t.META.thresholdQueue[e].finalEventName(t.META.thresholdQueue[e].payload):t.emit(t.META.thresholdQueue[e].finalEventName,t.META.thresholdQueue[e].payload),t.META.thresholdQueue.hasOwnProperty(e)&&(t.META.thresholdQueue[e].count=0)))},0)}}),wrapEventHandlerWithScope:NGN.privateconst(function(t,e){if(!NGN.nodelike)return e;var r=e;return function(){var e=arguments;"symbol"==typeof e[e.length-1]&&(t=e[e.length-1].toString().replace(/Symbol\(|\)/gi,""),(e=NGN.slice(e)).pop()),r.apply({event:t,trace:NGN.stack},e)}}),applyScope:NGN.privateconst(function(e){NGN.nodelike&&1<e.length&&(e[e.length-1].listener?e[e.length-1].listener=s.wrapEventHandlerWithScope(e[0],e[e.length-1].listener):e[e.length-1]=s.wrapEventHandlerWithScope(e[0],e[e.length-1]))})})}return l&&(e.__proto__=l),((e.prototype=Object.create(l&&l.prototype)).constructor=e).prototype.clear=function(){var e=NGN.slice(arguments);if(0===e.length){this.META.wildcardEvents.clear();var t=[];t=NGN.nodelike?Object.getOwnPropertySymbols(this._events):(t=Object.getOwnPropertySymbols(this.adhoc)).concat(Object.getOwnPropertySymbols(this.handlers));for(var r=0;r<t.length;r++)this.removeAllListeners(t[r]);return this.removeAllListeners()}for(var i=0;i<e.length;i++)this.META.wildcardEvents.delete(e[i]),this.removeAllListeners(e[i])},e.prototype.eventHandler=function(e,t,r,i){var n=this;return void 0===i&&(i=!1),"boolean"===NGN.typeof(r)&&(i=r,r=this.META.defaultTTL),void 0===r&&(r=this.META.defaultTTL),0<r&&setTimeout(function(){return n.off(e,t)},r),"string"==typeof e&&0<=e.indexOf("*")&&this.META.wildcardEvents.add(e),i},e.prototype.on=function(e,t,r,i){var n;if(void 0===i&&(i=!1),"array"!==NGN.typeof(e))(n=this).eventHandler.apply(n,arguments)?this.prependListener(e,t):this.addListener(e,t);else for(var o=0;o<e.length;o++)this.on(e[o],t,r,i)},e.prototype.once=function(e,t,r,i){var n;if(void 0===i&&(i=!1),"array"!==NGN.typeof(e))(n=this).eventHandler.apply(n,arguments)?this.prependOnceListener(e,t):l.prototype.once.call(this,e,this.wrapEventHandlerWithScope(e,t));else for(var o=0;o<e.length;o++)this.once(e[o],t,r,i)},e.prototype.prependListener=function(){this.applyScope(arguments),l.prototype.prependListener.apply(this,arguments)},e.prototype.prependOnceListener=function(){this.applyScope(arguments),l.prototype.prependOnceListener.apply(this,arguments)},e.prototype.addListener=function(){this.applyScope(arguments),l.prototype.addListener.apply(this,arguments)},e.prototype.removeListener=function(){for(var e=arguments.length,t=Array(e);e--;)t[e]=arguments[e];!0!==arguments[arguments.length-1]&&this.applyScope(arguments),l.prototype.removeListener.apply(this,arguments)(this).emit.apply(this,["removeListener"].concat(t))},e.prototype.emit=function(){var e,t=arguments;if("array"!==NGN.typeof(arguments[0]))if(NGN.nodelike&&arguments[0]&&0!==this.META.wildcardEvents.size)if(NGN.nodelike&&"symbol"==typeof arguments[0])l.prototype.emit.apply(this,arguments);else{var r=this.META.wildcardEvents.values(),i=null,n=NGN.slice(arguments);for(n.shift();null===i||!i.done;){if(null!==i&&i.value!==t[0])if(new RegExp(i.value.replace(/\./g,"\\.").replace(/\*/g,".*"),"g").test(t[0])){l.prototype.emit.apply(this,[i.value].concat(n,["symbol"!=typeof t[0]?Symbol(t[0]):t[0]]));break}i=r.next()}l.prototype.emit.apply(this,arguments)}else l.prototype.emit.apply(this,arguments);else for(var o=NGN.slice(arguments),s=o.shift(),a=0;a<s.length;a++)(e=this).emit.apply(e,[s[a]].concat(o))},e}(e),o=function(r){function e(e){var t=this;e=e||{},r.call(this,e),Object.defineProperties(this,{name:NGN.const(NGN.coalesce(e.name,"Unknown")),callback:NGN.privateconst(e.callback),number:NGN.const(parseInt(e.number,10)),timer:NGN.private(null),_status:NGN.private(null),bus:NGN.private(e.buz),_skip:NGN.private(!1)}),this.on("timeout",function(){t._status="timedout"}),this.on("skip",function(){t._status="skipped"})}r&&(e.__proto__=r),(e.prototype=Object.create(r&&r.prototype)).constructor=e;var t={status:{configurable:!0},skipped:{configurable:!0}};return t.status.get=function(){return this._status},t.skipped.get=function(){return this._skip},e.prototype.run=function(e){if(this.skipped)return this.emit("skip",this),void(e&&"dev"===e&&NGN.WARN("SKIPPED "+this.name));this.emit("start",this),e&&"dev"===e&&NGN.INFO("Executing "+this.name+":"),this._status="running";var t=this,r={name:this.name,number:this.number,timeout:function(e){t.timer=setTimeout(function(){t.emit("timeout",t)},e)}};this.callback.apply(r,[function(){t._status="complete",t.emit("complete",t)}]),0===this.callback.length&&(t._status="complete",t.emit("complete",t))},e.prototype.skip=function(){"running"===this._status?NGN.WARN("Cannot skip step: "+this.name+" is currently running."):"timedout"===this._status?NGN.WARN("Cannot skip step: "+this.name+" timed out."):"complete"===this._status&&NGN.WARN("Cannot skip step: "+this.name+" already completed."),this._skip=!0},Object.defineProperties(e.prototype,t),e}(i),s=function(r){function e(e){var t=this;void 0===e&&(e="production"),r.call(this),Object.defineProperties(this,{steps:NGN.private([]),completed:NGN.private(0),timeout:NGN.private(null),_mode:NGN.private(e),_cancel:NGN.private(!1),processing:NGN.private(!1),timer:NGN.private(null),sequential:NGN.private(!1)}),this.on("taskcomplete",function(e){t.sequential||"completed"===e.status||(e._status="complete",t.completed++,"dev"===t.mode&&NGN.INFO(e.name+" completed."),t.completed===t.steps.length&&(t.processing=!1,Object.keys(t.steps).forEach(function(e){clearTimeout(t.steps[e].timer)}),t.emit("complete")))}),this.on("aborting",function(){t._cancel=!0})}r&&(e.__proto__=r),(e.prototype=Object.create(r&&r.prototype)).constructor=e;var t={list:{configurable:!0},mode:{configurable:!0},cancelled:{configurable:!0}};return t.list.get=function(){return this.steps.map(function(e){return{id:e.number,name:e.name,status:e.status}})},t.mode.get=function(){return this._mode},t.mode.set=function(e){"dev"===e.toLowerCase().substr(0,3)?this._mode="dev":this._mode="production"},t.cancelled.get=function(){return this._cancel},e.prototype.onTimeout=function(){var t=[];0<this.steps.length&&this.steps.forEach(function(e){t.push(e.name,null===e.status?"NOT STARTED":e.status)}),this.emit("timeout",{process:t}),t=null},e.prototype.add=function(e,t){var r=this;if(this.processing)return NGN.WARN("Cannot add a step while processing.");if("function"==typeof e&&(t=e,e="Step "+(parseInt(this.steps.length)+1)),"function"!=typeof t)throw new Error("No processing method defined for step "+(parseInt(this.steps.length)+1)+".");var i=new NGN.Task({name:e,callback:t,number:(0<this.steps.length?this.steps[this.steps.length-1].number:0)+1});return i.on("complete",function(e){return r.emit("taskcomplete",e)}),i.on("timeout",function(e){"running"!==e.status&&"timedout"!==e.status||r.emit("tasktimeout",e)}),this.steps.push(i),this.emit("taskcreate",i),i},e.prototype.getAt=function(e){return this.steps[e]},e.prototype.get=function(t){var e=this.steps.filter(function(e){return e.name===t});return 1===e.length?e[0]:1===(e=this.steps.filter(function(e){return e.number===t})).length?e[0]:void 0},e.prototype.remove=function(t){if(this.processing)return NGN.WARN("Cannot add a step while processing.");var e=this.steps.filter(function(e){return e.name===t});return 1===e.length?(this.steps=this.steps.filter(function(e){return e.name!==t}),this.emit("taskremove",e[0]),e[0]):1===(e=this.steps.filter(function(e){return e.number===t})).length?(this.steps=this.steps.filter(function(e){return e.number!==t}),this.emit("taskremove",e[0]),e[0]):void 0},e.prototype.removeAt=function(e){return this.processing?NGN.WARN("Cannot add a step while processing."):"number"!=typeof e?console.error("Failed to remove step: "+e):e<0||e>=this.steps.length?console.error("Step index "+e+" could not be found or does not exist."):this.steps.splice(e,1)[0]},e.prototype.reset=function(){if(this.processing)return NGN.WARN("Cannot reset a running queue. Abort or wait for the process to complete before resetting.");this.steps.forEach(function(e){e._skip=!1})},e.prototype.process=function(e){var t=this;if(void 0===e&&(e=!1),this.processing)return NGN.WARN("Cannot start processing (already running). Please wait for this process to complete before calling process() again.");if(0===this.steps.length)return this.emit("complete");if(this.processing=!0,this._cancel=!1,null!==this.timeout&&(this.timer=setTimeout(function(){return t.onTimeout()},this.timeout)),this.sequential="boolean"==typeof e&&e,this.sequential){var r=this.steps,i=new NGN.EventEmitter;i.on("taskcomplete",function(){if(0<r.length){var e=r.shift();if(e.skipped)return i.emit("taskcomplete");e.on("complete",function(){return i.emit("taskcomplete")}),e.on("start",function(){return t.emit("taskstart",e)}),e.run(t.mode)}else t.emit("complete")});var n=r.shift();n.on("complete",function(){return i.emit("taskcomplete")}),n.on("start",function(){return t.emit("taskstart",n)}),n.run(this.mode)}else for(var o=0;o<this.steps.length;o++)t.steps[o].run(t.mode)},e.prototype.run=function(){var e;(e=this).process.apply(e,arguments)},e.prototype.abort=function(){var e=this;this.emit("aborting"),this.each(function(e){["completed","running","timedout"].indexOf(e.status)<0&&!e.skipped&&e.skip()}),this.once("complete",function(){return e.emit("aborted")})},e.prototype.each=function(e){for(var t=0;t<this.steps.length;t++)e(this.steps[t])},e.prototype.cancel=function(){var e;(e=this).abort.apply(e,arguments)},Object.defineProperties(e.prototype,t),e}(i),a=function(e){void 0===e&&(e=""),Object.defineProperties(this,{tokens:NGN.private([]),rules:NGN.private([]),remove:NGN.private(0),state:NGN.private(0),index:NGN.private(0),statement:NGN.private(e),reject:NGN.private(!1),lastLineIndex:NGN.private(0),currentLength:NGN.private(0),currentMatch:NGN.private(null),row:NGN.private(1),unrecognizedCharacters:NGN.private(!1)}),this.addRule(/^/,function(){return"BOF"}),this.addRule(/$/,function(){return"EOF"}),e&&0<e.length&&(this.input=e)},l={input:{configurable:!0},lines:{configurable:!0},unrecognized:{configurable:!0},currentLine:{configurable:!0},currentColumn:{configurable:!0}};l.input.set=function(e){this.remove=0,this.state=0,this.index=0,this.currentMatch=null,this.tokens=[],this.row=1,this.statement=e},l.input.get=function(){return this.statement},l.lines.get=function(){return this.statement.split("\n").length},l.unrecognized.get=function(){return this.unrecognizedCharacters},l.unrecognized.set=function(e){this.reject=!0,this.unrecognizedCharacters=NGN.forceBoolean(e)},l.currentLine.get=function(){return this.row},l.currentColumn.get=function(){var e=this.index-this.lastLineIndex-this.currentLength;return 0===e?1:e},a.prototype.error=function(e){if(e){var t=this.index-this.lastLineIndex-1;throw new Error(e+" at line "+this.currentLine+", column "+(t<1?1:t)+".")}this.unrecognized=!0},a.prototype.addRule=function(e,t,r){if(void 0===r&&(r=[0]),!e.global){var i="g";e.multiline&&(i+="m"),e.ignoreCase&&(i+="i"),e=new RegExp(e.source,i)}var n;if(n="string"==typeof t?function(){return t}:t,!NGN.isFn(n))throw new Error("INVALID LEXER ATTRIBUTES: "+e.toString()+" rule is missing a valid handler function (action) or token name.");var o=n.toString();if(0<=o.indexOf("this.error(")&&/^\(.*\)\s{0,10}=>\s{0,10}\{/.test(o))throw new Error("Cannot use a non-lexical expression (arrow function) as a lexer rule.");this.rules.push({pattern:e,global:e.global,action:n,start:r})},a.prototype.next=function(){var e=this;if(this.tokens.length)return this.tokens.shift();for(this.reject=!0;this.index<=this.statement.length;){/\n/i.test(e.statement.charAt(e.index))&&(e.row++,e.lastLineIndex=e.index);for(var t=e.scan().splice(e.remove),r=e.index;t.length&&e.reject;){var i=t.shift(),n=i.result,o=i.length;e.index+=o,e.currentLength=o,e.reject=!1,e.remove++;var s=i.action.apply(e,n);if(e.reject)e.index=n.index;else if(void 0!==s)switch(NGN.typeof(s)){case"array":e.tokens=s.slice(1),s=s[0];default:return o&&(e.remove=0),s}}var a=e.statement;if(r<a.length)if(e.reject){e.remove=0;var l=e.unexpected(a.substr(e.index++,e.index+a.length));if(void 0!==l)return"array"===NGN.typeof(l)?(e.tokens=l.slice(1),l[0]):l}else e.index!==r&&(e.remove=0),e.reject=!0;else{if(!t.length)break;e.reject=!0}}},a.prototype.scan=function(){for(var e=[],t=0,r=this.state,i=this.index,n=this.statement,o=0,s=this.rules.length;o<s;o++){var a=this.rules[o],l=a.start,c=l.length;if(!c||0<=l.indexOf(r)||r%2&&1===c&&!l[0]){var u=a.pattern;u.lastIndex=i;var A=u.exec(n);if(A&&A.index===i){var d=e.push({result:A,action:a.action,length:A[0].length});for(a.global&&(t=d);--d>t;){var h=d-1;if(e[d].length>e[h].length){var f=e[d];e[d]=e[h],e[h]=f}}}}}return e},a.prototype.unexpected=function(e){if(this.unrecognizedCharacters){var t=this.index-this.lastLineIndex-1;throw new Error("Unexpected syntax at line "+this.currentLine+", column "+(t<1?1:t)+"\nat "+e+"\n   ^")}},Object.defineProperties(a.prototype,l);var c=function(e){if(void 0===e&&(e=[]),0===e.length)throw new Error("No grammaer rules specified.");Object.defineProperties(this,{statement:NGN.private(null),rules:NGN.privateconst(e),PROTECTED:NGN.privateconst({lexer:new NGN.UTILITY.Lexer,activeText:null,orderedList:new Set})});for(var t=0;t<this.rules.length;t++)this.PROTECTED.lexer.addRule(this.rules[t][0],this.rules[t][1]);return this},u={text:{configurable:!0},orderedTokenList:{configurable:!0}};u.text.get=function(){return this.PROTECTED.activeText},u.orderedTokenList.get=function(){return Array.from(this.PROTECTED.orderedList).map(function(e){return e.detail})},c.prototype.parse=function(e,t){var r=this;if(void 0===t&&(t=!0),!NGN.coalesce(e)||"string"!=typeof e)throw new Error("Cannot parse empty string or non-string.");this.PROTECTED.activeText=e;var i,n={};for(this.PROTECTED.lexer.input=e,this.PROTECTED.orderedList.clear();i=this.PROTECTED.lexer.next();)if(!t||"BOF"!==i&&"EOF"!==i){n[i]=NGN.coalesce(n[i],[]),n[i].push({line:r.PROTECTED.lexer.currentLine,column:r.PROTECTED.lexer.currentColumn,length:r.PROTECTED.lexer.currentLength,index:r.PROTECTED.lexer.index-r.PROTECTED.lexer.currentLength,input:r.PROTECTED.lexer.statement.substr(r.PROTECTED.lexer.index-r.PROTECTED.lexer.currentLength,r.PROTECTED.lexer.currentLength)});var o=n[i].length-1;r.PROTECTED.orderedList.add({index:o,token:i,get detail(){return Object.assign(n[this.token][this.index],{token:this.token})}})}return n},Object.defineProperties(c.prototype,u);var A=function(){};A.isSuperSet=function(e,t){if(t.size>e.size||0===t.size)return!1;for(var r=e.values(),i=r.next();!i.done;){if(!e.has(i.value))return!1;i=r.next()}return!0},A.concat=function(){for(var e=arguments,t=new Set(arguments[0]),r=1;r<arguments.length;r++)for(var i=e[r].values(),n=i.next();!n.done;)t.add(n.value),n=i.next();return t},A.intersection=function(e,t){for(var r=new Set,i=e.size<t.size?e:t,n=e.size<t.size?t:e,o=i.values(),s=o.next();!s.done;)n.has(s.value)&&r.add(s.value),s=o.next();return r},A.difference=function(e,t){for(var r=new Set(e),i=t.values(),n=i.next();!n.done;)r.delete(n.value),n=i.next();return r},A.equal=function(e,t){return 0===NGN.UTILITY.Set.difference(e,t).size},A.equals=function(){var e;NGN.WARN("NGN.UTILITY.Set.equals() should be equal() (no s at the end).")(e=NGN.UTILITY.Set).equal.apply(e,arguments)},A.applyAll=function(){Set.prototype.isSuperSet=function(e){return NGN.UTILITY.Set.isSuperSet(this,e)},Set.prototype.concat=function(){for(var e,t=arguments.length,r=Array(t);t--;)r[t]=arguments[t];return(e=NGN.UTILITY.Set).concat.apply(e,[this].concat(r))},Set.prototype.intersection=function(){for(var e,t=arguments.length,r=Array(t);t--;)r[t]=arguments[t];return(e=NGN.UTILITY.Set).intersection.apply(e,[this].concat(r))},Set.prototype.difference=function(){for(var e,t=arguments.length,r=Array(t);t--;)r[t]=arguments[t];return(e=NGN.UTILITY.Set).difference.apply(e,[this].concat(r))},Set.prototype.equals=function(){for(var e,t=arguments.length,r=Array(t);t--;)r[t]=arguments[t];return(e=NGN.UTILITY.Set).equal.apply(e,[this].concat(r))}};var d=Object.freeze({Lexer:a,Tokenizer:c,Set:A}),h=function(){Object.defineProperties(this,{hostname:NGN.private(null),networkInterfaces:NGN.private([]),UrlPattern:NGN.const(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/),HttpMethods:NGN.const(["OPTIONS","HEAD","GET","POST","PUT","DELETE","TRACE","CONNECT"])}),this.hostname=window.location.host,this.networkInterfaces=["127.0.0.1","localhost",window.location.host],this.networkInterfaces=NGN.dedupe(this.networkInterfaces)};h.prototype.normalizeUrl=function(e){var t=[];if(/^(\.|\/|\\).+/.test(e)){var r=window.location.pathname.split("/");r.pop(),e=window.location.origin+"/"+r.join("/")+"/"+e}var i=/^(.*):\/.*/.exec(e);i||(i=""),(i=0<i.length?i[1]:null)&&(e=e.replace(new RegExp(i+"\\:\\/+","i"),"")),e=e.split("/");for(var n=0;n<e.length;n++)".."===e[n]?t.pop():"."!==e[n]&&0<e[n].trim().length&&t.push(e[n]);t=t.join("/").replace(/:\/{3,50}/gi,"://");var o=/(.*:\/\/.*)[?](.*)/.exec(t),s=null===o?t:o[1],a=null!==o?o[2]:"";if(t=s,0<a.trim().length){var l={};a.split("&").forEach(function(e){var t=e.split("=");l[t[0]]=1<t.length?t[1]:null}),a=[],Object.keys(l).forEach(function(e,t){a.push(e+(null!==l[e]?"="+encodeURIComponent(l[e]):""))}),t=t+"?"+a.join("&")}return i?i+"://"+t:t},h.prototype.parseUri=function(e){var t,r=e.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/);t=window.location.protocol.replace(":","").toLowerCase();var i={uri:e,protocol:NGN.coalesce(r[2],t),hostname:NGN.coalesce(r[4],p),path:NGN.coalesceb(r[5],"/"),query:NGN.coalesceb(r[7]),hash:NGN.coalesceb(r[9])};if(0<i.hostname.indexOf("@")){var n=e.match(/^.*\/{1,2}(.*):(.*)@/i);i.hostname=i.hostname.split("@").pop(),this.user=n[1],this.secret=n[2]}return i.port=NGN.coalesce(i.hostname.match(/:([0-9]{1,6})/),"https"===i.protocol?443:80),0<i.hostname.indexOf(":")&&(i.hostname=i.hostname.split(":")[0]),"/"!==i.path.charAt(0)&&(i.path="/"+i.path),i},h.prototype.isCrossOrigin=function(e,t){void 0===t&&(t=null);var r=this.parseUri(e);return null!==t?(t=this.parseUri(t),r.hostname!==t.hostname):r.hostname!==this.hostname};var f=new h,p=f.hostname,T=f.normalizeUrl,N=function(e){var s=this;e=e||{},NGN.objectRequires(e,"url"),NGN.objectHasAny(e,"form","json")&&NGN.WARN("NET.Request",'"form" and "json" configuration properties are not valid. Use "body" instead.'),Object.defineProperties(this,{uri:NGN.private(null),httpmethod:NGN.private(null),enforceMethodSafety:NGN.private(NGN.coalesce(e.enforceMethodSafety,e.enforcemethodsafety,!0)),headers:NGN.public(NGN.coalesceb(e.headers)),requestbody:NGN.public(NGN.coalesce(e.body)),responseType:NGN.public(NGN.coalesce(e.responseType,"")),user:NGN.private(NGN.coalesceb(e.username)),secret:NGN.private(NGN.coalesceb(e.password)),bearerAccessToken:NGN.private(NGN.coalesceb(e.accessToken)),withCredentials:NGN.private(NGN.coalesce(e.withCredentials,!1)),timeout:NGN.public(NGN.coalesce(e.timeout,3e4)),timer:NGN.private(null),isCrossOrigin:NGN.privateconst(function(e){return f.isCrossOrigin(e)}),applyAuthorizationHeader:NGN.privateconst(function(){null!==NGN.coalesceb(s.bearerAccessToken)?s.setHeader("Authorization","Bearer "+s.bearerAccessToken,!0):NGN.coalesceb(s.user)&&NGN.coalesceb(s.secret)&&s.setHeader("Authorization",s.basicAuthToken(s.user,s.secret),!0)}),basicAuthToken:NGN.privateconst(function(e,t){return"Basic "+NGN.global.btoa(e+":"+t)}),parseUri:NGN.privateconst(f.parseUri),uriParts:NGN.private(null),maximumRedirects:NGN.private(10),redirectAttempts:NGN.private(0),prepareBody:NGN.private(function(){if(null!==s.requestbody){null===s.headers&&(s.headers={});var e=NGN.coalesceb(s.headers["Content-Type"],s.headers["content-type"],s.headers["Content-type"]);if("object"==typeof s.requestbody)if(NGN.objectHasExactly(s.requestbody,"form")){for(var t=s.requestbody.form,r=Object.keys(t),i=[],n=0;n<r.length;n++){if(NGN.isFn(t[r[n]]))throw new Error("Invalid form data. Form data cannot be a complex data format such as an object or function.");"object"==typeof t[r[n]]?i.push(r[n]+"="+encodeURIComponent(JSON.stringify(t[r[n]]))):i.push(r[n]+":"+encodeURIComponent(t[r[n]]))}s.requestbody=i.join("&")}else s.requestbody=JSON.stringify(s.requestbody).trim(),s.setHeader("Content-Length",s.requestbody.length,!1),s.setHeader("Content-Type",NGN.coalesceb(e,"application/json"),!1),s.responseType="json";if("string"==typeof s.requestbody){if(null!==e){var o=/([^=]+)=([^&]+)/.exec(s.requestbody);null!==o&&"data:"!==s.requestbody.trim().substr(0,5).toLowerCase()&&"<"!==s.requestbody.trim().substr(0,1).toLowerCase()?s.setHeader("Content-Type","application/x-www-form-urlencoded",!1):(s.setHeader("Content-Type","text/plain"),"data:"===s.requestbody.trim().substr(0,5).toLowerCase()?null!==(o=/^data:(.*);/gi.exec(s.requestbody.trim()))&&s.setHeader("Content-Type",o[1]):/^<\?xml.*/gi.test(s.requestbody.trim())?s.setHeader("Content-Type","application/xml"):/^<html.*/gi.test(s.requestbody.trim())&&s.setHeader("Content-Type","text/html"))}s.setHeader("Content-Type",s.requestbody.length,!1)}else NGN.WARN("NET.Request.body","The request body must cannot be "+typeof s.requestbody+". Please provide a string, object, or binary value for the body.")}})}),e.maxRedirects&&(this.maxRedirects=e.maxRedirects),this.url=e.url,this.method=NGN.coalesceb(e.method,"GET"),this.prepareBody(),null!==NGN.coalesce(this.user,this.secret,this.bearerAccessToken)&&this.applyAuthorizationHeader()},E={maxRedirects:{configurable:!0},protocol:{configurable:!0},host:{configurable:!0},hostname:{configurable:!0},port:{configurable:!0},path:{configurable:!0},query:{configurable:!0},queryParameters:{configurable:!0},hash:{configurable:!0},url:{configurable:!0},method:{configurable:!0},body:{configurable:!0},crossOriginRequest:{configurable:!0},username:{configurable:!0},password:{configurable:!0},accessToken:{configurable:!0}};E.maxRedirects.get=function(){return this.maximumRedirects},E.maxRedirects.set=function(e){25<e&&(e=25),e<0&&(e=0),this.maximumRedirects=e},E.protocol.get=function(){return NGN.coalesce(this.uriParts.protocol,"http")},E.host.get=function(){return NGN.coalesce(this.uriParts.hostname)},E.hostname.get=function(){return this.host},E.port.get=function(){return this.uriParts.port},E.path.get=function(){return NGN.coalesce(this.uriParts.path,"/")},E.query.get=function(){return NGN.coalesce(this.uriParts.query,"")},E.queryParameters.get=function(){for(var i=this,n=this.query.split("&"),o={},e=function(e){var t=n[e].split("="),r="__qp__"+t[0]+"__qp__";Object.defineProperty(o,r,{enumerable:!1,configurable:!1,writable:!0,value:NGN.coalesceb(t[1])}),Object.defineProperty(o,t[0],{enumerable:!0,configurable:!1,get:function(){return o[r]},set:function(e){o[r]=e,i.setQueryParameter(t[0],e,!0)}})},t=0;t<n.length;t++)e(t);return o},E.hash.get=function(){return NGN.coalesce(this.uriParts.hash,"")},E.url.get=function(){return this.uri},E.url.set=function(e){if(null===NGN.coalesceb(e)&&NGN.WARN("NET.Request.url","A blank URL was identified for a request."),null===/^.*:\/{2}/i.exec(e)&&null!==/^\.{1,2}\/.*/.exec(e)&&NGN.global.hasOwnProperty("location")){var t=NGN.global.location,r=""+t.host+t.pathname;0<=(r=r.split("/"))[r.length-1].indexOf(".")&&r.pop(),r=(r=r.join("/")).substring(0,r.lastIndexOf("/")+1),e=(NGN.global.location.protocol+"//"+r+"/"+e).replace(/\/{2,1000000}/i,"/")}this.uri=f.normalizeUrl(e.trim()),this.uriParts=this.parseUri(this.uri)},E.method.get=function(){return this.httpmethod},E.method.set=function(e){this.httpmethod!==e&&(null===NGN.coalesceb(e)&&NGN.WARN("NET.Request.method","No HTTP method specified."),e=e.trim().toUpperCase(),f.HttpMethods.indexOf(e)<0&&NGN.WARN("NET.Request.method","A non-standard HTTP method was recognized in a request: "+e+"."),this.httpmethod=e)},E.body.get=function(){return this.requestbody},E.body.set=function(e){this.requestbody=e,this.prepareBody()},E.crossOriginRequest.get=function(){return this.isCrossOrigin(this.uri)},E.username.get=function(){return NGN.coalesce(this.user)},E.username.set=function(e){e=NGN.coalesceb(e),this.user!==e&&(this.user=e,null!==NGN.coalesceb(this.secret)&&this.applyAuthorizationHeader())},E.password.set=function(e){e=NGN.coalesceb(e),this.secret!==e&&(this.secret=e,null!==NGN.coalesceb(this.user)&&this.applyAuthorizationHeader())},E.accessToken.set=function(e){e=NGN.coalesceb(e),this.bearerAccessToken!==e&&(this.bearerAccessToken=e,this.applyAuthorizationHeader())},N.prototype.setHeader=function(e,t,r){void 0===r&&(r=!0),e=e.replace(/'|"/gi,"").toLowerCase(),(null===this.headers||void 0===this.headers[e]||r)&&(null===this.headers&&(this.headers={}),this.headers[e]=t)},N.prototype.getHeader=function(e){if(null!==this.headers&&this.headers.hasOwnProperty(e.toLowerCase()))return this.headers[e.toLowerCase()]},N.prototype.removeHeader=function(e){null!==this.headers&&(delete this.headers[e.toLowerCase()],delete this.headers[e])},N.prototype.setQueryParameter=function(e,t,r){void 0===r&&(r=!0);var i,n=new RegExp("^.*(\\?|&)("+e+".*)(&.*)$|^.*(\\?|&)("+e+".*)$","i");if(null!==n.exec(this.uri)){if(!r)return;null!==(i=n.exec(this.uri))&&(this.url=this.uri.replace(""+NGN.coalesceb(i[5],i[2]),e+(null!==t?"="+encodeURIComponent(t):"")))}else this.url=this.uri+(0===this.query.length?"?":"&")+e+(null!==t?"="+encodeURIComponent(t):"")},N.prototype.removeQueryParameter=function(e){this.url=this.uri.replace(new RegExp(e+"=(.[^&]+)|\\?"+e+"|&"+e,"gi"),"")},N.prototype.startMonitor=function(){var e=this;null===this.timer&&(this.timer=setTimeout(function(){throw new Error("Timed out retrieving "+e.url)},this.timeout))},N.prototype.stopMonitor=function(){clearTimeout(this.timer),this.timer=null},N.prototype.send=function(t){var e=this.body;NGN.coalesce(e)&&this.enforceMethodSafety&&0<="OPTIONS|HEAD|GET".indexOf(this.method)&&(e=null);var r=new XMLHttpRequest,i=!1,n=this;if(r.onreadystatechange=function(){i||r.readyState===XMLHttpRequest.DONE&&(i=!0,0===r.status&&NGN.WARN("Request Error: "+n.method+" "+n.url+" (likely a CORS issue)."),NGN.isFn(t)&&t(r))},r.onerror=function(e){NGN.WARN("NET.error",e),!i&&NGN.isFn(t)&&t(r),i=!0},r.ontimeout=function(e){i=!0,t(r)},r.timeout=this.timeout,r.open(this.method,this.url,!0),r.withCredentials=this.withCredentials,null!==this.headers)for(var o=Object.keys(this.headers),s=0;s<o.length;s++)r.setRequestHeader(o[s],this.headers[o[s]]);r.send(e)},Object.defineProperties(N.prototype,E);var m=function(){var e=this;Object.defineProperties(this,{normalizeUrl:NGN.privateconst(T),parseRequestConfiguration:NGN.private(function(e,t){return void 0===t&&(t="GET"),"string"==typeof e&&(e={url:e}),(e=e||{}).method=t,e.url=NGN.coalesceb(e.url,p),new NGN.NET.Request(e)}),makeRequest:NGN.private(function(i){var n=e;return function(){var e,t=NGN.slice(arguments);NGN.isFn(t[t.length-1])&&(e=t.pop()),t.push(i);var r=n.parseRequestConfiguration.apply(n,t);n.send(r,e)}}),OPTIONS:NGN.privateconst(this.options.bind(this)),HEAD:NGN.privateconst(this.head.bind(this)),GET:NGN.privateconst(this.get.bind(this)),POST:NGN.privateconst(this.post.bind(this)),PUT:NGN.privateconst(this.put.bind(this)),DELETE:NGN.privateconst(this.delete.bind(this)),TRACE:NGN.privateconst(this.trace.bind(this)),JSON:NGN.privateconst(this.json.bind(this)),JSONP:NGN.privateconst(this.jsonp.bind(this))})},D={Request:{configurable:!0}};D.Request.get=function(){return N},m.prototype.request=function(e,t){(e=e||{}).method=NGN.coalesceb(e.method,"GET"),NGN.isFn(this[e.method])?this.makeRequest(e.method).apply(void 0,arguments):this.send(new NGN.NET.Request(e),t)},m.prototype.options=function(){this.makeRequest("OPTIONS").apply(this,arguments)},m.prototype.head=function(){this.makeRequest("HEAD").apply(this,arguments)},m.prototype.get=function(){this.makeRequest("GET").apply(this,arguments)},m.prototype.post=function(){this.makeRequest("POST").apply(this,arguments)},m.prototype.put=function(){this.makeRequest("PUT").apply(this,arguments)},m.prototype.delete=function(){this.makeRequest("DELETE").apply(this,arguments)},m.prototype.trace=function(){NGN.WARN("NGN.NET.Request.method","An HTTP TRACE request was made."),this.makeRequest("TRACE").apply(this,arguments)},m.prototype.json=function(e,r){if(!NGN.isFn(r))throw new Error("NGN.NET.json requires a callback method.");var t=this.parseRequestConfiguration({url:e});this.preflight(t),t.send(function(t){try{var e=JSON.parse(t.responseText);r(null,e)}catch(e){e.response=NGN.coalesce(t.responseText),r(e,null)}})},m.prototype.jsonp=function(e,t){var r="jsonp_callback_"+Math.round(1e5*Math.random());window[r]=function(e){return delete window[r],document.body.removeChild(i),t(null,e)};var i=document.createElement("script");i.src=e+(0<=e.indexOf("?")?"&":"?")+"callback="+r,i.addEventListener("error",function(e){return delete window[r],t(new Error("The JSONP request was blocked. This may be the result of an invalid URL, cross origin restrictions, or the remote server may not be online."))}),document.body.appendChild(i)},m.prototype.send=function(e,t){this.preflight(e),e.send(t)},m.prototype.preflight=function(e){},Object.defineProperties(m.prototype,D);var v=function(t){function e(e){t.call(this),e=e||{},Object.defineProperties(this,{globalHeaders:NGN.private(NGN.coalesceb(e.headers,{})),globalCredentials:NGN.private(NGN.coalesceb(e.credentials,{})),user:NGN.private(NGN.coalesceb(e.username)),secret:NGN.private(NGN.coalesceb(e.password)),accesstoken:NGN.private(NGN.coalesceb(e.token,e.accessToken)),globalQuery:NGN.private(NGN.coalesceb(e.query,{})),baseUrl:NGN.private(NGN.coalesce(e.baseUrl,e.baseurl,"http://"+p+"/")),nocache:NGN.private(NGN.coalesce(e.nocache,!1)),sslonly:NGN.public(NGN.coalesce(e.sslonly,!1))}),this.baseUrl.indexOf("://")<0||10<this.baseUrl.indexOf("://")?this.baseUrl="http"+(this.sslonly?"s":"")+"://"+this.baseUrl:this.sslonly&&(this.baseUrl=this.baseUrl.replace("http://","https://")),null!==this.accesstoken?this.credentials={accessToken:this.accesstoken}:null!==this.user&&null!==this.ssecret&&(this.credentials={username:this.user,password:this.secret})}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={username:{configurable:!0},password:{configurable:!0},headers:{configurable:!0},credentials:{configurable:!0},query:{configurable:!0}};return r.username.get=function(){return this.user},r.username.set=function(e){this.user!==e&&(this.user=e,null!==this.secret&&(this.credentials={username:this.user,password:this.secret}))},r.password.set=function(e){this.secret!==e&&(this.secret=e,null!==this.user&&(this.credentials={username:this.user,password:this.secret}))},r.headers.get=function(){return this.globalHeaders},r.headers.set=function(e){this.globalHeaders=e},r.credentials.set=function(e){if(e.hasOwnProperty("accesstoken")||e.hasOwnProperty("accessToken")||e.hasOwnProperty("token"))e.accessToken=NGN.coalesce(e.accessToken,e.accesstoken,e.token),e.hasOwnProperty("username")&&delete e.username,e.hasOwnProperty("password")&&delete e.password;else if(!(e.hasOwnProperty("username")&&e.hasOwnProperty("password")||e.hasOwnProperty("accessToken")))throw new Error("Invalid credentials. Must contain an access token OR the combination of a username AND password.");(this.globalCredentials=e).username&&(this.username=e.username),e.password&&(this.password=e.password)},r.credentials.get=function(){return NGN.WARN("Credentials are write-only. An attempt to read credentials was denied."),{username:null,secret:null,password:null,accessToken:null}},r.query.get=function(){return this.globalQuery},r.query.set=function(e){this.globalQuery=e},e.prototype.prepareUrl=function(e){return e.indexOf("://")<0&&(e=T(this.baseUrl+"/"+e)),e.replace(/\/{2,5}/gi,"/").replace(/:\/{1}/i,"://")},e.prototype.preflight=function(e){e.url=this.prepareUrl(e.url);var t=Object.keys(this.globalQuery);if(0<t.length){for(var r=[],i=0;i<t.length;i++)r.push(t[i]+"="+encodeURIComponent(this.globalQuery[t[i]]));""===e.query?e.url=e.url+"?"+r.join("&"):e.url=e.url+"&"+r.join("&")}for(var n=Object.keys(this.globalHeaders),o=0;o<n.length;o++)e.setHeader(n[o],this.globalHeaders[n[o]]);this.globalCredentials.accessToken?e.accessToken=this.globalCredentials.accessToken:this.globalCredentials.username&&(e.username=this.globalCredentials.username,e.password=this.globalCredentials.password),this.nocache&&e.setQueryParameter("nocache"+(new Date).getTime().toString()+Math.random().toString().replace(".",""),null)},Object.defineProperties(e.prototype,r),e}(m);m.prototype.Resource=v,(m.prototype.Plugin=m).prototype.Utility=f;var g=new m,y=null,R=function(){};R.checksum=function(e){"object"==typeof e&&(e=JSON.stringify(this.serialize(e))),y||(y=function(){for(var e,t=[],r=0;r<256;r++){e=r;for(var i=0;i<8;i++)e=1&e?3988292384^e>>>1:e>>>1;t[r]=e}return t}());for(var t=-1,r=0;r<e.length;r++)t=t>>>8^y[255&(t^e.charCodeAt(r))];return(-1^t)>>>0},R.UUID=function(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(e){return(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)})},R.GUID=function(){for(var e=[],t=0;t<256;t++)e[t]=(t<16?"0":"")+t.toString(16);var r=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0,o=4294967295*Math.random()|0;return e[255&r]+e[r>>8&255]+e[r>>16&255]+e[r>>24&255]+"-"+e[255&i]+e[i>>8&255]+"-"+e[i>>16&15|64]+e[i>>24&255]+"-"+e[63&n|128]+e[n>>8&255]+"-"+e[n>>16&255]+e[n>>24&255]+e[255&o]+e[o>>8&255]+e[o>>16&255]+e[o>>24&255]},R.serialize=function(e){var r=this;if("object"!=typeof e)throw new Error("Cannot serialize "+NGN.typeof(e)+" value. Must be an object.");var t=Symbol("array.data");"array"===NGN.typeof(e)&&((e={})[t]=e);for(var i={},n=Object.keys(e),o=0;o<n.length;o++)if(void 0!==e[n[o]])switch(NGN.typeof(e[n[o]])){case"object":Object.defineProperty(i,n[o],NGN.public(NGN.DATA.UTIL.serialize(e[n[o]])));break;case"array":i[n[o]]=[];for(var s=0;s<e[n[o]].length;s++)i[n[o]].push(NGN.DATA.UTIL.serialize(e[n[o]]));break;case"date":Object.defineProperty(i,n[o],NGN.public(e[n[o]].toISOString()));break;case"symbol":t!==n[o]&&(i[n[o]]=e[n[o]].toString());break;case"regexp":Object.defineProperty(i,n[o],NGN.public(e[n[o]].toString()));break;case"weakmap":case"map":var a={};e[n[o]].forEach(function(e,t){a[t.toString()]=r.serialize(e)}),i[n[o]]=a;break;case"weakset":case"set":if(0===e[n[o]].size){i[n[o]]=[];break}i[n[o]]=r.serialize(Array.from(e[n[o]].values()));break;case"function":break;default:i[n[o]]=e[n[o]]}return void 0!==i[t]?i[t]:i},R.isDataModel=function(e){if(e instanceof NGN.DATA.Model||"model"===NGN.typeof(e))return!0;if(e.hasOwnProperty("prototype")&&null!==e.prototype)for(var t=e,r=0;null!==t.prototype&&r<30;)if(r++,(t=t.prototype)instanceof NGN.DATA.Model||"model"===NGN.typeof(t))return!0;return e instanceof NGN.DATA.Entity};var M=function(e,t,r){var i=this;void 0===e&&(e=null),void 0===t&&(t=[]),void 0===r&&(r=[null]),Object.defineProperties(this,{parent:NGN.private(e),leafs:NGN.private(t),nodes:NGN.private(r),METADATA:NGN.private({order:null,minOrder:null,compare:function(e,t){return e<t?-1:t<e?1:0}})});for(var n=0;n<this.leafs.length;n++)i.leafs[n].parent=i;for(var o=0;o<this.nodes.length;o++)null!==i.nodes[o]&&(i.nodes[o].parent=i)};M.prototype.search=function(e){var t=this;if(0<this.leafs.length){var r,i=this.leafs[0];if(0===this.METADATA.compare(i.key,e))return{leaf:i,index:0};if(this.METADATA.compare(e,i.key)<0)return null!==this.nodes[0]?this.nodes[0].search(e):{node:this,index:0};for(r=1;r<this.leafs.length;r++){var n=t.leafs[r];if(0===t.METADATA.compare(n.key,e))return{leaf:n,index:r};if(t.METADATA.compare(e,n.key)<0)return null!==t.nodes[r]?t.nodes[r].search(e):{node:t,index:r};i=n}return null!==this.nodes[r]?this.nodes[r].search(e):{node:this,index:r}}return{node:this,index:0}},M.prototype.get=function(e){var t=this.search(e);return t.leaf?t.leaf.value:void 0},M.prototype.put=function(e,t,r){void 0===r&&(r=!0);var i=this.search(e);if(i.leaf){if(!r)return;i.leaf.value=t}else{var n=i.node,o=i.index;n.leafs.splice(o,0,new b(n,e,t)),n.nodes.splice(o+1,0,null),n.leafs.length>this.METADATA.order&&n.split()}},M.prototype.delete=function(e){var t=this.search(e);if(t.leaf){var r=t.leaf.parent,i=t.index,n=r.nodes[i];if(null===n)r.leafs.splice(i,1),r.nodes.splice(i,1),r.balance();else{var o=n.leafs[n.leafs.length-1];n.delete(o.key),(o.parent=r).leafs.splice(i,1,o)}return!0}},M.prototype.balance=function(){if(this.parent instanceof G)0===this.leafs.length&&null!==this.nodes[0]&&(this.parent.root=this.nodes[0],this.parent.root.parent=this.parent);else if(!(this.leafs.length>=this.METADATA.minOrder)){var e,t,r,i=this.parent.nodes.indexOf(this),n=0<i?this.parent.nodes[i-1]:null,o=this.parent.nodes.length>i+1?this.parent.nodes[i+1]:null;if(null!==o&&o.leafs.length>this.METADATA.minOrder)((e=this.parent.leafs[i]).parent=this).leafs.push(e),(t=o.leafs.shift()).parent=this.parent,this.parent.leafs[i]=t,null!==(r=o.nodes.shift())&&(r.parent=this),this.nodes.push(r);else if(null!==n&&n.leafs.length>this.METADATA.minOrder)((e=this.parent.leafs[i-1]).parent=this).leafs.unshift(e),(t=n.leafs.pop()).parent=this.parent,this.parent.leafs[i-1]=t,null!==(r=n.nodes.pop())&&(r.parent=this),this.nodes.unshift(r);else{var s;if(null!==o)e=this.parent.leafs[i],(s=new M(this.parent,this.leafs.concat([e],o.leafs),this.nodes.concat(o.nodes))).METADATA.order=this.METADATA.order,s.METADATA.minOrder=this.METADATA.minOrder,this.parent.leafs.splice(i,1),this.parent.nodes.splice(i,2,s);else{if(null===n)throw new Error("Internal error: "+this.toString(!0)+" has neither a left nor a right sibling");e=this.parent.leafs[i-1],(s=new M(this.parent,n.leafs.concat([e],this.leafs),n.nodes.concat(this.nodes))).METADATA.minOrder=this.METADATA.minOrder,s.METADATA.order=this.METADATA.order,this.parent.leafs.splice(i-1,1),this.parent.nodes.splice(i-1,2,s)}this.parent.balance()}}},M.prototype.split=function(){var e=Math.floor(this.leafs.length/2);if(this.parent instanceof G)this.nodes=[new M(this,this.leafs.slice(0,e),this.nodes.slice(0,e+1)),new M(this,this.leafs.slice(e+1),this.nodes.slice(e+1))],this.leafs=[this.leafs[e]];else{var t=this.leafs[e],r=new M(this.parent,this.leafs.slice(e+1),this.nodes.slice(e+1));this.leafs=this.leafs.slice(0,e),this.nodes=this.nodes.slice(0,e+1),this.parent.unsplit(t,r)}},M.prototype.unsplit=function(e,t){e.parent=this;var r=(t.parent=this).leafs[0];if(this.METADATA.compare(e.key,r.key)<0)this.leafs.unshift(e),this.nodes.splice(1,0,t);else{var i;for(i=1;i<this.leafs.length;i++){var n=this.leafs[i];if(this.METADATA.compare(e.key,n.key)<0){this.leafs.splice(i,0,e),this.nodes.splice(i+1,0,t);break}}i===this.leafs.length&&(this.leafs.push(e),this.nodes.push(t))}this.leafs.length>this.METADATA.order&&this.split()},M.prototype.toString=function(e){void 0===e&&(e=!1);var t,r=[];for(t=0;t<this.leafs.length;t++)r.push(this.leafs[t].key);var i="["+r.toString()+"]"+(this.parent instanceof G?":*":":")+this.parent;if(e)for(t=0;t<this.nodes.length;t++)i+=" -> "+this.nodes[t];return i};var b=function(e,t,r){Object.defineProperties(this,{parent:NGN.private(e),key:NGN.private(t),value:NGN.private(r)})};b.prototype.toString=function(){return this.key.toString()};var G=function(t){function s(e){void 0===e&&(e=52),t.call(this),e=e<1?1:e,Object.defineProperties(this,{root:NGN.private(new M(this)),BTREE:NGN.private({}),METADATA:NGN.private({order:e,minOrder:1<e?Math.floor(e/2):1,compare:function(e,t){return e<t?-1:t<e?1:0}})}),this.root.METADATA.minOrder=this.METADATA.minOrder,this.root.METADATA.order=this.METADATA.order}t&&(s.__proto__=t);var e={length:{configurable:!0}};return((s.prototype=Object.create(t&&t.prototype)).constructor=s).prototype.validate=function(e){if(!(e instanceof s)){var t;for(e.leafs.length+1!==e.nodes.length&&NGN.ERROR("Illegal leaf/node count in "+e+": "+e.leafs.length+"/"+e.nodes.length),t=0;t<e.leafs.length;t++)e.leafs[t]||NGN.ERROR("Illegal leaf in "+e+" at "+t+": "+e.leafs[t]);for(t=0;t<e.nodes.length;t++)"undefined"===NGN.typeof(e.nodes[t])&&NGN.ERROR("Illegal node in "+e+" at "+t+": undefined")}},s.prototype.put=function(e,t,r){if(void 0===r&&(r=!0),"number"!==NGN.typeof(e))throw new Error("Illegal key: "+e);if(void 0===t)throw new Error("Illegal value: "+t);return this.root.put(e,t,r)},s.prototype.get=function(e){if("number"!==NGN.typeof(e))throw new Error("Illegal key: "+e);return this.root.get(e)},s.prototype.delete=function(e){if("number"!==NGN.typeof(e))throw new Error("Illegal key: "+e);return this.root.delete(e)},s.prototype.walk=function(e,t,r){if(0!==this.root.leafs.length){var i,n;if(NGN.isFn(e)?(r=e,e=t=null):NGN.isFn(t)&&(r=t,t=null),e=NGN.coalesce(e),t=NGN.coalesce(t),null===e){for(i=this.root;null!==i.nodes[0];)i=i.nodes[0];n=0}else{var o=this.root.search(e);if(o.leaf)n=(i=o.leaf.parent).leafs.indexOf(o.leaf);else if(i=o.node,(n=o.index)>=i.leafs.length){if(i.parent instanceof s||i.parent.nodes.indexOf(i)>=i.parent.leafs.length)return;i=i.parent}}for(;!(null!==t&&0<this.METADATA.compare(i.leafs[n].key,t)||0===i.leafs.length||r(i.leafs[n].key,i.leafs[n].value));)if(null!==i.nodes[n+1])for(i=i.nodes[n+1],n=0;null!==i.nodes[0];)i=i.nodes[0];else if(i.leafs.length>n+1)n++;else do{if(i.parent instanceof s)return;n=i.parent.nodes.indexOf(i),i=i.parent}while(n>=i.leafs.length)}},s.prototype.walkDesc=function(e,t,r){var i,n;if(NGN.isFn(e)?(r=e,e=t=null):NGN.isFn(t)&&(r=t,t=null),e=NGN.coalesce(e),null===(t=NGN.coalesce(t))){for(i=this.root;null!==i.nodes[i.nodes.length-1];)i=i.nodes[i.nodes.length-1];n=i.leafs.length-1}else{var o=this.root.search(t);if(o.leaf)n=(i=o.leaf.parent).leafs.indexOf(o.leaf);else for(i=o.node,n=o.index-1;n<0;){if(i.parent instanceof s)return;if((n=i.parent.nodes.indexOf(i)-1)<0)return;i=i.parent}}for(;!(null!==e&&this.METADATA.compare(i.leafs[n].key,e)<0||r(i.leafs[n].key,i.leafs[n].value));)if(null!==i.nodes[n]){for(i=i.nodes[n];null!==i.nodes[i.nodes.length-1];)i=i.nodes[i.nodes.length-1];n=i.leafs.length-1}else if(0<n)n--;else do{if(i.parent instanceof s)return;n=i.parent.nodes.indexOf(i)-1,i=i.parent}while(n<0)},s.prototype.count=function(e,t){var r=0;return this.walk(void 0!==e?e:null,void 0!==t?t:null,function(e,t){r++}),r},s.prototype.toString=function(){return"Tree("+this.METADATA.order+") "+this.root.toString()},e.length.get=function(){return this.count()},Object.defineProperties(s.prototype,e),s}(i),I=function(t){function e(e){t.call(this),Object.defineProperties(this,{METADATA:NGN.private({transaction:{},changeOrder:[],cursor:null,max:NGN.coalesce(e,10)})})}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var r={length:{configurable:!0},cursor:{configurable:!0},currentValue:{configurable:!0},cursorIndex:{configurable:!0},log:{configurable:!0}};return r.length.get=function(){return this.METADATA.changeOrder.length},r.cursor.get=function(){return this.METADATA.cursor},r.cursor.set=function(e){if(null!==e&&!this.METADATA.transaction.hasOwnProperty(e))throw new Error("Cannot set cursor for transaction log (does not exist).");this.METADATA.cursor=e},r.currentValue.get=function(){if(null!==this.METADATA.cursor)return this.getCommit(this.METADATA.cursor).value},r.cursorIndex.get=function(){if(null!==this.METADATA.cursor)return this.METADATA.changeOrder.indexOf(this.METADATA.cursor)},e.prototype.commit=function(e){var t="symbol"==typeof e?Symbol(String(e)):Symbol(NGN.coalesce(e,NGN.typeof(e)).toString());if(this.METADATA.transaction[t]=[new Date,e],this.flush(),this.METADATA.changeOrder.push(t),this.METADATA.cursor=t,0<this.METADATA.max&&this.METADATA.changeOrder.length>this.METADATA.max){var r=this.METADATA.changeOrder.shift();delete this.METADATA.transaction[r]}return this.emit("commit",t,null),t},e.prototype.getCommit=function(e){if(void 0===e&&(e=null),this.METADATA.transaction.hasOwnProperty(e))return{timestamp:this.METADATA.transaction[e][0],value:this.METADATA.transaction[e][1]}},e.prototype.flush=function(){if(null!==this.METADATA.cursor){var e=this.METADATA.changeOrder.indexOf(this.METADATA.cursor);if(0!==e){for(var t=this.METADATA.changeOrder.splice(e+1),r=0;r<t.length;r++)delete this.METADATA.transaction[t[r]];this.METADATA.cursor=this.METADATA.changeOrder[this.METADATA.changeOrder.length-1]}}},e.prototype.rollback=function(e){if(void 0===e&&(e=1),0===this.METADATA.changeOrder.length)return null;if("symbol"==typeof e)return this.cursor=e;if(e>=this.METADATA.changeOrder.length)this.METADATA.cursor=this.METADATA.changeOrder[0];else{if("number"==typeof e){if(e<=0)return this.METADATA.cursor;var t=this.METADATA.changeOrder.indexOf(this.METADATA.cursor);(t-=e)<=0&&(t=0),e=this.METADATA.changeOrder[t]}this.METADATA.cursor=e}return this.emit("rollback",this.METADATA.cursor,null),this.METADATA.cursor},e.prototype.advance=function(e){if(void 0===e&&(e=1),0===this.METADATA.changeOrder.length)return null;if("number"==typeof e){if(e<=0)return this.METADATA.cursor;var t=this.METADATA.changeOrder.indexOf(this.METADATA.cursor);(t+=e)>=this.METADATA.changeOrder.length&&(t=this.METADATA.changeOrder.length-1),e=this.METADATA.changeOrder[t]}return this.METADATA.cursor=e,this.emit("advance",this.METADATA.cursor,null),this.METADATA.cursor},e.prototype.reset=function(e){void 0===e&&(e=!1),this.METADATA.transaction={},this.METADATA.changeOrder=[],this.METADATA.cursor=null,e||this.emit("reset")},r.log.get=function(){var t=this;return this.METADATA.changeOrder.map(function(e){return{timestamp:t.METADATA.transaction[e][0],value:t.METADATA.transaction[e][1],activeCursor:t.METADATA.cursor===e}})},Object.defineProperties(e.prototype,r),e}(i),O=function(e,t,r){void 0===t&&(t=null),void 0===r&&(r=null);var i=NGN.typeof(e);Object.defineProperties(this,{RULE:NGN.private({type:i,validator:e,name:NGN.coalesce(t,"Untitled "+i.toUpperCase()+" Validation"),scope:NGN.coalesce(r,this)})})},w={name:{configurable:!0},type:{configurable:!0}};w.name.get=function(){return this.RULE.name},w.type.get=function(){return this.RULE.type},O.prototype.test=function(e){if(NGN.isFn(this.RULE.validator))return this.RULE.validator.apply(this.RULE.scope,[e]);switch(this.type){case"array":return-1!==this.RULE.validator.indexOf(e);case"regexp":return this.RULE.validator.test(e);default:return this.RULE.validator===e}},Object.defineProperties(O.prototype,w);var x=function(i){function e(e,t,r){var s=this;void 0===r&&(r=[]),"array"===NGN.typeof(t)&&(r=t,t=null),i.call(this,null,e,t),this.RULE.prepareRange=function(e){e=NGN.forceArray(e),"array"!==NGN.typeof(e[0])&&(e=[e]);for(var t=0;t<e.length;t++){if(2!==e[t].length){if("string"!==NGN.typeof(e[t][0]))throw new Error('Invalid range: "'+e[t].toString()+'"');e[t]=e[t][0].replace(/[^0-9->]/gi,"").split(/->{1,100}/)}"number"!==NGN.typeof(e[t][0])&&(e[t][0]=NGN.coalesce(e[t][0],"").replace(/null|none|any/gi,"")),"number"!==NGN.typeof(e[t][1])&&(e[t][1]=NGN.coalesce(e[t][1],"").replace(/null|none|any/gi,""))}return e},this.RULE.range=new Set,this.range=r,this.RULE.validator=function(e){for(var t="string"===NGN.typeof(e),r=s.range,i=0;i<r.length;i++){var n=NGN.coalesceb(r[i][0],t?e.length:e),o=NGN.coalesceb(r[i][1],t?e.length:e);if(t&&e.length>=n&&e.length<=o||!t&&n<=e&&e<=o)return!0}return!1}}i&&(e.__proto__=i),(e.prototype=Object.create(i&&i.prototype)).constructor=e;var t={range:{configurable:!0}};return t.range.get=function(){return Array.from(this.RULE.range.values())},t.range.set=function(e){this.RULE.range=new Set,this.addRange(e)},e.prototype.addRange=function(e){e=this.RULE.prepareRange(e);for(var t=0;t<e.length;t++){if(null!==NGN.coalesceb(e[t][0])&&null!==NGN.coalesceb(e[t][1])&&e[t][1]<e[t][0])throw new Error('Invalid value "'+e[t][0].toString()+" -> "+e[t][1].toString()+'". Minimum value cannot exceed maximum.');this.RULE.range.add(e[t])}},e.prototype.removeRange=function(e){var t=this.range;e=this.RULE.prepareRange(e);for(var r=0;r<e.length;r++)for(var i=0;i<t.length;i++)e[r].toString()===t[i].toString()&&this.RULE.range.delete(t[i])},Object.defineProperties(e.prototype,t),e}(O),C=function(n){function e(r){var o=this;if("string"==typeof(r=r||{})&&(r={name:r}),r.hasOwnProperty("pattern")&&"regexp"!==NGN.typeof(r.pattern))throw new Error("Invalid data field configuration. Pattern must be a valid JavaScript regular expression (RegExp).");void 0===r.type&&r.default&&(r.type=NGN.getType(NGN.typeof(r.default),String)),n.call(this,r);var e=Symbol("empty");if(Object.defineProperties(this,{METADATA:NGN.privateconst({required:NGN.coalesce(r.required,!1),hidden:NGN.coalesce(r.hidden,!1),fieldType:NGN.coalesce(r.identifier,!1)?"key":"data",isIdentifier:NGN.coalesce(r.identifier,!1),autocorrectInput:NGN.coalesce(r.autocorrectInput,!1),pattern:NGN.coalesceb(r.pattern),name:NGN.coalesce(r.name),description:NGN.coalesce(r.description,NGN.typeof(r.type)+" field"),sourceName:NGN.coalesce(r.sourceName),default:NGN.coalesce(r.default),lastValue:Symbol("no.value"),dataType:NGN.coalesce(r.type,String),rules:NGN.coalesce(r.rule,r.rules,r.validators,[]),violatedRule:null,allowInvalid:NGN.coalesce(r.allowInvalid,!0),TRANSFORM:NGN.coalesce(r.transformer),RAWDATAPLACEHOLDER:e,RAW:e,ENUMERABLE_VALUES:null,REVERSE_ENUMERABLE_VALUES:null,IS_NEW:!0,EVENTS:new Set(["hidden","unhidden","update","invalid","valid","rule.add","rule.remove"]),AUDITABLE:NGN.coalesce(r.audit,!1),AUDITLOG:NGN.coalesce(r.audit,!1)?new NGN.DATA.TransactionLog(NGN.coalesce(r.auditMaxEntries,10)):null,model:null,setValue:function(e,t,r){if(void 0===t&&(t=!1),void 0===r&&(r=!1),null!==o.METADATA.TRANSFORM&&NGN.isFn(o.METADATA.TRANSFORM)&&(e=o.METADATA.TRANSFORM.call(o,e)),o.METADATA.autocorrectInput&&o.type!==NGN.typeof(e)&&(e=o.autoCorrectValue(e)),e!==o.value){var i={field:o,old:"symbol"==typeof o.METADATA.RAW?void 0:o.METADATA.RAW,new:e},n=o.valid;if(o.METADATA.RAW=e,o.valid)!t&&null!==n&&n&&o.emit("valid",i);else{if(!o.METADATA.allowInvalid)throw o.METADATA.RAW=i.old,new Error('"'+e+'" did not pass the '+o.METADATA.violatedRule+" rule.");i.reason='"'+e+'" did not pass the '+o.METADATA.violatedRule+" rule.",NGN.WARN(i.reason),o.emit("invalid",i)}"symbol"==typeof o.METADATA.lastValue&&(o.METADATA.lastValue=e),r||o.virtual||!o.METADATA.AUDITABLE||(i.cursor=o.METADATA.AUDITLOG.commit(o.METADATA.RAW)),t||o.emit("update",i),i=n=null}},commitPayload:function(e){o.METADATA.model&&(e.action="update",e.join=!0,o.increaseMaxListeners(3),o.METADATA.model.emit(["update",e.field+".update","update."+e.field],e),e=null)}})}),"array"!==NGN.typeof(this.METADATA.rules)&&(this.METADATA.rules=NGN.forceArray(this.METADATA.rules)),0<this.METADATA.rules.length)for(var t=0;t<this.METADATA.rules.length;t++)!NGN.isFn(o.METADATA.rules[t])||o.METADATA.rules[t]instanceof NGN.DATA.Rule||(o.METADATA.rules[t]=new NGN.DATA.Rule(o.METADATA.rules[t],"Custom Rule #"+(t+1)));if(this.METADATA.dataType===String&&(null!==this.METADATA.pattern&&this.METADATA.rules.unshift(new NGN.DATA.Rule(r.pattern,"Pattern Match ("+r.pattern.toString()+")")),r.nonempty&&this.METADATA.rules.unshift(new NGN.DATA.Rule(function(e){return 0<e.trim().length},"No Blanks ("+r.pattern.toString()+")"))),this.METADATA.dataType!==Number&&this.METADATA.dataType!==Date&&this.METADATA.dataType!==String||(NGN.objectHasAny(r,"min","minimum","max","maximum")&&(r.range=NGN.forceArray(NGN.coalesce(r.range)),r.range.push([NGN.coalesce(r.min,r.minimum),NGN.coalesce(r.max,r.maximum)])),r.hasOwnProperty("range")&&this.METADATA.rules.unshift(new NGN.DATA.RangeRule("Numeric Range",r.range)),this.METADATA.dataType===Number&&(NGN.coalesce(r.pattern)&&this.METADATA.rules.unshift(new NGN.DATA.Rule(function(e){return r.pattern.test(e.toString())},"Numeric Pattern ("+r.pattern.toString().substr(0,15)+(15<r.pattern.toString().length?"...":"")+")")),"number"===NGN.typeof(r.multipleOf)&&this.METADATA.rules.unshift(new NGN.DATA.Rule(function(e){return 0===Math.abs(e%r.multipleOf)},"Numeric Multiple of "+r.multipleOf)))),this.METADATA.dataType===Array&&(NGN.objectHasAny(r,"min","minimum")&&this.METADATA.rules.push(new NGN.DATA.Rule(function(e){return e.length>=NGN.coalesce(r.min,r.minimum)},NGN.coalesce(r.min,r.minimum)+" count minimum")),NGN.objectHasAny(r,"max","maximum")&&this.METADATA.rules.push(new NGN.DATA.Rule(function(e){return e.length<=NGN.coalesce(r.max,r.maximum)},NGN.coalesce(r.max,r.maximum)+" count maximum")),NGN.coalesce(r.unique,!1)&&this.METADATA.rules.push(new NGN.DATA.Rule(function(e){return NGN.dedupe(e).length===e.length},"Unique value constraint")),r.hasOwnProperty("listType")&&this.METADATA.rules.push(new NGN.DATA.Rule(function(e){for(var t=0;t<e.length;t++)if(NGN.typeof(e[t])!==NGN.typeof(r.listType))return!1;return!0},NGN.typeof(r.listType).toUpperCase()+" list type constraint")),r.hasOwnProperty("enum")&&this.METADATA.rules.push(new NGN.DATA.Rule(function(e){return 0<=r.enum.indexOf(e)})),r.hasOwnProperty("tuples")&&this.METADATA.rules.push(new NGN.DATA.Rule(function(e){if(e.length<r.tuples.length)return!1;for(var t=0;t<r.tuples.length;t++){if(r.tuples[t].hasOwnProperty("type")&&NGN.typeof(e[t])!==NGN.typeof(r.tuples[t].type))return!1;if(r.tuples[t].hasOwnProperty("enum")&&r.tuples[t].enum.indexOf(e[t])<0)return!1}return!0},"Tuple constraint"))),NGN.objectHasAny(r,"enum","enumeration")&&(this.METADATA.ENUMERABLE_VALUES=new Set(NGN.forceArray(NGN.coalesce(r.enum,r.enumeration))),this.METADATA.rules.push(new NGN.DATA.Rule(function(e){return o.METADATA.ENUMERABLE_VALUES.has(e)},"Enumerable Values"))),NGN.objectHasAny(r,"not","notin")&&(this.METADATA.REVERSE_ENUMERABLE_VALUES=new Set(NGN.forceArray(NGN.coalesce(r.not,r.notin))),this.METADATA.rules.push(new NGN.DATA.Rule(function(e){return!o.METADATA.REVERSE_ENUMERABLE_VALUES.has(e)},"Rejected Values"))),r.type instanceof Array&&(0===r.type.length?(NGN.WARN("No data type specified for "+this.name+" field. Autoconverted to an array."),r.type=Array):1===r.type.length&&(r.type=r.type[0])),r.type instanceof Array){var i=r.type.map(function(e){return NGN.typeof(e)});this.METADATA.rules.unshift(new NGN.DATA.Rule(function(e){return 0<=i.indexOf(NGN.typeof(e))},this.type.toUpperCase()+" Multitype Check"))}else this.METADATA.rules.unshift(new NGN.DATA.Rule(function(e){return NGN.typeof(e)===NGN.typeof(o.METADATA.dataType)},this.type.toUpperCase()+" Type Check"));null!==NGN.coalesce(r.model)&&(this.model=r.model)}n&&(e.__proto__=n),(e.prototype=Object.create(n&&n.prototype)).constructor=e;var t={sourceName:{configurable:!0},auditable:{configurable:!0},model:{configurable:!0},fieldType:{configurable:!0},required:{configurable:!0},type:{configurable:!0},hidden:{configurable:!0},virtual:{configurable:!0},identifier:{configurable:!0},name:{configurable:!0},isNew:{configurable:!0},default:{configurable:!0},value:{configurable:!0},silentValue:{configurable:!0},modified:{configurable:!0},valid:{configurable:!0},violatedRule:{configurable:!0},changelog:{configurable:!0}};return t.sourceName.get=function(){return this.METADATA.sourceName},t.auditable.get=function(){return this.METADATA.AUDITABLE},t.auditable.set=function(e){(e=NGN.forceBoolean(e))!==this.METADATA.AUDITABLE&&(this.METADATA.AUDITABLE=e,this.METADATA.AUDITLOG=e?new NGN.DATA.TransactionLog:null,this.METADATA.AUDITLOG.relay("*",this,"transaction."))},t.model.get=function(){return this.METADATA.model},t.model.set=function(e){var t=this;null===this.METADATA.model?e instanceof NGN.DATA.Entity?(this.METADATA.model=e,this.on("update",function(e){return t.METADATA.commitPayload(e)})):NGN.WARN("Invalid model."):NGN.WARN("Cannot set model multiple times.")},t.fieldType.get=function(){return this.METADATA.fieldType},t.required.get=function(){return this.METADATA.required},t.required.set=function(e){this.METADATA.required=NGN.forceBoolean(e)},t.type.get=function(){return NGN.typeof(this.METADATA.dataType)},t.hidden.get=function(){return this.METADATA.hidden},t.hidden.set=function(e){var t=this.hidden,r=NGN.forceBoolean(e);t!==r&&(this.METADATA.hidden=r,this.emit(t?"unhidden":"hidden"))},t.virtual.get=function(){return"virtual"===this.METADATA.fieldType},t.identifier.get=function(){return this.METADATA.isIdentifier},t.identifier.set=function(e){(e=NGN.forceBoolean(e))!==this.METADATA.isIdentifier&&(this.METADATA.isIdentifier=e,this.emit("keystatus.changed",this))},t.name.get=function(){return this.METADATA.name},t.isNew.get=function(){return this.METADATA.IS_NEW},t.default.get=function(){return this.isIdentifier?NGN.coalesce(this.METADATA.autoid,this.METADATA.default):NGN.isFn(this.METADATA.default)&&"function"!==this.type?this.METADATA.default.apply(this):this.METADATA.default},t.value.get=function(){return"symbol"!=typeof this.METADATA.RAW?this.METADATA.RAW:this.METADATA.default},t.value.set=function(e){this.METADATA.setValue(e)},t.silentValue.set=function(e){this.METADATA.setValue(e,!0)},t.modified.get=function(){return"symbol"!=typeof this.META.lastValue&&this.METADATA.lastValue!==this.value},t.valid.get=function(){if(this.required&&null===NGN.coalesce(this.METADATA.RAW))return this.METADATA.violatedRule="Data Required",NGN.WARN(this.METADATA.name+" is a required field."),!1;if(0<this.METADATA.rules.length)for(var e=0;e<this.METADATA.rules.length;e++)if(!this.METADATA.rules[e].test(this.METADATA.RAW))return this.METADATA.violatedRule=this.METADATA.rules[e].name,!1;return!(this.METADATA.violatedRule=null)},t.violatedRule.get=function(){return NGN.coalesce(this.METADATA.violatedRule,"None")},t.changelog.get=function(){return this.METADATA.AUDITABLE?this.METADATA.AUDITLOG.log:(NGN.WARN("The changelog for the "+this.name+" field is empty because auditing is disabled."),[])},e.prototype.undo=function(e,t){if(void 0===e&&(e=1),void 0===t&&(t=!1),this.METADATA.AUDITABLE){var r=this.METADATA.AUDITLOG.rollback(e);this.METADATA.setValue(this.METADATA.AUDITLOG.getCommit(r).value,t,!0)}else NGN.WARN("The undo operation failed on the "+this.name+" field because auditing is disabled.")},e.prototype.redo=function(e,t){if(void 0===e&&(e=1),void 0===t&&(t=!1),this.METADATA.AUDITABLE){var r=this.METADATA.AUDITLOG.advance(e);this.METADATA.setValue(this.METADATA.AUDITLOG.getCommit(r).value,t,!0)}else NGN.WARN("The redo operation failed on the "+this.name+" field because auditing is disabled.")},e.prototype.hide=function(){this.hidden=!0},e.prototype.unhide=function(){this.hidden=!1},e.prototype.allowInvalid=function(){this.METADATA.allowInvalid=!0},e.prototype.disallowInvalid=function(){this.METADATA.allowInvalid=!1},e.prototype.autoCorrectValue=function(e){try{switch(this.type){case"number":e=NGN.forceNumber(e);break;case"boolean":e=NGN.forceBoolean(e);break;case"array":e=NGN.forceArray(e);break;case"string":e=e.toString();break;case"date":var t=NGN.typeof(e);if("date"!==t)if("number"===t){var r=new Date;r.setTime(e),e=r}else e=new Date(Date.parse(e))}}finally{return e}},Object.defineProperties(e.prototype,t),e}(i),S=function(c){function e(e){var t=this;(e=e||{}).model instanceof NGN.DATA.Entity||NGN.WARN("No model specified for the virtual field to reference."),delete e.required,delete e.default,delete e.min,delete e.minimum,delete e.max,delete e.maximum,delete e.range,delete e.rule,delete e.rules,delete e.validators,delete e.pattern,c.call(this,e),this.METADATA.AUDITABLE=!1,this.METADATA.fieldType="virtual",this.METADATA.caching=NGN.coalesce(e.cache,!0),this.METADATA.scope=NGN.coalesce(e.scope,e.model,this);var r=this,i=e.method;if(this.METADATA.virtualMethod=function(){for(var e=arguments.length,t=Array(e);e--;)t[e]=arguments[e];return i.apply.apply(i,[r.METADATA.scope].concat(t))},this.METADATA.CACHEKEY=Symbol("no.cache"),this.METADATA.cachedValue=this.METADATA.CACHEKEY,this.METADATA.caching&&this.model){for(var n=/this(\.(.[^\W]+)|\[['"]{1}(.*)+['"]{1}\])/g,o=new Set,s=i.toString(),a=n.exec(s);null!==a;){var l=NGN.coalesce(a[2],a[3]);t.model.METADATA.knownFieldNames.has(l)&&o.add(l),s=s.replace(n,""),a=n.exec(s)}this.METADATA.model.pool("field.",{update:function(e){e.field&&o.has(e.field.name)&&(t.METADATA.cachedValue=t.METADATA.CACHEKEY,t.emit("cache.clear",t))},remove:function(e){o.has(e.name)&&(t.METADATA.cachedValue=t.METADATA.CACHEKEY,t.emit("cache.clear",t),NGN.ERROR("The "+t.name+" virtual field uses the "+e.name+" field, which was removed. This virtual field may no longer work."))},create:function(e){o.has(e.name)&&(t.METADATA.cachedValue=t.METADATA.CACHEKEY,t.emit("cache.clear",t),NGN.INFO("The "+t.name+" virtual field uses the "+e.name+" field, which was added."))}})}}c&&(e.__proto__=c),(e.prototype=Object.create(c&&c.prototype)).constructor=e;var t={auditable:{configurable:!0},value:{configurable:!0},required:{configurable:!0},isNew:{configurable:!0},default:{configurable:!0},violatedRule:{configurable:!0},valid:{configurable:!0},modified:{configurable:!0}};return t.auditable.get=function(){return NGN.WARN("Virtual fields do not support the auditable property."),!1},t.auditable.set=function(e){NGN.WARN("Virtual fields do not support the auditable property.")},t.value.get=function(){return this.METADATA.caching?(this.METADATA.cachedValue!==this.METADATA.CACHEKEY||(this.METADATA.cachedValue=this.METADATA.virtualMethod()),this.METADATA.cachedValue):this.METADATA.virtualMethod()},t.value.set=function(e){NGN.WARN("Cannot set the value of a virtual field (read only).")},t.required.get=function(){return NGN.WARN("Virtual fields do not support the required property."),!1},t.required.set=function(e){NGN.WARN("Virtual fields do not support the required property.")},t.isNew.get=function(){return NGN.WARN("Virtual fields do not support the isNew property."),!1},t.default.get=function(){NGN.WARN("Virtual fields do not have default values.")},t.default.set=function(e){NGN.WARN("Virtual fields do not have default values.")},t.violatedRule.get=function(){return"None"},t.valid.get=function(){return NGN.WARN("Virtual fields are always valid."),!0},t.modified.get=function(){return NGN.WARN("modified attribute does nothing on virtual fields."),!1},e.prototype.allowInvalid=function(){NGN.WARN("allowInvalid() unavailable for virtual fields.")},e.prototype.disallowInvalid=function(){NGN.WARN("disallowInvalid() unavailable for virtual fields.")},e.prototype.autocorrectInput=function(){NGN.WARN("autocorrectInput() unavailable for virtual fields.")},Object.defineProperties(e.prototype,t),e}(C),P=function(i){function e(e){var r=this;void 0===e&&(e={});var t=NGN.typeof(e.join);if(!e.join)throw new InvalidConfigurationError('Missing "join" configuration property.');if(["model","store"].indexOf(t)<0&&("array"!==t||"model"!==NGN.typeof(e.join[0])))throw new InvalidConfigurationError("The join specified is not a valid NGN.DATA.Model, NGN.DATA.Store, or collection. It is a "+NGN.typeof(e.join)+'"');e.identifier=!1,i.call(this,e),this.METADATA.fieldType="join",this.METADATA.join=Symbol("relationship"),this.METADATA.applyMonitor=function(){"model"===r.METADATA.manner&&r.METADATA.join.pool("field.",{create:r.METADATA.commonModelEventHandler("field.create"),update:r.METADATA.commonModelEventHandler("field.update"),remove:r.METADATA.commonModelEventHandler("field.remove"),invalid:function(e){r.emit(["invalid","invalid."+r.METADATA.name+"."+e.field])},valid:function(e){r.emit(["valid","valid."+r.METADATA.name+"."+e.field])}})},this.METADATA.commonModelEventHandler=function(e){var t=r;return function(e){t.METADATA.commitPayload({field:t.name+"."+e.field,old:NGN.coalesce(e.old),new:NGN.coalesce(e.new),join:!0,originalEvent:{event:this.event,record:t.METADATA.record}})}},this.METADATA.commonStoreEventHandler=function(e){var i=r;return function(e,t){var r=t?NGN.coalesce(t.old):i.data;"record.create"===this.event?r.pop():"record.delete"===this.event&&r.push(e.data),i.METADATA.commitPayload({field:i.name+(t?"."+t.field:""),old:t?NGN.coalesce(t.old):r,new:t?NGN.coalesce(t.new):i.data,join:!0,originalEvent:{event:this.event,record:e}})}},this.value=NGN.coalesce(e.join),this.METADATA.AUDITABLE=!1,this.auditable=NGN.coalesce(e.audit,!1)}i&&(e.__proto__=i),(e.prototype=Object.create(i&&i.prototype)).constructor=e;var t={manner:{configurable:!0},value:{configurable:!0},auditable:{configurable:!0}};return t.manner.get=function(){return NGN.coalesce(this.METADATA.manner,"unknown")},t.value.get=function(){return this.METADATA.join},t.value.set=function(e){var t=this.METADATA.join;if(t!==e){var r=NGN.typeof(e);if("array"===r){if(1!==e.length)throw new Error(this.METADATA.name+" cannot refer to an empty data store/model collection. A record must be provided.");this.METADATA.manner="store",e=new NGN.DATA.Store({model:e[0]})}else{if(!(0<=["model","store"].indexOf(r)))throw NGN.ERROR('The "'+this.METADATA.name+'" relationship has an invalid record type. Only instances of NGN.DATA.Store, NGN.DATA.Model, or [NGN.DATA.Model] are supported." .'),new InvalidConfigurationError('Invalid record configuration for "'+this.METADATA.name+'" field.');this.METADATA.manner=r}if("unknown"===this.manner)throw new Error("Cannot set a relationship field to anything other than an NGN.DATA.Store, NGN.DATA.Model, or an array of NGN.DATA.Model collections. (Unknown manner of relationship)");this.METADATA.join="model"===r?new e:e,this.auditable=this.METADATA.AUDITABLE,this.METADATA.applyMonitor(),"symbol"!=typeof t&&this.emit("update",{old:t,new:e})}},t.auditable.set=function(e){(e=NGN.forceBoolean(e))!==this.METADATA.AUDITABLE&&(this.METADATA.AUDITABLE=e,this.METADATA.join.auditable=e)},e.prototype.undo=function(){var e;"model"===this.METADATA.manner&&(e=this.METADATA.join).undo.apply(e,arguments)},e.prototype.redo=function(){var e;"model"===this.METADATA.manner&&(e=this.METADATA.join).redo.apply(e,arguments)},Object.defineProperties(e.prototype,t),e}(C),L=function(e){var n=this;void 0===e&&(e={}),Object.defineProperties(this,{originalSource:NGN.privateconst(e),sourceMap:NGN.private(null),reverseMap:NGN.private(null),applyData:NGN.privateconst(function(e,t){if(void 0===e&&(e="map"),"object"!==NGN.typeof(t))return t;var r=Object.keys(t);e="map"===e?n.inverse:n.map;for(var i=0;i<r.length;i++)e.hasOwnProperty(r[i])&&(t[e[r[i]]]=t[r[i]],delete t[r[i]]);return t})})},V={map:{configurable:!0},inverse:{configurable:!0}};V.map.get=function(){if(null===this.sourceMap){var e=Object.keys(this.originalSource);this.sourceMap={};for(var t=0;t<e.length;t++)"string"===NGN.typeof(e[t])&&"string"===NGN.typeof(this.originalSource[e[t]])&&(this.sourceMap[e[t]]=this.originalSource[e[t]])}return this.sourceMap},V.inverse.get=function(){if(null===this.reverseMap){var e=Object.keys(this.originalSource);this.reverseMap={};for(var t=0;t<e.length;t++)"string"===NGN.typeof(e[t])&&"string"===NGN.typeof(this.originalSource[e[t]])&&(this.reverseMap[this.originalSource[e[t]]]=e[t])}return this.reverseMap},L.prototype.applyMap=function(e){return this.applyData("map",e)},L.prototype.applyInverseMap=function(e){return this.applyData("reverse",e)},Object.defineProperties(L.prototype,V);var k=function(A){function e(e){var o=this;e=NGN.coalesce(e,{}),A.call(this),e.dataMap&&(e.fieldmap=e.dataMap,NGN.WARN('"dataMap" is deprecated. Use "map" instead.')),e.idAttribute&&(e.IdentificationField=e.idAttribute,NGN.WARN('"idAttribute" is deprecated. Use "IdentificationField" instead.'));var t=this;Object.defineProperties(this,{OID:NGN.private(Symbol("model.id")),METADATA:NGN.privateconst({name:NGN.coalesce(e.name,"Untitled Model"),description:NGN.coalesce(e.description,e.name,"Generic Data Model"),fields:Object.assign({},NGN.coalesce(e.fields,{})),knownFieldNames:new Set,invalidFieldNames:new Set,auditFieldNames:NGN.coalesce(e.audit,!1)?new Set:null,validators:NGN.coalesce(e.rules,e.rule,e.validators),validation:NGN.coalesce(e.validation,!0),autoid:NGN.coalesce(e.autoid,!1),IdentificationField:NGN.coalesce(e.IdentificationField,e.idField,"id"),expiration:null,expirationTimeout:null,created:Date.now(),store:null,AUDITABLE:!1,AUDITLOG:NGN.coalesce(e.audit,!1)?new NGN.DATA.TransactionLog:null,AUDIT_HANDLER:function(e){e.hasOwnProperty("cursor")&&t.METADATA.AUDITLOG.commit(t.METADATA.getAuditMap())},EVENTS:new Set(["field.update","field.create","field.remove","field.invalid","field.valid","field.hidden","field.unhidden","field.rule.add","field.rule.remove","rule.add","rule.remove","relationship.create","relationship.remove","expired","deleted","reset","load"]),applyField:function(t,e,r){if(void 0===e&&(e=null),void 0===r&&(r=!1),o.METADATA.knownFieldNames.has(t))return NGN.WARN('Duplicate field "'+t+'" detected.');if(o.hasOwnProperty(t)&&"id"!==t.toLowerCase())throw new ReservedWordError('"'+t+'" cannot be used as a field name (reserved word).');if(e instanceof NGN.DATA.Field){if(null===e.model)e.name=t,e.identifier=e.identifier=NGN.coalesce(e.identifier,o.METADATA.IdentificationField===t),o.METADATA.fields[t]=e,o.METADATA.fields[t].model=o;else if(e.model===o)e.identifier=NGN.coalesce(e.identifier,o.METADATA.IdentificationField===t),o.METADATA.fields[t]=e;else if(!(e instanceof NGN.DATA.Field))return NGN.WARN('The "'+e.name+'" field cannot be applied because model is already specified.')}else if(e instanceof NGN.DATA.Store||e instanceof NGN.DATA.Model){if(o.METADATA.IdentificationField===t)throw new InvalidConfigurationError('"'+t+'" cannot be an ID. Relationship fields cannot be an identification field/attribute.');o.METADATA.fields[t]=new NGN.DATA.Relationship({name:t,record:e,model:o})}else switch(NGN.typeof(e)){case"object":e.model=o,e.identifier=NGN.coalesce(e.identifier,o.METADATA.IdentificationField===t),e.name=t,o.METADATA.fields[t]=new NGN.DATA.Field(e);break;case"array":return o.METADATA.applyField(t,e[0],r);default:if(NGN.isFn(e)||null===e){if(NGN.isFn(e)&&["string","number","boolean","number","symbol","regexp","date","array","object"].indexOf(NGN.typeof(e))<0){o.METADATA.fields[t]=new NGN.DATA.VirtualField({name:t,identifier:o.METADATA.IdentificationField===t,model:o,method:e});break}o.METADATA.fields[t]=new NGN.DATA.Field({name:t,type:e,identifier:o.METADATA.IdentificationField===t,model:o});break}o.METADATA.fields[t]=new NGN.DATA.Field({name:t,type:NGN.isFn(e)?e:String,identifier:!NGN.isFn(e)&&NGN.coalesce(e.identifier,o.METADATA.IdentificationField===t),model:o})}return Object.defineProperty(o,t,{enumerable:!0,configurable:!0,get:function(){return o.get(t)},set:function(e){return o.set(t,e)}}),o.METADATA.AUDITABLE&&"virtual"!==o.METADATA.fields[t].fieldType&&(o.METADATA.fields[t].auditable=!0,o.METADATA.auditFieldNames.add(t)),o.METADATA.knownFieldNames.add(t),o.METADATA.fields[t].relay("*",o,"field."),r||o.emit("field.create",o.METADATA.fields[t]),o.METADATA.fields[t]},applyChange:function(e,t,i){if(void 0===e&&(e="undo"),void 0===t&&(t=1),void 0===i&&(i=!1),o.METADATA.AUDITABLE){o.METADATA.AUDITLOG["undo"===e?"rollback":"advance"](t);var n=o.METADATA.AUDITLOG.currentValue;n&&o.METADATA.auditFieldNames.forEach(function(e){var t=o.METADATA.fields[e],r=t.METADATA.AUDITLOG;r.cursor!==n[e]&&("symbol"==typeof n[e]?r.cursor=n[e]:r.cursor=null,t.METADATA.setValue(NGN.coalesce(r.currentValue,t.default),i,!0))})}else NGN.WARN("The "+e+" operation failed on the "+o.name+" model because auditing is disabled.")},getAuditMap:function(){var t={};return o.METADATA.auditFieldNames.forEach(function(e){t[e]=o.METADATA.fields[e].METADATA.AUDITLOG.cursor}),t},setSilent:NGN.deprecate(this.setSilentFieldValue,"setSilent has been deprecated. Use setSilentFieldValue instead."),DATAMAP:null}),MAP:NGN.get(function(){return NGN.coalesce(o.METADATA.DATAMAP,o.METADATA.store instanceof NGN.DATA.Store?o.METADATA.store.map:null)})}),e.fieldmap instanceof NGN.DATA.FieldMap?this.METADATA.DATAMAP=e.fieldmap:"object"===NGN.typeof(e.fieldmap)&&(this.METADATA.DATAMAP=new NGN.DATA.FieldMap(e.fieldmap));for(var r=Object.keys(this.METADATA.fields),i=0;i<r.length;i++){var n=r[i];o.METADATA.knownFieldNames.has(n)?NGN.WARN('Duplicate field "'+n+'" detected.'):o.METADATA.applyField(n,o.METADATA.fields[n],!0)}if(this.METADATA.autoid){var s=null;Object.defineProperty(this.METADATA,"IdentificationValue",NGN.get(function(){return null===s&&(s=NGN.DATA.UTILITY.UUID()),s}))}if(this.auditable=NGN.coalesce(e.audit,!1),this.on(["field.update","field.create","field.delete","field.hidden","field.unhidden"],function(){o.METADATA.checksum&&(o.METADATA.checksum=null)}),e.expires&&(this.expires=e.expires),null!==this.METADATA.validators)switch(NGN.typeof(this.METADATA.validators)){case"object":for(var a=Object.keys(this.METADATA.validators),l=[],c=0;c<a.length;c++)l.push(new NGN.DATA.Rule(o.METADATA.validators[a[c]],a[c],o));break;case"array":for(var u=0;u<this.METADATA.validators.length;u++){if(!o.METADATA.validators[u].hasOwnProperty("RULE"))throw new Error("Invalid data rule configuration for "+o.name+" model. Rule #"+u+" is not a valid NGN.DATA.Rule instance.");o.METADATA.validators[u].RULE.scope=o}break;default:throw new Error("Invalid data rule configuration for "+this.name+' model. Expected an object or array of NGN.DATA.Rule instances. Received "'+NGN.typeof(this.METADATA.validators)+'"')}null!==NGN.coalesce(e.expires)&&(this.expires=e.expires)}A&&(e.__proto__=A),(e.prototype=Object.create(A&&A.prototype)).constructor=e;var t={name:{configurable:!0},auditable:{configurable:!0},id:{configurable:!0},ID:{configurable:!0},store:{configurable:!0},changelog:{configurable:!0},createDate:{configurable:!0},data:{configurable:!0},unmappedData:{configurable:!0},representation:{configurable:!0},unmappedRepresentation:{configurable:!0},checksum:{configurable:!0},expires:{configurable:!0},expired:{configurable:!0},fieldDefinitions:{configurable:!0}};return t.name.get=function(){return this.METADATA.name},t.auditable.set=function(t){var r=this;(t=NGN.forceBoolean(t))!==this.METADATA.AUDITABLE&&(this.METADATA.AUDITABLE=t,this.METADATA.AUDITLOG=t?new NGN.DATA.TransactionLog:null,this.METADATA.auditFieldNames=t?new Set:null,this.METADATA.knownFieldNames.forEach(function(e){r.METADATA.fields[e].virtual||(r.METADATA.fields[e].auditable=t)&&r.METADATA.auditFieldNames.add(e)}),t?this.on("field.transaction.*",function(e){r.METADATA.AUDIT_HANDLER({cursor:e})}):(this.METADATA.auditFieldNames.clear(),this.off("field.transaction.*")))},t.id.get=function(){return this.get(this.METADATA.IdentificationField)},t.id.set=function(e){this.set("id",e)},t.ID.get=function(){return this.id},t.ID.set=function(e){this.set("id",e)},t.store.get=function(){return this.METADATA.store},t.changelog.get=function(){var o=this;return this.METADATA.AUDITLOG.log.map(function(e){for(var t={timestamp:e.timestamp,activeCursor:e.activeCursor,value:{}},r=e.value,i=Object.keys(r),n=0;n<i.length;n++)"symbol"==typeof r[i[n]]?t.value[i[n]]=NGN.coalesce(o.METADATA.fields[i[n]].METADATA.AUDITLOG.getCommit(r[i[n]]).value,o.METADATA.fields[i[n]].default):t.value[i[n]]=NGN.coalesce(o.METADATA.fields[i[n]].default);return t})},t.createDate.get=function(){return this.METADATA.created},t.data.get=function(){return this.MAP?this.MAP.applyInverseMap(this.serializeFields()):this.serializeFields()},t.unmappedData.get=function(){return this.serializeFields()},t.representation.get=function(){return this.MAP?this.MAP.applyInverseMap(this.serializeFields(!1,!1)):this.serializeFields(!1,!1)},t.unmappedRepresentation.get=function(){return this.serializeFields(!1,!1)},t.checksum.get=function(){return this.METADATA.checksum=NGN.coalesce(this.METADATA.checksum,NGN.DATA.UTILITY.checksum(JSON.stringify(this.data))),this.METADATA.checksum},t.expires.get=function(){return this.METADATA.expiration},t.expires.set=function(e){var t=this;if(null===e)return clearTimeout(this.METADATA.expirationTimeout),void(this.METADATA.expiration=null);var r=new Date;if(isNaN(e)||e instanceof Date){if(!(e instanceof Date)||e<=r)throw new Error(this.name+" expiration (TTL) value must be a positive number (milliseconds) or future date.");this.METADATA.expiration=e}else{if(e<0)return void(this.METADATA.expiration=null);if(0===e)return this.METADATA.expiration=r,void this.emit("expire",this);this.METADATA.expiration=new Date,this.METADATA.expiration.setTime(r.getTime()+e)}clearTimeout(this.METADATA.expirationTimeout),this.METADATA.expirationTimeout=setTimeout(function(){return t.emit("expire",t)},this.METADATA.expiration.getTime()-r.getTime())},t.expired.get=function(){return null!==this.METADATA.expiration&&this.METADATA.expiration<=new Date},t.fieldDefinitions.get=function(){return this.METADATA.fields},e.prototype.serializeFields=function(e,t){if(void 0===e&&(e=!1),void 0===t&&(t=!0),0===this.METADATA.knownFieldNames.size)return{};for(var r=this.METADATA.knownFieldNames.keys(),i={},n=r.next();!n.done;){var o=this.METADATA.fields[n.value];if((void 0===o.value||e&&n.value===this.IdentificationField||!o.virtual||!t&&o.virtual)&&!o.hidden)switch(NGN.typeof(o.value)){case"array":case"object":i[n.value]=NGN.DATA.UTILITY.serialize(o.value);break;default:i[n.value]=o.value}n=r.next()}return i},e.prototype.serialize=function(){return NGN.deprecate(this.serializeFields,"serialize is now serializeFields. Use NGN.DATA.UTILITY.serialize for generic object serialization.")},e.prototype.fieldExists=function(e){return this.METADATA.knownFieldNames.has(e)},e.prototype.get=function(e){return"id"!==e&&"ID"!==e&&e!==this.METADATA.IdentificationField||(e=this.METADATA.IdentificationField,!this.METADATA.autoid)?this.METADATA.knownFieldNames.has(e)?this.METADATA.fields[e].value:void NGN.WARN('Cannot get "'+e+'". The field is not part of the model.'):this.METADATA.knownFieldNames.has(e)?NGN.coalesce(this.METADATA.fields[e].value,this.METADATA.IdentificationValue):this.METADATA.IdentificationValue},e.prototype.set=function(e,t){"id"!==e&&"ID"!==e||(e=this.METADATA.IdentificationField),this.METADATA.knownFieldNames.has(e)?this.METADATA.fields[e].value=t:NGN.WARN('Cannot set "'+e+'". Unrecognized field name.')},e.prototype.addField=function(e,t,r){if(void 0===t&&(t=null),void 0===r&&(r=!1),e instanceof NGN.DATA.Field)e=(t=e).name;else if("string"!=typeof e)throw new Error("Cannot add a non-string based field.");this.METADATA.applyField(e,t,r)},e.prototype.removeField=function(e,t){if(void 0===t&&(t=!1),this.METADATA.knownFieldNames.has(e)){this.METADATA.knownFieldNames.delete(e),this.METADATA.invalidFieldNames.delete(e);var r=this.METADATA.fields[e];delete this[e],delete this.METADATA.fields[e],t||this.emit("field.remove",r),null!==this.METADATA.store&&this.METADATA.store.emit(this.METADATA.store.PRIVATE.EVENT.DELETE_RECORD_FIELD,{record:this,field:r})}},e.prototype.getField=function(e){return"id"===e.toLowerCase()&&!this.METADATA.fields.hasOwnProperty(e)&&this.METADATA.fields.hasOwnProperty(this.METADATA.IdentificationField)?this.METADATA.fields[this.METADATA.IdentificationField]:this.METADATA.fields[e]},e.prototype.setSilentFieldValue=function(e,t){this.METADATA.fields[e].silentValue=t},e.prototype.undo=function(e,t){for(var r,i=arguments.length,n=Array(i);i--;)n[i]=arguments[i];void 0===e&&(e=1),void 0===t&&(t=!1),(r=this.METADATA).applyChange.apply(r,["undo"].concat(n))},e.prototype.redo=function(e,t){for(var r,i=arguments.length,n=Array(i);i--;)n[i]=arguments[i];void 0===e&&(e=1),void 0===t&&(t=!1),(r=this.METADATA).applyChange.apply(r,["redo"].concat(n))},e.prototype.load=function(e,t){void 0===t&&(t=!1),this.MAP&&(e=this.MAP.applyMap(e));for(var r=Object.keys(e),i=0;i<r.length;i++)this.METADATA.knownFieldNames.has(r[i])?this.METADATA.fields[r[i]].METADATA.setValue(e[r[i]],t):NGN.WARN("Failed to load "+r[i]+" field of "+this.name+' model. "'+r[i]+'" is not a recognized field.');return t||this.emit("load"),this},e.prototype.next=function(e,t){return void 0===e&&(e=1),void 0===t&&(t=!1),0===e?this:this.METADATA.store?("boolean"==typeof e&&(t=e,e=1),this.METADATA.store.getRecordSibling(this,e,t)):(NGN.WARN("Attempted to call next() on a model that does not belong to a store."),this)},e.prototype.previous=function(e,t){return void 0===e&&(e=1),void 0===t&&(t=!1),0===e?this:this.METADATA.store?("boolean"==typeof e&&(t=e,e=1),this.METADATA.store.getRecordSibling(this,0-e,t)):(NGN.WARN("Attempted to call previous() on a model that does not belong to a store."),this)},e.prototype.destroy=function(){this.METADATA.store?this.METADATA.store.remove(this.OID):NGN.WARN("Attempted to call remove() on a model that does not belong to a store.")},Object.defineProperties(e.prototype,t),e}(i),F=function(r){function e(e,t){var i=this;void 0===e&&(e=!1),void 0===t&&(t="Untitled Index"),r.call(this),Object.defineProperties(this,{CREATE_EVENT:NGN.privateconst(Symbol("create")),REMOVE_EVENT:NGN.privateconst(Symbol("delete")),UPDATE_EVENT:NGN.privateconst(Symbol("update")),uniqueValues:NGN.privateconst(new Set),knownRecords:NGN.privateconst([]),name:NGN.const(t),isBTree:NGN.privateconst(e)});var n=this;this.on([this.CREATE_EVENT,this.REMOVE_EVENT,this.UPDATE_EVENT],function(e,t,r){void 0===r&&(r=!1),r||n.emit(this.event.toString().replace(/^Symbol\(|\)$/g,""),e)}),this.on(this.REMOVE_EVENT,function(e,t){if(0===i.recordsFor(t).length){var r=i.indexOf(t);0<=r&&(i.knownRecords.splice(r,1),i.uniqueValues.delete(t))}}),this.isBTree&&Object.defineProperty(this,"BTREE",NGN.privateconst(new NGN.DATA.BTree(2,t)))}r&&(e.__proto__=r),(e.prototype=Object.create(r&&r.prototype)).constructor=e;var t={keys:{configurable:!0}};return t.keys.get=function(){return 0===this.uniqueValues.size?[]:Array.from(this.uniqueValues.values())},e.prototype.add=function(e,t,r){void 0===r&&(r=!1);var i=-1;if(this.uniqueValues.has(e)?i=this.indexOf(e):(this.uniqueValues.add(e),this.knownRecords.push(new Set),i+=this.uniqueValues.size),this.knownRecords[i].add(t),this.isBTree){var n=e instanceof Date?e.getTime():e;void 0===this.BTREE.get(n)&&this.BTREE.put(n,i)}this.emit(this.CREATE_EVENT,t,e,r)},e.prototype.remove=function(e,t,r){if(void 0===r&&(r=!1),void 0!==t){var i=this.recordsOf(t);if(i&&i.delete(e))return!this.isBTree||i&&0!==i.size||this.BTREE.delete(t instanceof Date?t.getTime():t),void this.emit(this.REMOVE_EVENT,e,t,r);NGN.WARN('Index value "'+t+'" not found in index.')}for(var n=!1,o=0;o<this.knownRecords.length;o++)if(this.knownRecords[o].delete(e)&&!n){n=!0,t=Array.from(this.uniqueValues.values())[o],this.isBTree&&this.BTREE.delete(t instanceof Date?t.getTime():t);break}n&&this.emit(this.REMOVE_EVENT,e,t,r)},e.prototype.update=function(e,t,r,i){void 0===i&&(i=!1),t!==r&&(this.remove(e,t,!0),this.add(r,e,!0),this.emit(this.UPDATE_EVENT,e,null,i))},e.prototype.reset=function(){this.uniqueValues.clear(),this.knownRecords.splice(0),this.isBTree&&this.BTREE.reset(),this.emit("reset")},e.prototype.indexOf=function(e){return Array.from(this.uniqueValues.keys()).indexOf(e)},e.prototype.recordsOf=function(e){var t=this.indexOf(e);return t<0?null:this.knownRecords[t]},e.prototype.recordsFor=function(e){var t=this.recordsOf(e);return null===t||0===t.size?[]:Array.from(t.values())},Object.defineProperties(e.prototype,t),e}(i),j=function(o){function e(e,t,r){var i=this;void 0===r&&(r=!0),NGN.isFn(e)&&(r="boolean"===NGN.type(t)?t:r,e="Filter_"+(t=e).toString().length+(new Date).getTime()),o.call(this);var n=this;Object.defineProperties(this,{recordUpdates:NGN.private(new Map),filterName:NGN.private(e),fn:NGN.private(t),active:NGN.private(r),filteredRecords:NGN.private({}),filteredRecordStores:NGN.private(new Map),clean:NGN.privateconst(function(){for(var e=arguments,t=0;t<arguments.length;t++){var r=e[0];if(!(r instanceof NGN.DATA.Store))throw new Error("Cannot clean filter for an unrecognized data store.");n.filteredRecordStores.set(r.OID,r),n.filteredRecords[r.OID]=new Set}}),clearFilter:NGN.privateconst(function(){var r=this;(0<arguments.length?Array.from(arguments).map(function(e){return e.OID}):Object.keys(n.filteredRecords)).forEach(function(e){var t=n.filteredRecordStores.get(e);t?n.filteredRecords[e].forEach(function(e){t.PRIVATE.ACTIVERECORDS.set(e,t.PRIVATE.FILTEREDRECORDS.get(e)),t.PRIVATE.FILTEREDRECORDS.delete(e)}):NGN.WARN("An attempt to remove "+r.name+" filter occurred for a NGN.DATA.Store that could not be found or does not exist.")}),this.active=!1}),STORE_EVENT:NGN.privateconst(Symbol("monitor.store.event-"+e+"-filter")),deactivate:NGN.privateconst(function(){NGN.INFO("filter.disable",'Disabling "'+i.name+'"'),i.filteredRecordStores.forEach(function(t){i.filteredRecords[t.OID].forEach(function(e){t.indexOf(e)<0?(console.log("Record DNE?"),i.filteredRecords[t.OID].delete(e)):(t.PRIVATE.ACTIVERECORDS.set(e,t.indexOf(e)),t.PRIVATE.FILTEREDRECORDS.delete(e))})}),i.active=!1}),activate:NGN.privateconst(function(){NGN.INFO("filter.enable",'Enabling "'+i.name+'"'),i.filteredRecordStores.forEach(function(t){i.recordUpdates.has(t.OID)&&(i.recordUpdates.get(t.OID).forEach(function(e){t.PRIVATE.RECORDMAP.has(e)&&i.exec(t.METADATA.records[t.PRIVATE.RECORDMAP.get(e)])}),i.recordUpdates.get(t.OID).clear()),i.filteredRecords[t.OID].forEach(function(e){i.recordUpdates.has(t.OID)&&i.recordUpdates.get(t.OID).has(e)||(t.PRIVATE.FILTEREDRECORDS.set(e,t.indexOf(e)),t.PRIVATE.ACTIVERECORDS.delete(e))})}),i.active=!0})}),this.on(this.STORE_EVENT,function(e){switch(i.recordUpdates.has(e.record.store.OID)||i.recordUpdates.set(e.record.store.OID,new Set),e.event){case"record.create":i.active?i.exec(e.record):i.recordUpdates.get(e.record.store.OID).add(e.record.OID);break;case"record.delete":i.active?i.filteredRecords.hasOwnProperty(e.record.store.OID)&&i.filteredRecords[e.record.store.OID].delete(e.record.OID):i.recordUpdates.get(e.record.store.OID).add(e.record.OID);break;case"record.update":if(i.active){var t=i.filteredRecords[e.record.store.OID].get(e.record.OID);i.exec(e.record)&&t&&(i.filteredRecords[e.record.store.OID].delete(e.record.OID),e.record.store.PRIVATE.ACTIVERECORDS.set(e.record.OID,e.record.store.PRIVATE.FILTEREDRECORDS.get(e.record.OID)),e.record.store.PRIVATE.FILTEREDRECORDS.delete(e.record.OID))}else i.recordUpdates.get(e.record.store.OID).add(e.record.OID);break;default:NGN.WARN('"'+e.event+'" is not handled by filter functions.')}})}o&&(e.__proto__=o),(e.prototype=Object.create(o&&o.prototype)).constructor=e;var t={applied:{configurable:!0},name:{configurable:!0},enabled:{configurable:!0},disabled:{configurable:!0}};return t.applied.get=function(){return this.active},t.name.get=function(){return this.filterName},t.name.set=function(e){if(e!==this.filterName){var t=this.filterName;this.filterName=e,this.emit("renamed",{old:t,new:e})}},t.enabled.get=function(){return this.active},t.enabled.set=function(e){(e=NGN.forceBoolean(e))!==this.active&&(e?this.enable():this.disable())},t.disabled.get=function(){return!this.active},t.disabled.set=function(e){(e=!NGN.forceBoolean(e))!==!this.active&&(e?this.disable():this.enable())},e.prototype.enable=function(){this.active||(this.activate(),this.emit("enabled"))},e.prototype.disable=function(){this.active&&(this.deactivate(),this.emit("disabled"))},e.prototype.apply=function(e){e.addFilter(this)},e.prototype.exec=function(e){if(!this.active)return!1;if(!e)throw new Error("Cannot execute filter against a null/undefined record.");e.METADATA||(e=e.store.getRecord(e.OID));var t=e.METADATA.store;if(null==t)throw new Error("Cannot filter a record which is not part of a store: \n"+JSON.stringify(e.data,null,2));var r=this.fn(e);if(!r){if(!this.filteredRecords.hasOwnProperty(t.OID)){this.filteredRecords[t.OID]=new Set,this.filteredRecordStores.set(t.OID,t);var i=this;t.on("record.*",function(e){i.delayEmit(i.STORE_EVENT,0,{event:this.event,record:e})})}this.filteredRecords[t.OID].add(e.OID),t.PRIVATE.FILTEREDRECORDS.set(e.OID,t.indexOf(e.OID)),t.PRIVATE.ACTIVERECORDS.delete(e.OID)}return r},e.prototype.clear=function(){var e;this.active&&(e=this).clearFilter.apply(e,arguments)},e.prototype.purge=function(){var t=this;if(0===arguments.length)return this.filteredRecords={},void(this.filteredRecordStores=new Map);Array.from(arguments).map(function(e){return e.OID}).forEach(function(e){delete t.filteredRecords[e],t.filteredRecordStores.delete(e)})},e.prototype.destroy=function(){var e,t=this;(e=this).clearFilter.apply(e,arguments);var r=Array.from(arguments);(0===r.length?Array.from(this.filteredRecordStores).map(function(e){return e[1]}):r).forEach(function(e){return e.METADATA.filters.delete(t.name)})},Object.defineProperties(e.prototype,t),e}(i);NGN.createException({name:"NGNDuplicateRecordError",message:"A duplicate record exists within the unique data set."}),NGN.createException({name:"NGNMissingRecordError",message:"The specified record does not exist or cannot be found."});var U=function(r){function e(e){var t=this;if(void 0===e&&(e={}),"model"===NGN.typeof(e))e={model:e};else if(!e.model||!NGN.DATA.UTILITY.isDataModel(e.model))throw new InvalidConfigurationError('Missing or invalid "model" configuration property.');r.call(this);var c=this;if(Object.defineProperties(this,{OID:NGN.privateconst(Symbol("store.id")),METADATA:NGN.private({name:NGN.coalesce(e.name,"Untitled Data Store"),records:[],filters:new Map,Model:NGN.coalesce(e.model),expires:NGN.coalesce(e.expires,-1),allowDuplicates:NGN.coalesce(e.allowDuplicates,!0),errorOnDuplicate:NGN.coalesce(e.errorOnDuplicate,e.allowDuplicates,!1),allowInvalid:NGN.coalesce(e.allowInvalid,!0),errorOnInvalid:NGN.coalesce(e.errorOnInvalid,e.allowInvalid,!1),autoRemoveExpiredRecords:NGN.coalesce(e.autoRemoveExpiredRecords,!0),softDelete:NGN.coalesce(e.softDelete,!1),softDeleteTtl:NGN.coalesce(e.softDeleteTtl,-1),fifo:NGN.coalesce(e.FIFO,-1),lifo:NGN.coalesce(e.LIFO,-1),maxRecords:NGN.coalesce(e.maxRecords,-1),minRecords:NGN.coalesce(e.minRecords,0),autocompact:NGN.coalesce(e.autocompact,5e4),MAP:NGN.coalesce(e.fieldmap),EVENTS:new Set(["record.duplicate","record.create","record.update","record.delete","record.restored","record.expired","record.purged","record.move","record.invalid","record.valid","clear","filter.create","filter.delete","index.create","index.delete","compact.start","compact.complete"]),AUDITABLE:NGN.coalesce(e.audit,!1),AUDITLOG:NGN.coalesce(e.audit,!1)?new NGN.DATA.TransactionLog:null,AUDIT_HANDLER:function(e){e.hasOwnProperty("cursor")&&t.METADATA.AUDITLOG.commit(t.METADATA.getAuditMap())},FIRSTRECORDINDEX:0,LASTRECORDINDEX:0,INDEX:null}),PRIVATE:NGN.privateconst({STUB:Symbol("record.stub"),INDEX:function(t,e){if("symbol"==typeof this.event)switch(this.event){case c.PRIVATE.EVENT.CREATE_RECORD:c.METADATA.INDEXFIELDS.forEach(function(e){return c.METADATA.INDEX[e].add(t[e],t.OID)});break;case c.PRIVATE.EVENT.DELETE_RECORD:c.METADATA.INDEXFIELDS.forEach(function(e){return c.METADATA.INDEX[e].remove(t.OID,t[e])});break;case c.PRIVATE.EVENT.LOAD_RECORDS:for(var r=function(t){c.METADATA.INDEXFIELDS.forEach(function(e){return c.METADATA.INDEX[e].add(c.METADATA.records[t][e],c.METADATA.records[t].OID)})},i=0;i<c.METADATA.records.length;i++)r(i);break;case c.PRIVATE.EVENT.DELETE_RECORD_FIELD:c.METADATA.INDEXFIELDS.has(t.field.name)&&c.METADATA.INDEX[t.field.name].remove(t.record.OID,t.field.value);break;case c.PRIVATE.EVENT.CLEAR_RECORDS:c.METADATA.INDEXFIELDS.forEach(function(e){return c.METADATA.INDEX[e].reset()})}else switch(this.event){case"record.update":c.METADATA.INDEXFIELDS.has(e.field.name)&&c.METADATA.INDEX[e.field.name].update(t.OID,e.old,e.new);break;case"clear":c.METADATA.INDEXFIELDS.forEach(function(e){return c.METADATA.INDEX[e].reset()})}},RECORDMAP:new Map,ACTIVERECORDMAP:null,FILTEREDRECORDMAP:null,EVENT:{CREATE_RECORD:Symbol("record.create"),DELETE_RECORD:Symbol("record.delete"),DELETE_RECORD_FIELD:Symbol("records.field.delete"),LOAD_RECORDS:Symbol("records.load"),CLEAR_RECORDS:Symbol("records.delete")},ORIGINALCFG:e,checkModelIndexField:function(e){var t=c.METADATA.Model.prototype.CONFIGURATION;if(!t.fields||!t.fields.hasOwnProperty(e))throw new Error('Cannot create index for unrecognized field "'+e+'".');if(null!==t.fields[e]){if(0<=["model","store","entity","function"].indexOf(NGN.typeof(t.fields[e])))throw new Error('Cannot create index for "'+e+'" field. Only basic NGN.DATA.Field types can be indexed. Relationship and virtual fields cannot be indexed.');if("object"===NGN.typeof(t.fields[e])&&0<=["model","store","entity","function"].indexOf(NGN.typeof(NGN.coalesce(t.fields[e].type))))throw new Error('Cannot create index for "'+e+'" field. Only basic NGN.DATA.Field types can be indexed. Relationship and virtual fields cannot be indexed.')}},getModelFieldType:function(e){var t=c.METADATA.Model.prototype.CONFIGURATION;return null===t.fields[e]?NGN.typeof(t.fields[e]):t.fields[e].type?NGN.typeof(t.fields[e].type):t.fields[e].default?NGN.typeof(t.fields[e].default):NGN.typeof(NGN.coalesce(t.fields[e]))},createRecord:function(e,t){var r=this;void 0===t&&(t=!1);var i=new c.METADATA.Model(e);if(!(i instanceof NGN.DATA.Entity))throw new Error('Only a NGN.DATA.Model or JSON object may be used in NGN.DATA.Store#add. Received a "'+NGN.typeof(e)+'" value.');if(!c.METADATA.allowInvalid&&!i.valid&&(NGN.WARN('An attempt to add invalid data to the "'+this.name+'" store was prevented. The following fields are invalid: '+Array.from(i.METADATA.invalidFieldNames.keys()).join(", ")),t||this.emit("record.invalid",i),this.METADATA.errorOnInvalid))throw new Error('Invalid data cannot be added to the "'+this.name+'" store.');if(!c.METADATA.allowDuplicates)for(var n=0;n<this.METADATA.records.length;n++)if(r.METADATA.records[n].checksum===i.checksum){if(NGN.WARN('An attempt to add a duplicate record to the "'+r.name+'" store was prevented.'),t||r.emit("record.duplicate",i),r.METADATA.errorOnDuplicate)throw new Error('Duplicate records are not allowed in the "'+r.name+'" data store.');break}return 0<c.METADATA.lifo&&c.METADATA.records.length+1>c.METADATA.lifo?c.remove(c.METADATA.records.length-1,t):0<c.METADATA.fifo&&c.METADATA.records.length+1>c.METADATA.fifo&&c.remove(0,t),i.on("*",function(){switch(this.event){case"field.invalid":case"field.valid":return c.emit(this.event.replace("field.","record."),i);case"expire":return c.METADATA.autoRemoveExpiredRecords&&c.remove(arguments[0]),void c.emit("record.expired",arguments[0])}}),delete i.METADATA.store,Object.defineProperty(i.METADATA,"store",NGN.get(function(){return c})),0<c.METADATA.expires&&(i.expires=c.METADATA.expires),i},addRecord:function(e,t){var r;void 0===t&&(t=!1);var i=(r=c.PRIVATE).createRecord.apply(r,arguments),n=c.METADATA.records.push(i);return c.PRIVATE.RECORDMAP.set(i.OID,n-1),c.PRIVATE.ACTIVERECORDS.set(i.OID,n-1),c.METADATA.filters.forEach(function(e){return e.exec(i)}),c.emit(c.PRIVATE.EVENT.CREATE_RECORD,i),i},insertRecord:function(e,t,r){if(void 0===t&&(t=0),void 0===r&&(r=!1),(t=t<0?0:t)>c.PRIVATE.RECORDMAP.size)return c.PRIVATE.addRecord(e,r);var i=c.PRIVATE.createRecord(e,r);c.METADATA.records.push(i);var n=c.METADATA.records.length-1,o=Array.from(c.PRIVATE.RECORDMAP);if(0===t)o.unshift([i.OID,n]);else{var s=o.splice(t,o.length,[i.OID,n]);o=o.concat(s)}c.PRIVATE.RECORDMAP=new Map(o);var a=0===t?new Array(0):Array.from(c.PRIVATE.ACTIVERECORDS).filter(function(e){return e[1]<t}),l=Array.from(c.PRIVATE.ACTIVERECORDS);return 0===t&&(l=l.filter(function(e){return e[1]>=t})),c.PRIVATE.ACTIVERECORDMAP=new Map(a.concat([[i.OID,n]],l)),c.METADATA.filters.forEach(function(e){return e.exec(i)}),c.PRIVATE.updateOrderIndex(),c.emit(c.PRIVATE.EVENT.CREATE_RECORD,i),i},updateOrderIndex:function(){var e=Array.from(c.PRIVATE.ACTIVERECORDS);0===e.length?(c.METADATA.FIRSTRECORDINDEX=0,c.METADATA.LASTRECORDINDEX=0):(c.METADATA.FIRSTRECORDINDEX=e[0][1],c.METADATA.LASTRECORDINDEX=e[e.length-1][1])},convertStubToRecord:function(e,t){if(null!==t&&t.hasOwnProperty(c.PRIVATE.STUB)){var r=c.PRIVATE.addRecord(t.metadata,!1);return r.OID=t.OID,c.METADATA.records[e]=r,0<c.METADATA.expires&&(r.expires=this.METADATA.expires),r}if(null==t)throw new Error("Null stub cannot be converted to record.");return t},shouldFilterRecord:function(r){var i=!0;return c.METADATA.filters.forEach(function(e,t){i&&!e.fn(r)&&(i=!1)}),i},forceDataObject:function(e){if(e instanceof c.METADATA.Model)e=e.data;else if("string"===NGN.typeof(e)&&(e=JSON.parse(e)),"object"!=typeof e)throw new Error(NGN.typeof(e)+" is an invalid data type (must be an object conforming to the "+this.METADATA.Model.name+" field configuration).");return e}}),delete:NGN.const(NGN.deprecate(this.remove,"Store.delete is deprecated. Use Store.remove instead."))}),Object.defineProperties(this.PRIVATE,{ACTIVERECORDS:NGN.get(function(){return null===t.PRIVATE.ACTIVERECORDMAP&&(t.PRIVATE.ACTIVERECORDMAP=new Map([].concat(t.PRIVATE.RECORDMAP))),t.PRIVATE.ACTIVERECORDMAP}),FILTEREDRECORDS:NGN.get(function(){return null===t.PRIVATE.FILTEREDRECORDMAP&&(t.PRIVATE.FILTEREDRECORDMAP=new Map),t.PRIVATE.FILTEREDRECORDMAP})}),Object.freeze(this.PRIVATE.EVENT),0<this.METADATA.lifo&&0<this.METADATA.fifo)throw new InvalidConfigurationError("NGN.DATA.Store can be configured to use FIFO or LIFO, but not both simultaneously.");0<this.METADATA.lifo||0<this.METADATA.fifo?(this.METADATA.minRecords=0,this.METADATA.maxRecords=-1):this.METADATA.minRecords=this.METADATA.minRecords<0?0:this.METADATA.minRecords,NGN.coalesce(e.index)&&"object"===NGN.typeof(this.METADATA.Model.prototype.CONFIGURATION.fields)&&this.createIndex(e.index),this.METADATA.autocompact<100&&(this.METADATA.DELETECOUNT=0,this.on(this.PRIVATE.EVENTS.DELETE_RECORD,function(){t.METADATA.DELETECOUNT++,t.METADATA>=t.METADATA.autocompact&&(t.METADATA.DELETECOUNT=0,t.compact())})),NGN.INTERNAL("datastore.created",this)}r&&(e.__proto__=r),(e.prototype=Object.create(r&&r.prototype)).constructor=e;var t={name:{configurable:!0},snapshots:{configurable:!0},history:{configurable:!0},recordCount:{configurable:!0},size:{configurable:!0},length:{configurable:!0},first:{configurable:!0},last:{configurable:!0},data:{configurable:!0},filtered:{configurable:!0},representation:{configurable:!0},auditable:{configurable:!0},model:{configurable:!0},map:{configurable:!0},indexedFieldNames:{configurable:!0}};return t.name.get=function(){return this.METADATA.name},t.name.set=function(e){if(this.METADATA.name!==e){var t=this.METADATA.name;NGN.LABELS.DATASTORES.rename(t,e),this.METADATA.name=e,this.emit("renamed",{old:t,new:e})}},t.snapshots.get=function(){return NGN.coalesce(this.snapshotarchive,[])},t.history.get=function(){return NGN.WARN("history is deprecated. Use NGN.DATA.Store#changelog instead."),this.changelog},t.recordCount.get=function(){return NGN.WARN("recordCount is deprecated. Use NGN.DATA.Store#size instead."),this.size},t.size.get=function(){return this.PRIVATE.ACTIVERECORDS.size},t.length.get=function(){return this.METADATA.records.length},t.first.get=function(){var e=NGN.coalesce(this.METADATA.records[this.METADATA.FIRSTRECORDINDEX]);return this.PRIVATE.convertStubToRecord(this.METADATA.FIRSTRECORDINDEX,e)},t.last.get=function(){var e=NGN.coalesce(this.METADATA.records[this.METADATA.LASTRECORDINDEX]);return this.PRIVATE.convertStubToRecord(this.METADATA.LASTRECORDINDEX,e)},t.data.get=function(){var i=this,e=this.PRIVATE.ACTIVERECORDS;if(0===e.size)return[];var t=this.PRIVATE.convertStubToRecord(this.METADATA.FIRSTRECORDINDEX,this.METADATA.records[this.METADATA.FIRSTRECORDINDEX]);null===this.METADATA.MAP&&(this.METADATA.MAP=NGN.coalesce(t.MAP));var n=null;if(t instanceof NGN.DATA.Entity){var r=t.fieldDefinitions,o=Object.keys(r);n={},o.forEach(function(e){r[e].hidden||r[e].virtual||(n[e]=r[e].default)})}var s=[];return e.forEach(function(e){if(null!==i.METADATA.records[e])if(i.METADATA.records[e].hasOwnProperty(i.PRIVATE.STUB)){var t=Object.assign({},n),r=Object.assign(t,i.METADATA.records[e].metadata);null!==i.METADATA.MAP?s.push(i.METADATA.MAP.applyInverseMap(r)):s.push(r)}else s.push(i.METADATA.records[e].data)}),s},t.filtered.get=function(){var t=this;return Array.from(this.PRIVATE.FILTEREDRECORDS).map(function(e){return t.METADATA.records[e[1]].data})},t.representation.get=function(){var t=this,r=[];return this.PRIVATE.ACTIVERECORDS.forEach(function(e){null!==t.METADATA.records[e]&&r.push(t.METADATA.records[e].representation)}),r},t.auditable.get=function(){return this.METADATA.AUDITABLE},t.auditable.set=function(e){(e=NGN.forceBoolean(e))!==this.METADATA.AUDITABLE&&(this.METADATA.AUDITABLE=e,this.METADATA.AUDITLOG=e?new NGN.DATA.TransactionLog:null)},t.model.get=function(){return this.METADATA.Model},t.model.set=function(e){if(e!==this.METADATA.Model){if("model"!==NGN.typeof(e))throw new InvalidConfigurationError('"'+this.name+'" model could not be set because the value is a '+NGN.typeof(e)+" type (requires NGN.DATA.Model).");this.METADATA.Model=e}},t.map.get=function(){return this.METADATA.MAP},t.indexedFieldNames.get=function(){return this.METADATA.INDEXFIELDS?Array.from(this.METADATA.INDEXFIELDS):[]},e.prototype.add=function(e,t){if(void 0===t&&(t=!1),"array"===NGN.typeof(e)){for(var r=new Array(e.length),i=0;i<e.length;i++)r[i]=this.add(e[i],t);return r}if(0<this.METADATA.maxRecords&&this.METADATA.records.length+1>this.METADATA.maxRecords)throw new Error("Maximum record count exceeded.");var n=this.PRIVATE.addRecord(this.PRIVATE.forceDataObject(e));return this.METADATA.LASTRECORDINDEX=this.METADATA.records.length-1,t||this.emit("record.create",n),n},e.prototype.insertBefore=function(e,t,r){void 0===r&&(r=!1);var i="number"==typeof e?e:this.indexOf(e);if(i<0)throw new NGNMissingRecordError;if(i>=this.METADATA.records.length&&(i=(i=this.METADATA.records.length-1)<0?0:i),"array"===NGN.typeof(t)){for(var n=new Array(t.length),o=t.length-1;0<=o;o--)n[o]=this.insertBefore(i,r);return n}if(0<this.METADATA.maxRecords&&this.METADATA.records.length+1>this.METADATA.maxRecords)throw new Error("Maximum record count exceeded.");var s=this.PRIVATE.insertRecord(this.PRIVATE.forceDataObject(t),i,r);return r||this.emit("record.create",s),s},e.prototype.insertAfter=function(e,t,r){void 0===r&&(r=!1);var i="number"==typeof e?e:this.indexOf(e);if(i<0)throw new NGNMissingRecordError;if(i>=this.METADATA.records.length&&(i=(i=this.METADATA.records.length-1)<0?0:i),"array"===NGN.typeof(t)){for(var n=new Array(t.length),o=t.length-1;0<=o;o--)n[o]=this.insertAfter(i,r);return n}if(0<this.METADATA.maxRecords&&this.METADATA.records.length+1>this.METADATA.maxRecords)throw new Error("Maximum record count exceeded.");var s=this.PRIVATE.insertRecord(this.PRIVATE.forceDataObject(t),i+1,r);return r||this.emit("record.create",s),s},e.prototype.move=function(t,r){if(!(t="symbol"==typeof t||"number"==typeof t?this.getRecord(t):t))throw NGNMissingRecordError("Could not find source record.");if(!(r="symbol"==typeof r||"number"==typeof r?this.getRecord(r):r))throw NGNMissingRecordError("Could not find target record.");if(t!==r){var e=Array.from(this.PRIVATE.ACTIVERECORDS),i=e.findIndex(function(e){return e[0]===t.OID}),n=e.findIndex(function(e){return e[0]===r.OID});return e.splice(n,0,e.splice(i,1)[0]),this.PRIVATE.ACTIVERECORDMAP=new Map([].concat(e)),this.PRIVATE.updateOrderIndex(),this.emit("record.moved",{oldPosition:i,newPosition:n,record:t}),this}},e.prototype.moveToEnd=function(e){return this.move(e,this.PRIVATE.ACTIVERECORDS.size-1)},e.prototype.moveToStart=function(e){return this.move(e,0)},e.prototype.remove=function(e,t){var r=this;if(void 0===t&&(t=!1),0!==this.METADATA.records.length){if("array"===NGN.typeof(e)){for(var i=new Array(e.length),n=0;n<e.length;n++)i[n]=r.remove(e[n]);return i}if(0<this.minRecords&&this.METADATA.records.length-1<this.minRecords)throw new Error("Removing this record would violate the minimum record count.");var o;switch(NGN.typeof(e)){case"number":if(e<0||!this.METADATA.records[e])return NGN.ERROR("Record removal failed (record not found at index "+(e||"undefined").toString()+")."),null;o=e;break;default:if(!(e instanceof NGN.DATA.Entity))return NGN.ERROR("Invalid record value passed to Store.remove() method."),null;e=e.OID;case"symbol":if((o=this.PRIVATE.ACTIVERECORDS.get(e))<0)return NGN.ERROR('Record removal failed. Record OID not found ("'+e.toString()+'").'),null}null===this.PRIVATE.ACTIVERECORDMAP&&(this.PRIVATE.ACTIVERECORDMAP=new Map([].concat(this.PRIVATE.RECORDMAP)));var s=this.METADATA.records[o];if(null===s)return NGN.WARN("Specified record does not exist."),null;var a=this.PRIVATE.ACTIVERECORDS.get(s.OID);if(isNaN(a))return NGN.WARN('Record not found for "'+s.OID.toString()+'".'),null;if(this.PRIVATE.ACTIVERECORDS.delete(s.OID),this.METADATA.softDelete?0<=this.METADATA.softDeleteTtl&&(s.once("expired",function(){r.METADATA.records[r.PRIVATE.RECORDMAP.get(s.OID)]=null,r.PRIVATE.RECORDMAP.delete(s.OID),t||r.emit("record.purge",s)}),s.expires=this.METADATA.softDeleteTtl):(this.METADATA.records[a]=null,this.PRIVATE.RECORDMAP.delete(s.OID)),this.METADATA.LASTRECORDINDEX===a){if(this.PRIVATE.ACTIVERECORDS.size<=1)this.METADATA.LASTRECORDINDEX=this.PRIVATE.ACTIVERECORDS.values().next().value,this.METADATA.FIRSTRECORDINDEX=this.METADATA.LASTRECORDINDEX;else if(0!==a)for(var l=a-1;0<=l;l--){if(0===l){r.METADATA.LASTRECORDINDEX=0;break}var c=r.METADATA.records[l];if(null!==c&&r.PRIVATE.ACTIVERECORDS.has(c.OID)){r.METADATA.LASTRECORDINDEX=r.PRIVATE.ACTIVERECORDS.get(c.OID);break}}}else if(this.METADATA.FIRSTRECORDINDEX===a)for(var u=this.PRIVATE.ACTIVERECORDS.size,A=a+1;A<u;A++){var d=r.METADATA.records[A];if(null!==d&&r.PRIVATE.ACTIVERECORDS.has(d.OID)){r.METADATA.FIRSTRECORDINDEX=r.PRIVATE.ACTIVERECORDS.get(d.OID);break}}return this.emit(this.PRIVATE.EVENT.DELETE_RECORD,s),t||this.emit("record.delete",s),s}NGN.INFO('"'+this.name+'" store called remove(), but the store contains no records.')},e.prototype.restore=function(e){var t="number"==typeof e?e:this.indexOf(e);if(t<0)return null;var r=this.PRIVATE.convertStubToRecord(t,this.METADATA.records[t]);return r?(this.PRIVATE.ACTIVERECORDMAP.has(r.OID)||this.PRIVATE.FILTEREDRECORDS.has(r.OID)?NGN.WARN(this.name+" could not restore the specified record because it already exists amongst the active or filtered records."):(this.PRIVATE.ACTIVERECORDS.set(r.OID,t),this.filter(r),r.removeAllListeners("expired"),this.emit("record.restored",r)),r):null},e.prototype.clone=function(e,t){void 0===e&&(e=null),void 0===t&&(t=!0);var r=Object.assign({},this.PRIVATE.ORIGINALCFG);this.auditable&&(r.audit=!0),"boolean"==typeof e&&(t=e,e=null),r.name=NGN.LABELS.DATASTORES.create(NGN.coalesce(e,this.name));var i=new NGN.DATA.Store(r);return i.METADATA.Model=this.METADATA.Model,this.METADATA.hasOwnProperty("INDEXFIELDS")&&this.METADATA.INDEXFIELDS.forEach(function(e){return i.PRIVATE.createIndex(e)}),i.METADATA.autoRemoveExpiredRecords=this.METADATA.autoRemoveExpiredRecords,i.METADATA.MAP=this.METADATA.MAP,i.auditable=this.auditable,this.METADATA.filters.forEach(function(e){return i.addFilter(e)}),t&&(i.METADATA.records=this.data.slice().concat(this.filtered.slice())),i},e.prototype.split=function(e,t){var r=this;if(void 0===e&&(e=null),void 0===t&&(t=!1),"boolean"==typeof e&&(t=e,e=null),isNaN(e)&&(e=(this.size+(t?this.PRIVATE.FILTEREDRECORDS.size:0))/2),e<0)throw new Error("Cannot split a store into 0 or fewer records.");var i=Array.from(this.PRIVATE.ACTIVERECORDS);t&&(i=i.concat(Array.from(this.PRIVATE.FILTEREDRECORDS)));for(var n=Math.ceil(i.length/e),o=new Array(n),s=0;s<n;s++)o[s]=r.clone(!1),o[s].load(i.splice(0,e).map(function(e){return r.METADATA.records[e[1]]}));return o},e.prototype.splitTo=function(e,t){if(void 0===e&&(e=2),void 0===t&&(t=!1),e<1)throw new Error("Cannot split to less than one division.");var r=this.PRIVATE.ACTIVERECORDS.size;t&&(r+=this.PRIVATE.FILTEREDRECORDS.size);var i=Math.ceil(r/e);return this.split(i,t)},e.prototype.concat=function(){var e,t=this;if(arguments.length<0)return this;if(0===(e=(e="array"===NGN.typeof(arguments[0])?arguments[0]:NGN.slice(arguments)).filter(function(e){return e instanceof NGN.DATA.Store&&e.METADATA.Model===t.METADATA.Model})).length)throw new Error("Cannot concatenate/merge stores with different model types.");var r=new Symbol("store.merge");return this.thresholdOnce(r,e.length,"merge",{sourceStores:e}),e.forEach(function(e){e.once(e.PRIVATE.EVENT.LOAD_RECORDS,function(){return t.emit(r)}),t.load(e.data.concat(includeFiltered?e.filtered:[]))}),this},e.prototype.createIndex=function(e){if("array"!==NGN.typeof(e)){if(this.METADATA.INDEXFIELDS||(this.METADATA.INDEXFIELDS=new Set,this.on([this.PRIVATE.EVENT.CREATE_RECORD,this.PRIVATE.EVENT.DELETE_RECORD,this.PRIVATE.EVENT.LOAD_RECORDS,this.PRIVATE.EVENT.DELETE_RECORD_FIELD,this.PRIVATE.EVENT.CLEAR_RECORDS],this.PRIVATE.INDEX)),!this.METADATA.INDEXFIELDS.has(e)){this.METADATA.INDEX=NGN.coalesce(this.METADATA.INDEX,{}),this.PRIVATE.checkModelIndexField(e),this.METADATA.INDEXFIELDS.add(e);var t=0<=["number","date"].indexOf(this.PRIVATE.getModelFieldType(e));this.METADATA.INDEX[e]=new NGN.DATA.Index(t,e.toUpperCase()+" "+(t?"BTREE ":"")+"INDEX"),0<this.METADATA.records.length&&this.PRIVATE.INDEX.apply({event:this.PRIVATE.EVENT.LOAD_RECORDS}),this.emit("index.created",e)}}else for(var r=0;r<e.length;r++)this.createIndex(e[r])},e.prototype.removeIndex=function(e){if(void 0===e&&(e=null),this.METADATA.INDEXFIELDS)if(null===NGN.coalesce(e)&&(e=this.indexedFieldNames),"array"!==NGN.typeof(e))this.METADATA.INDEXFIELDS.delete(e),delete this.METADATA.INDEX[e],this.emit("index.delete",e),0===this.METADATA.INDEXFIELDS.size&&(this.METADATA.INDEX=null,delete this.METADATA.INDEXFIELDS,this.off([this.PRIVATE.EVENT.CREATE_RECORD,this.PRIVATE.EVENT.DELETE_RECORD,this.PRIVATE.EVENT.LOAD_RECORDS,this.PRIVATE.EVENT.DELETE_RECORD_FIELD],this.PRIVATE.INDEX));else for(var t=0;t<e.length;t++)this.removeIndex(e[t])},e.prototype.getRecordSibling=function(t,e,r){void 0===e&&(e=1),void 0===r&&(r=!1);var i=this.size;if(0===i)return NGN.WARN("Attempted to execute getRecordSibling with no active records."),null;if(Math.abs(e)>i&&(e%=i),1===i||0===e)return t;var n=Array.from(this.PRIVATE.ACTIVERECORDS),o=n.findIndex(function(e){return t.OID===e[0]});if(0===n.length)return NGN.WARN('"'+this.name+'" data store has no active records and '+this.PRIVATE.FILTEREDRECORDS.size+" record"+(1!==this.PRIVATE.FILTEREDRECORDS.size?"s":"")+". record.next() & record.previous() do not iterate through filtered records."),null;if(o<0){var s=Array.from(this.PRIVATE.FILTEREDRECORDS).findIndex(function(e){return t.OID===e[0]});if(s<0)throw new Error("Record not found.");for(var a=0;n.findIndex(function(e){return s===e[1]})<0&&a<n.length;)s++,a++;if(!(a<n.length))return null;o=s}return((o+=e)>=n.length||o<0)&&r&&(0<e?o%=n.length:o=n.length-Math.abs(o)),o<0||o>=n.length?null:this.METADATA.records[n[o][1]]},e.prototype.indexOf=function(e){return"symbol"!=typeof e&&(e=e.OID),NGN.coalesce(this.PRIVATE.RECORDMAP.get(e),-1)},e.prototype.contains=function(e){return this.PRIVATE.ACTIVERECORDS.has("symbol"==typeof e?e:e.OID)},e.prototype.getIndexRecords=function(e,t){if(this.METADATA.INDEX&&this.METADATA.INDEX.hasOwnProperty(e)){for(var r=this.METADATA.INDEX[e].recordsFor(t),i=new Array(r.length),n=0;n<r.length;n++)i[n]=this.METADATA.records[this.PRIVATE.RECORDMAP.get(r[n])];return i}return[]},e.prototype.getRecord=function(e){return void 0===e&&(e=0),"symbol"==typeof e&&(e=this.indexOf(e)),e<0?(NGN.WARN("Cannot retrieve a record for a negative index."),null):e>=this.PRIVATE.RECORDMAP.size?(NGN.WARN("Cannot retrieve a record for an out-of-scope index (index greater than total record count.)"),null):this.PRIVATE.convertStubToRecord(e,this.METADATA.records[Array.from(this.PRIVATE.ACTIVERECORDS)[e][1]])},e.prototype.clear=function(e,t){var r=this;void 0===e&&(e=!0),void 0===t&&(t=!1),this.METADATA.ARCHIVE&&(e?delete this.METADATA.ARCHIVE:this.METADATA.ARCHIVE=this.records),this.METADATA.records=[],this.PRIVATE.RECORDMAP=new Map,this.PRIVATE.ACTIVERECORDMAP=null,this.PRIVATE.FILTEREDRECORDMAP=null,this.METADATA.LASTRECORDINDEX=0,this.METADATA.FIRSTRECORDINDEX=0,this.METADATA.filters.forEach(function(e){return e.purge(r)}),this.METADATA.AUDITABLE&&this.METADATA.AUDITLOG.reset(),this.emit(this.PRIVATE.EVENT.CLEAR_RECORDS),t||this.emit("clear")},e.prototype.clearEvents=function(){r.prototype.clear.apply(this,arguments)},e.prototype.replaceModel=function(e){var t=this;NGN.deprecate(function(){t.model=e},"replaceModel has been deprected. Set the model directly instead.")},e.prototype.snapshot=function(){this.METADATA.snapshotarchive=NGN.coalesce(this.METADATA.snapshotarchive,[]);var e=this.data,t={id:NGN.DATA.UTILITY.GUID(),timestamp:(new Date).toISOString(),checksum:NGN.DATA.UTILITY.checksum(JSON.stringify(e)).toString(),modelChecksums:this.data.map(function(e){return NGN.DATA.UTILITY.checksum(JSON.stringify(e)).toString()}),data:e};return this.METADATA.snapshotarchive.unshift(t),this.emit("snapshot",t),t},e.prototype.clearSnapshots=function(){this.snapshotarchive=null},e.prototype.load=function(e,t,r){var i=this;void 0===t&&(t=!1),void 0===r&&(r=!1);var n,o=new Date;if(this.METADATA.allowDuplicates)for(n=e;0<=n.indexOf(null)||0<=n.indexOf(void 0);)n.splice(NGN.coalesceb(NGN.nullIf(n.indexOf(null),-1),NGN.nullIf(n.indexOf(void 0),-1))-1,1);else{var s=new Set;n=[];for(var a=0;a<e.length;a++)if(e[a])if(s.has(JSON.stringify(e[a]))){if(i.METADATA.errorOnDuplicate)throw new NGNDuplicateRecordError}else s.add(JSON.stringify(e[a])),n.push(e[a])}var l=n.length+this.METADATA.records.length;if(0<this.METADATA.maxRecords&&l>this.METADATA.maxRecords)throw new Error("Maximum record count exceeded.");if(4e6<l)throw new Error("Maximum load size exceeded. A store may contain a maximum of 4M records.");for(var c=this,u=0;u<n.length;u++){var A=void 0;if(n[u]instanceof NGN.DATA.Entity)A=n[u].OID,i.METADATA.records.push(n[u]);else{A=Symbol("model.id");var d={};d[i.PRIVATE.STUB]=!0,d.OID=A,d.metadata=n[u],Object.defineProperty(d,"store",{get:function(){return c}}),i.METADATA.records.push(d)}i.PRIVATE.RECORDMAP.set(A,i.METADATA.records.length-1),i.PRIVATE.ACTIVERECORDS.set(A,i.METADATA.records.length-1)}t?this.filter():this.PRIVATE.updateOrderIndex();var h=new Date;this.emit(this.PRIVATE.EVENT.LOAD_RECORDS);var f={recordCount:this.length,activeRecordCount:this.size,filteredRecordCount:this.length-this.size,loadDuration:h-o,filterDuration:t?endFilter-startFilter:0};return r||this.emit("loaded",f),f},e.prototype.reload=function(e,t){void 0===t&&(t=!1),this.clear(!0),this.METADATA.records=new Array(e.length);var r=this.load(e,t,!1);this.emit("reloaded",r)},e.prototype.reset=function(e){void 0===e&&(e=!1),this.clear(!0,e),this.clearSnapshots(),this.clearFilter(),this.METADATA.filters=new Map},e.prototype.compact=function(){var e=this;if(this.emit("compact.start"),this.METADATA.records.length<100)return this.emit("compact.complete"),void(0!==this.METADATA.records.length&&NGN.WARN("compact() called on "+this.name+" with fewer than 100 elements."));for(var t=[],r=[],i=0,n=0;n<this.METADATA.records.length;n++)null===e.METADATA.records[n]?(i++,0===r.length&&r.push(n)):(0<i&&(e.PRIVATE.RECORDMAP.set(e.METADATA.records[n].OID,n-i),e.METADATA.FIRSTRECORDINDEX===n&&(e.METADATA.FIRSTRECORDINDEX=n-i),e.METADATA.LASTRECORDINDEX===n&&(e.METADATA.LASTRECORDINDEX=n-i)),1===r.length&&(r.push(n-1),t.push(r),r=[]));for(i=0;0<t.length;)e.METADATA.records.splice(t[0][0]-i,t[0][1]-t[0][0]+1),i+=t[0][1]-t[0][0]+1,t.shift();this.PRIVATE.ACTIVERECORDMAP=null,this.emit("compact.complete")},e.prototype.forEach=function(i){var n=this;if(!NGN.isFn(i))throw new Error("A "+NGN.typeof(i)+" was applied to "+this.name+"'s each() method when a function was expected.");this.PRIVATE.ACTIVERECORDS.forEach(function(e,t,r){i(n.METADATA.records[e])})},e.prototype.addFilter=function(e,t){return e instanceof NGN.DATA.Filter?e=(t=e).name:NGN.isFn(e)&&(e=t=new NGN.DATA.Filter(e,t)),t instanceof NGN.DATA.Filter||(t=new NGN.DATA.Filter(e,t)),this.METADATA.filters.set(t.name,t),this.emit("filter.create",t),t},e.prototype.filter=function(){var r=this;if(0===this.METADATA.filters.size)return this;var i=Array.from(arguments);return this.METADATA.filters.forEach(function(t,e){i[0]instanceof NGN.DATA.Entity?t.exec(i[0]):(0===i.length||0<=i.indexOf(e))&&(console.log(">> Filtering "+r.name+" with "+t.name+":"),r.PRIVATE.ACTIVERECORDS.forEach(function(e){console.log("Retain?",t.exec(r.PRIVATE.convertStubToRecord(e,r.METADATA.records[e])))}))}),this},e.prototype.clearFilter=function(){return 0===arguments.length?(this.PRIVATE.ACTIVERECORDMAP=new Map(this.PRIVATE.ACTIVERECORDS.concat(this.PRIVATE.FILTEREDRECORDS)),this.PRIVATE.FILTEREDRECORDMAP=null,this.METADATA.filters.forEach(function(e){e.purge()})):Array.from(arguments).forEach(function(e){e.clear()}),this},e.prototype.removeFilter=function(){var t=this,e=Array.from(arguments);return 0===e.length?(this.PRIVATE.ACTIVERECORDMAP=new Map(this.PRIVATE.ACTIVERECORDS.concat(this.PRIVATE.FILTEREDRECORDS)),this.PRIVATE.FILTEREDRECORDMAP=null,this.METADATA.filters.forEach(function(e){e.destroy(t)})):e.forEach(function(e){t.METADATA.filters.get(e).destroy(t)}),this},e.prototype.disableFilter=function(){var t=new Set(Array.from(arguments));return this.METADATA.filters.forEach(function(e){(0===t.size||t.has(e.name))&&e.disable()}),this},e.prototype.enableFilter=function(){var t=new Set(Array.from(arguments));return this.METADATA.filters.forEach(function(e){(0===t.size||t.has(e.name))&&e.enable()}),this},Object.defineProperties(e.prototype,t),e}(i),_=NGN.deprecate(R,"NGN.DATA.util is now NGN.DATA.UTILITY"),q=Object.freeze({UTILITY:R,util:_,TransactionLog:I,Rule:O,RangeRule:x,Field:C,VirtualField:S,Relationship:P,FieldMap:L,Model:function(i){if("object"!==NGN.typeof(i))throw new Error("Model must be configured.");var n=this,e=function(e,t){void 0===t&&(t=!1);var r=new NGN.DATA.Entity(i);return Object.defineProperty(r,"ENTITY",{enumerable:!1,get:function(){return n}}),e&&r.load(e,t),r};return Object.defineProperty(e.prototype,"CONFIGURATION",NGN.const(i)),Object.defineProperty(e.prototype,"ENTITY",{enumerable:!1,get:function(){return n}}),e},Entity:k,Index:F,Store:U,BTree:G,Filter:j});n.extend("EventEmitter",n.public(i)),n.extend("BUS",n.const(new n.EventEmitter)),n.extend("Task",n.const(o)),n.extend("Queue",n.const(s)),n.extend("Tasks",n.deprecate(n.Queue,"NGN.Tasks is now NGN.Queue")),n.extend("NET",n.const(g)),n.extend("UTILITY",n.const(d)),n.extend("DATA",n.const(q))}();
//# sourceMappingURL=ngn2.js.map
