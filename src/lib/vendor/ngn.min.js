!function(){"use strict";class e extends Error{constructor(e){super(),Object.defineProperty(this,"frameFilter",NGN.privateconst(e=>NGN.nodelike?e.getFileName()!==__filename&&e.getFileName():e.getFileName())),(e="string"==typeof(e=e||{})?{message:e}:e).custom=e.custom||{};let t=this;this.name=e.name||"NgnError",this.type=e.type||"TypeError",this.severity=e.severity||"minor",this.message=e.message||"Unknown Error",this.category=e.category||"operational",this.name=this.name.replace(/[^a-zA-Z0-9_]/gi,"");for(let t in e.custom)e.custom.hasOwnProperty(t)&&(this[t]=e.custom[t]);if(this.hasOwnProperty("custom")&&delete this.custom,NGN.nodelike||Error.prepareStackTrace){Error.prepareStackTrace=function(e,t){return t};let e=new Error;Error.captureStackTrace(e,this),this.rawstack=e.stack,Error.prepareStackTrace=function(e,i){return t.cause&&console.warn(t.cause),t.help&&console.info(t.help),`${t.name}: ${t.message}\n`+i.filter(t.frameFilter).map(e=>`    at ${e}`).join("\n")},Error.captureStackTrace(this)}}get trace(){return this.rawstack.filter(this.frameFilter).map(e=>({filename:e.getFileName(),line:e.getLineNumber(),column:e.getColumnNumber(),functionname:e.getFunctionName(),native:e.isNative(),eval:e.isEval(),type:e.getTypeName()}))}}let t,i=Object.defineProperties({get global(){try{return window}catch(e){return global}}},{define:{enumerable:!1,writable:!1,configurable:!1,value:function(e,t,i,s){return{enumerable:e,writable:t,configurable:i,value:s}}}});Object.defineProperties(i,{public:i.define(!1,!1,!1,function(e){return i.define(!0,"function"!=typeof e,!1,e)}),private:i.define(!1,!1,!1,function(e){return i.define(!1,"function"!=typeof e,!1,e)}),const:i.define(!1,!1,!1,function(e){return i.define(!0,!1,!1,e)}),privateconst:i.define(!1,!1,!1,function(e){return i.define(!1,!1,!1,e)}),get:i.define(!1,!1,!1,function(e){return{enumerable:!1,get:e}}),set:i.define(!1,!1,!1,function(e){return{enumerable:!1,set:e}}),getset:i.define(!1,!1,!1,(e,t)=>({enumerable:!1,get:e,set:t})),LEDGER_EVENT:i.define(!1,!1,!1,e=>(function(){i.BUS.emit(e,...arguments)}))}),Object.defineProperties(i,{extend:i.privateconst(function(e,t){"object"==typeof e?Object.defineProperties(this,e):Object.defineProperty(this,e,t)}),inherit:i.const(function(e=null,t=null){if(e&&t){e="function"==typeof e?e.prototype:e,t="function"==typeof t?t.prototype:t,Object.getOwnPropertyNames(e).forEach(function(i){const s=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,s)}),Object.getOwnPropertyNames(Object.getPrototypeOf(e)).filter(e=>"constructor"!==e.trim().toLowerCase()&&!t.hasOwnProperty(e)).forEach(s=>{void 0===Object.getOwnPropertyDescriptor(e,s)&&"function"==typeof e[s]&&Object.defineProperty(t,s,i.public(function(){return e[s].apply(this,arguments)}))})}}),slice:i.private(function(e){return Array.prototype.slice.call(e)}),splice:i.private(function(e){return Array.prototype.splice.call(e)}),nullIf:i.public(function(e,t=""){try{if(e!==t){if(typeof e!=typeof t)return e;if("string"==typeof e&&e.trim()!==t.trim())return e}return null}catch(e){return null}}),nullif:i.public(function(){return this.nullIf(...arguments)}),converge:i.private(function(){if(arguments.length<2)return null;if(2===arguments.length)return void 0===arguments[1]?null:arguments[0]?i.nullIf(arguments[1]):arguments[1];for(let e=1;e<arguments.length;e++)if(void 0!==arguments[e]&&null!==(arguments[0]?i.nullIf(arguments[e]):arguments[e])&&void 0!==arguments[e])return arguments[e];return null}),coalesce:i.public(function(){return i.converge(!1,...arguments)}),coalesceb:i.public(function(){return i.converge(!0,...arguments)}),nodelike:i.const(void 0!==i.global.process),dedupe:i.const(e=>{let t=[];for(let i=0;i<e.length;i++)e.indexOf(e[i])===i&&t.push(e[i]);return e=null,t}),typeof:i.const(e=>{if(void 0===e)return"undefined";if(null===e)return"null";let t=Object.prototype.toString.call(e).split(" ")[1].replace(/[^A-Za-z]/gi,"").toLowerCase();if("function"===t){if(!e.name)return i.coalesceb(e.toString().replace(/\n/gi,"").replace(/^function\s|\(.*$/gim,"").toLowerCase(),"function");t=i.coalesceb(e.name,"function")}return t.toLowerCase()}),forceArray:i.const(e=>null===e?[]:"array"===i.typeof(e)?e:[e]),forceBoolean:i.const(e=>{switch(i.typeof(e)){case"boolean":return e;case"number":return 0!==e;case"string":return"false"!==(e=e.trim().toLowerCase());default:return null!==i.coalesceb(e)}}),forceNumber:i.const((e,t=null)=>{try{switch(i.typeof(e)){case"boolean":return e?1:0;case"number":return e;case"date":return e.getTime();case"string":return null!==t?parseInt(e,t):parseFloat(e);default:return NaN}}catch(e){return i.ERROR(e),NaN}}),processStackItem:i.privateconst(function(e,t){return e.replace(/at.*\(|\)/gi,"").replace(t,"./").replace(/\/{2,100}/gi,"/").trim().split(":")}),stack:i.get(function(){(new Error).stack.split("\n");let e=(new Error).stack.split("\n")||[],t=/at.*\(/gi;return 0!==(e=e.filter(e=>e.split(":").length>1).map(e=>{let i=t.exec(e);return i&&(i=i[0].replace(/^at\s{1,100}|\s{1,100}\($/gi,"").replace("<anonymous>","console")),this.nodelike?{path:(e=this.processStackItem(e.toString(),process.cwd())).join(":").replace("./",process.cwd()+"/"),file:e[0].substr(0,e[0].length),line:parseInt(e[1],10),column:parseInt(e[2],10),operation:i}:{path:(e=this.processStackItem(e.toString(),window.location.origin))[0].substr(1,e[0].length-1)+":"+e[1]+":"+e[2],file:e[0].substr(1,e[0].length-1),line:parseInt(e[1],10),column:parseInt(e[2],10),operation:i}})).length?this.nodelike?e.reverse():e:[{path:"unknown",file:"unknown",line:0,column:0}]}),isFn:i.privateconst(e=>"function"==typeof e),wrap:i.privateconst(function(e,t){return function(){e(...arguments),t(...arguments)}}),wrapClass:i.privateconst(function(e,t){return function(){return e(...arguments),new t(...arguments)}}),deprecate:i.privateconst(function(e,t="The method has been deprecated."){return this.wrap(()=>i.WARN("DEPRECATED.METHOD",t),e)}),deprecateClass:i.privateconst(function(e,t="The class has been deprecated."){return this.wrapClass(()=>i.WARN("DEPRECATED.CLASS",t),e)}),needs:i.private(function(){let e=i.getObjectMissingPropertyNames(i,...arguments);if(0!==e.length&&e.length>0)throw new MissingNgnDependencyError(`Missing NGN dependencies: ${e.join(", ")}`.replace(/\s{2,100}/gi," "))}),getObjectMissingPropertyNames:i.private(function(){let e=[],t=Object.keys(arguments[0]);for(let i=1;i<arguments.length;i++)t.indexOf(arguments[i])<0&&e.push(arguments[i]);return e}),getObjectExtraneousPropertyNames:i.private(function(){let e=Object.keys(arguments[0]);for(let t=1;t<arguments.length;t++){let i=e.indexOf(arguments[t]);i>=0&&e.splice(i,1)}return e}),objectHasAll:i.const(function(){let e=Object.keys(arguments[0]);for(let t=1;t<arguments.length;t++)if(e.indexOf(arguments[t])<0)return!1;return!0}),objectHasAny:i.const(function(){let e=Object.keys(arguments[0]);for(let t=1;t<arguments.length;t++)if(e.indexOf(arguments[t])>=0)return!0;return!1}),objectHasExactly:i.const(function(){if(0!==this.getObjectMissingPropertyNames(arguments[0]).length)return!1;let e=Object.keys(arguments[0]),t=i.slice(arguments);t.shift();for(let i=0;i<e.length;i++)if(t.indexOf(e[i])<0)return!1;for(let i=0;i<t.length;i++)if(e.indexOf(t[i])<0)return!1;return!0}),objectRequires:i.const(function(){let e=this.objectHasAll(...arguments);if(!e)throw new Error(`${arguments[0].constructor.name} is missing the following attributes: ${e.missing.join(", ")}`)}),createAlias:i.private(function(e,t,s){Object.defineProperty(e,t,i.get(()=>s))}),WARNING_EVENT:i.privateconst(Symbol("NGN.WARN")),WARN:i.privateconst(e=>i.LEDGER_EVENT(i.WARNING_EVENT)(e)),INFO_EVENT:i.privateconst(Symbol.for("NGN.INFO")),INFO:i.privateconst(e=>i.LEDGER_EVENT(i.INFO_EVENT)(e)),ERROR_EVENT:i.privateconst(Symbol.for("NGN.ERROR")),ERROR:i.privateconst(e=>i.LEDGER_EVENT(i.ERROR_EVENT)(e)),createException:i.const(function(t){(t="string"==typeof(t=t||{})?{message:t}:t).name=t.name||"NgnError",i.global[t.name]=function(){return arguments.length>0&&(t.message=arguments[0]),new e(t)}}),getType:i.const(function(e,t){switch(e.trim().toLowerCase()){case"number":return Number;case"regex":i.WARN("regex is not a valid JavaScript type. Using regexp instead.");case"regexp":return RegExp;case"boolean":return Boolean;case"symbol":return Symbol;case"date":return Date;case"array":return Array;case"object":return Object;case"function":return Function;case"string":return String;default:return t||void 0}})}),i.createException({name:"MissingNgnDependencyError",type:"MissingNgnDependencyError",severity:"critical",message:"An NGN dependency is missing or could not be found.",category:"programmer",custom:{help:"Include the missing library.",cause:"A required dependency was not included, or it was not included in the correct sequence."}}),i.createException({name:"ReservedWordError",type:"ReservedWordError",severity:"critical",message:"An attempt to use a reserved word failed.",category:"programmer",custom:{help:"Use an alternative word.",cause:"A word was used to define an attribute, method, field, or other element that already exists."}}),i.createException({name:"InvalidConfigurationError",type:"InvalidConfigurationError",severity:"critical",message:"Invalid configuration.",category:"programmer",custom:{help:"See the documentation for the proper configuration.",cause:"The configuration specified was marked as invalid or caused an error during instantiation."}}),i.global.NGN=i;t=class{constructor(e){e=e||{},Object.defineProperties(this,{handlers:NGN.private({}),adhoc:NGN.private({}),maxlisteners:NGN.private(e.defaultMaxListeners||25)})}get subscribers(){let e={};for(let t in this.handlers)e[t]={handler:this.handlers[t].length,adhoc:0};for(let t in this.adhoc)e[t]=e[t]||{handler:0},e[t].adhoc=this.adhoc[t].length;return e}get defaultMaxListeners(){return this.maxlisteners}set defaultMaxListeners(e){this.maxlisteners=e}listenerCount(e){return(this.handlers[e]||[]).length+(this.adhoc[e]||[]).length}getMaxListeners(){return this.defaultMaxListeners}setMaxListeners(e){this.defaultMaxListeners=e}eventNames(){let e=Object.keys(this.handlers),t=Object.keys(this.adhoc);return NGN.dedupe(e.concat(t))}listeners(e){let t=this.handlers[e]||[],i=this.adhoc[e]||[];return t.concat(i)}addListener(e,t){if("object"==typeof e)return this.pool(e);if(this.handlers[e]=this.handlers[e]||[],this.handlers[e].unshift(t),this.emit("newListener",e,t),this.listenerCount(e)>this.maxlisteners)throw new Error("Maximum event listeners exceeded. Use setMaxListeners() to adjust the level.")}prependListener(e,t){if("object"==typeof e)return this.pool(e);if(this.handlers[e]=this.handlers[e]||[],this.handlers[e].push(t),this.emit("newListener",e,t),this.listenerCount(e)>this.maxlisteners)throw new Error("Maximum event listeners exceeded. Use setMaxListeners() to adjust the level.")}once(e,t){if(this.adhoc[e]=this.adhoc[e]||[],this.adhoc[e].push(t),this.emit("newListener",e,t),this.listenerCount(e)>this.maxlisteners)throw new Error("Maximum event listeners exceeded. Use setMaxListeners() to adjust the level.")}prependOnceListener(e,t){if(this.adhoc[e]=this.adhoc[e]||[],this.adhoc[e].unshift(t),this.emit("newListener",e,t),this.listenerCount(e)>this.maxlisteners)throw new Error("Maximum event listeners exceeded. Use setMaxListeners() to adjust the level.")}removeListener(e,t){this.deleteEventHandler("handlers",e,t),this.deleteEventHandler("adhoc",e,t)}deleteEventHandler(e,t,i){let s=this[e];if(s[t]){if(!i)return void delete s[t];let e=[];if(s[t].forEach(t=>{t.toString()!==i.toString()&&e.push(t)}),0===e.length)return void delete s[t];s[t]=e}}removeAllListeners(e=null){null!==e?(delete this.handlers[e],delete this.adhoc[e]):(this.handlers={},this.adhoc={})}emit(){let e=NGN.slice(arguments);const t=e.shift(),i=this.getAllEvents(t);"symbol"==typeof t&&i.push(t);let s={event:t};for(let t=0;t<i.length;t++){let r=this.adhoc[i[t]];if(r)for(delete this.adhoc[i[t]];r.length>0;){let t=r.pop();s.handler=t,t.apply(s,e)}let n=this.handlers[i[t]];if(n)for(let t=0;t<n.length;t++)s.handler=n[t],n[t].apply(s,e)}}getAllEvents(e){const t=Object.keys(this.handlers),i=Object.keys(this.adhoc);let s=NGN.dedupe(t.concat(i));return s=s.filter(function(t){return t===e||("regexp"===NGN.typeof(t)||t.indexOf("*")>=0)&&("regexp"!==NGN.typeof(t)&&(t=new RegExp(t.replace(/\./g,"\\.").replace(/\*/g,".*"),"g")),t.test(e))})}};class s extends t{constructor(){super(),Object.defineProperties(this,{META:NGN.private({queued:{},collectionQueue:{},thresholdQueue:{},defaultTTL:-1,wildcardEvents:new Set}),setTTL:NGN.const((e=-1)=>{0!==e?this.META.defaultTTL=e:NGN.WARN("NGN.EventEmitter#TTL cannot be 0.")}),off:NGN.public((e,t)=>{if("array"===NGN.typeof(e)){for(let i=0;i<e.length;i++)this.off(e[i],t);return}let i=this.listeners(e);if(!NGN.isFn(t))return this.clear(e);let s=this.wrapEventHandlerWithScope(e,t);if(i.indexOf(s)<0){for(let t=0;t<i.length;t++)if(i[t].toString()===s.toString()){this.META.wildcardEvents.delete(e),this.removeListener(e,i[t],!1);break}}else this.META.wildcardEvents.delete(e),this.removeListener(e,t)}),deprecate:NGN.const((e,t)=>{const i=this;this.on(e,function(){if(NGN.WARN(`${e} is deprecated. `+(t?`Use ${t} instead.`:"")),t){let e=NGN.slice(arguments);e.shift(),e.unshift(t),i.emit.apply(i,e)}})}),pool:NGN.privateconst(function(e,t){"string"!=typeof e&&(t=e,e="");let i={};for(let s in t){let r=`${NGN.coalesce(e,"")}${s}`;NGN.isFn(t[s])?(this.increaseMaxListeners(),i[s]=this.on(r,t[s])):"object"==typeof t[s]?this.pool(`${r}.`,t[s]):NGN.WARN(`${r} could not be pooled in the event emitter because it's value is not a function.`)}}),attach:NGN.const(function(e,t){return t=NGN.coalesce(t,!1),i=>{t&&!NGN.nodelike&&i.preventDefault(),this.emit(e,...arguments)}}),increaseMaxListeners:NGN.private((e=1)=>{this.setMaxListeners(this.getMaxListeners()+e)}),decreaseMaxListeners:NGN.private((e=1)=>{this.setMaxListeners(this.getMaxListeners()-e)}),forward:NGN.const(function(e,t,i){t=NGN.forceArray(t);let s=this,r=function(){let e=NGN.slice(arguments);i&&e.push(i),s.emit(t,...e)};return this.increaseMaxListeners(),this.on(e,r),{remove:()=>{this.decreaseMaxListeners(),this.off(e,r)}}}),relay:NGN.const(function(e,t,i=null,s=null){let r=NGN.forceArray(e);for(let e=0;e<r.length;e++){let n=r[e];this.on(n,function(){"symbol"===NGN.typeof(this.event)?(null===i&&null===s||NGN.INFO("Cannot relay a symbol-based event with a prefix/postfix."),t.emit(...arguments)):t.emit(`${NGN.coalesce(i,"")}${this.event}${NGN.coalesce(s,"")}`,...arguments)})}}),relayOnce:NGN.const(function(e,t,i=null,s=null){let r=NGN.forceArray(e);for(let e=0;e<r.length;e++){let n=r[e];this.once(n,function(){"symbol"===NGN.typeof(this.event)?(null===i&&null===s||NGN.INFO("Cannot relay a symbol-based event with a prefix/postfix."),t.emit(...arguments)):t.emit(`${NGN.coalesce(i,"")}${this.event}${NGN.coalesce(s,"")}`,...arguments)})}}),delayEmit:NGN.const(function(e,t){if(!this.META.queued.hasOwnProperty(e)){let i=NGN.slice(arguments);i.splice(1,1),this.META.queued[e]=setTimeout(()=>{delete this.META.queued[e],this.emit(...i)},t)}}),getInternalCollectionId:NGN.privateconst(function(e){return Symbol(e)}),handleCollectionTrigger:NGN.privateconst(function(e,t){let i=this;return function(){setTimeout(()=>{let s=i.META.collectionQueue;s[t]&&(s[t].remainingqueue.delete(e),0===s[t].remainingqueue.size&&(s[t].remainingqueue=s[t].masterqueue,NGN.isFn(s[t].eventName)?s[t].eventName(s[t].payload):i.emit(s[t].eventName,s[t].payload)))},0)}}),funnel:NGN.const((e,t,i=null)=>{if("array"!==NGN.typeof(e))throw new Error(`NGN.BUS.funnel expected an array of events, but received a(n) ${NGN.typeof(e)}`);let s=new Set(e),r=this.getInternalCollectionId(this.META.collectionQueue);return this.META.collectionQueue[r]={},Object.defineProperties(this.META.collectionQueue[r],{masterqueue:NGN.const(new Set(e)),remainingqueue:NGN.private(s),eventName:NGN.const(t),remove:NGN.const(()=>{this.META.collectionQueue[r].masterqueue.forEach(e=>{this.off(e,this.handleCollectionTrigger(e,r))}),this.decreaseMaxListeners(this.META.collectionQueue[r].masterqueue.size),delete this.META.collectionQueue[r]}),payload:NGN.const(i)}),this.increaseMaxListeners(s.size),s.forEach(e=>{this.on(e,this.handleCollectionTrigger(e,r))}),this.META.collectionQueue[r]}),funnelOnce:NGN.const((e,t,i=null)=>{let s=`::NGNFUNNEL::${(new Date).getTime()}::${t}`,r=this.funnel(e,s,i);this.increaseMaxListeners(),this.once(s,()=>{r.remove(),r=null,this.emit(t,i)})}),threshold:NGN.const(function(e,t,i,s=null){if("string"!=typeof e)throw new Error("The threshold event name must be a string (received "+typeof e+")");let r=this.getInternalCollectionId(this.META.thresholdQueue);return this.META.thresholdQueue[r]={},Object.defineProperties(this.META.thresholdQueue[r],{key:NGN.const(r),eventName:NGN.const(e),limit:NGN.const(t),count:NGN.private(0),finalEventName:NGN.const(i),remove:NGN.const(()=>{let e=this.META.thresholdQueue[r].eventName;delete this.META.thresholdQueue[r],this.decreaseMaxListeners(),this.off(e,this.handleThresholdTrigger(r))}),payload:NGN.const(s)}),this.increaseMaxListeners(),this.on(e,this.handleThresholdTrigger(r)),this.META.thresholdQueue[r]}),thresholdOnce:NGN.const(function(e,t,i,s=null){let r=`::NGNTHRESHOLD::${(new Date).getTime()}::${i}`,n=this.threshold(e,t,r,s);this.once(r,()=>{n.remove(),n=null,this.emit(i,s)})}),handleThresholdTrigger:NGN.const(function(e){let t=this;return function(){setTimeout(()=>{t.META.thresholdQueue.hasOwnProperty(e)&&(t.META.thresholdQueue[e].count++,t.META.thresholdQueue[e].count===t.META.thresholdQueue[e].limit&&(NGN.isFn(t.META.thresholdQueue[e].finalEventName)?t.META.thresholdQueue[e].finalEventName(t.META.thresholdQueue[e].payload):t.emit(t.META.thresholdQueue[e].finalEventName,t.META.thresholdQueue[e].payload),t.META.thresholdQueue.hasOwnProperty(e)&&(t.META.thresholdQueue[e].count=0)))},0)}}),wrapEventHandlerWithScope:NGN.privateconst((e,t)=>{if(!NGN.nodelike)return t;const i=t;return function(){let t=arguments;"symbol"==typeof t[t.length-1]&&(e=t[t.length-1].toString().replace(/Symbol\(|\)/gi,""),(t=NGN.slice(t)).pop()),i.apply({event:e},t)}}),applyScope:NGN.privateconst(e=>{NGN.nodelike&&e.length>1&&(e[e.length-1].listener?e[e.length-1].listener=this.wrapEventHandlerWithScope(e[0],e[e.length-1].listener):e[e.length-1]=this.wrapEventHandlerWithScope(e[0],e[e.length-1]))})})}clear(){let e=NGN.slice(arguments);if(0===e.length){this.META.wildcardEvents.clear();let e=[];e=NGN.nodelike?Object.getOwnPropertySymbols(this._events):(e=Object.getOwnPropertySymbols(this.adhoc)).concat(Object.getOwnPropertySymbols(this.handlers));for(let t=0;t<e.length;t++)this.removeAllListeners(e[t]);return this.removeAllListeners()}for(let t=0;t<e.length;t++)this.META.wildcardEvents.delete(e[t]),this.removeAllListeners(e[t])}eventHandler(e,t,i,s=!1){return"boolean"===NGN.typeof(i)&&(s=i,i=this.META.defaultTTL),void 0===i&&(i=this.META.defaultTTL),i>0&&setTimeout(()=>this.off(e,t),i),"string"==typeof e&&e.indexOf("*")>=0&&this.META.wildcardEvents.add(e),s}on(e,t,i,s=!1){if("array"!==NGN.typeof(e))this.eventHandler(...arguments)?this.prependListener(e,t):this.addListener(e,t);else for(let r=0;r<e.length;r++)this.on(e[r],t,i,s)}once(e,t,i,s=!1){if("array"!==NGN.typeof(e))this.eventHandler(...arguments)?this.prependOnceListener(e,t):super.once(e,this.wrapEventHandlerWithScope(e,t));else for(let r=0;r<e.length;r++)this.once(e[r],t,i,s)}prependListener(){this.applyScope(arguments),super.prependListener(...arguments)}prependOnceListener(){this.applyScope(arguments),super.prependOnceListener(...arguments)}addListener(){this.applyScope(arguments),super.addListener(...arguments)}removeListener(){!0!==arguments[arguments.length-1]&&this.applyScope(arguments),super.removeListener(...arguments)}emit(){if("array"===NGN.typeof(arguments[0])){let e=NGN.slice(arguments),t=e.shift();for(let i=0;i<t.length;i++)this.emit(t[i],...e);return}if(!NGN.nodelike||!arguments[0]||0===this.META.wildcardEvents.size)return void super.emit(...arguments);if(NGN.nodelike&&"symbol"==typeof arguments[0])return void super.emit(...arguments);let e=this.META.wildcardEvents.values(),t=null,i=NGN.slice(arguments);for(i.shift();null===t||!t.done;){if(null!==t&&t.value!==arguments[0]){if(new RegExp(t.value.replace(/\./g,"\\.").replace(/\*/g,".*"),"g").test(arguments[0])){super.emit(t.value,...i,"symbol"!=typeof arguments[0]?Symbol(arguments[0]):arguments[0]);break}}t=e.next()}}}var r=Object.freeze({Lexer:class{constructor(e=""){Object.defineProperties(this,{tokens:NGN.private([]),rules:NGN.private([]),remove:NGN.private(0),state:NGN.private(0),index:NGN.private(0),statement:NGN.private(e),reject:NGN.private(!1),lastLineIndex:NGN.private(0),currentLength:NGN.private(0),currentMatch:NGN.private(null),row:NGN.private(1),unrecognizedCharacters:NGN.private(!1)}),this.addRule(/^/,function(){return"BOF"}),this.addRule(/$/,function(){return"EOF"}),e&&e.length>0&&(this.input=e)}set input(e){this.remove=0,this.state=0,this.index=0,this.currentMatch=null,this.tokens=[],this.row=1,this.statement=e}get input(){return this.statement}get lines(){return this.statement.split("\n").length}get unrecognized(){return this.unrecognizedCharacters}set unrecognized(e){this.reject=!0,this.unrecognizedCharacters=NGN.forceBoolean(e)}get currentLine(){return this.row}get currentColumn(){let e=this.index-this.lastLineIndex-this.currentLength;return 0===e?1:e}error(e){if(e){let t=this.index-this.lastLineIndex-1;throw new Error(`${e} at line ${this.currentLine}, column ${t<1?1:t}.`)}this.unrecognized=!0}addRule(e,t,i=[0]){if(!e.global){let t="g";e.multiline&&(t+="m"),e.ignoreCase&&(t+="i"),e=new RegExp(e.source,t)}let s;if(s="string"==typeof t?function(){return t}:t,!NGN.isFn(s))throw new Error(`INVALID LEXER ATTRIBUTES: ${e.toString()} rule is missing a valid handler function (action) or token name.`);let r=s.toString();if(r.indexOf("this.error(")>=0&&/^\(.*\)\s{0,10}=>\s{0,10}\{/.test(r))throw new Error("Cannot use a non-lexical expression (arrow function) as a lexer rule.");this.rules.push({pattern:e,global:e.global,action:s,start:i})}next(){if(this.tokens.length)return this.tokens.shift();for(this.reject=!0;this.index<=this.statement.length;){/\n/i.test(this.statement.charAt(this.index))&&(this.row++,this.lastLineIndex=this.index);let e=this.scan().splice(this.remove),t=this.index;for(;e.length&&this.reject;){let t=e.shift(),i=t.result,s=t.length;this.index+=s,this.currentLength=s,this.reject=!1,this.remove++;let r=t.action.apply(this,i);if(this.reject)this.index=i.index;else if(void 0!==r)switch(NGN.typeof(r)){case"array":this.tokens=r.slice(1),r=r[0];default:return s&&(this.remove=0),r}}let i=this.statement;if(t<i.length)if(this.reject){this.remove=0;let e=this.unexpected(i.substr(this.index++,this.index+i.length));if(void 0!==e)return"array"===NGN.typeof(e)?(this.tokens=e.slice(1),e[0]):e}else this.index!==t&&(this.remove=0),this.reject=!0;else{if(!e.length)break;this.reject=!0}}}scan(){let e=[],t=0,i=this.state,s=this.index,r=this.statement;for(let n=0,a=this.rules.length;n<a;n++){let a=this.rules[n],o=a.start,l=o.length;if(!l||o.indexOf(i)>=0||i%2&&1===l&&!o[0]){let i=a.pattern;i.lastIndex=s;let n=i.exec(r);if(n&&n.index===s){let i=e.push({result:n,action:a.action,length:n[0].length});for(a.global&&(t=i);--i>t;){let t=i-1;if(e[i].length>e[t].length){let s=e[i];e[i]=e[t],e[t]=s}}}}}return e}unexpected(e){if(this.unrecognizedCharacters){let t=this.index-this.lastLineIndex-1;throw new Error(`Unexpected syntax at line ${this.currentLine}, column ${t<1?1:t}\nat ${e}\n   ^`)}}},Tokenizer:class{constructor(e=[]){if(0===e.length)throw new Error("No grammaer rules specified.");Object.defineProperties(this,{statement:NGN.private(null),rules:NGN.privateconst(e),PROTECTED:NGN.privateconst({lexer:new NGN.UTILITY.Lexer,activeText:null,orderedList:new Set})});for(let e=0;e<this.rules.length;e++)this.PROTECTED.lexer.addRule(this.rules[e][0],this.rules[e][1]);return this}get text(){return this.PROTECTED.activeText}get orderedTokenList(){return Array.from(this.PROTECTED.orderedList).map(e=>e.detail)}parse(e,t=!0){if(!NGN.coalesce(e)||"string"!=typeof e)throw new Error("Cannot parse empty string or non-string.");this.PROTECTED.activeText=e;let i,s={};for(this.PROTECTED.lexer.input=e,this.PROTECTED.orderedList.clear();i=this.PROTECTED.lexer.next();)if(!t||"BOF"!==i&&"EOF"!==i){s[i]=NGN.coalesce(s[i],[]),s[i].push({line:this.PROTECTED.lexer.currentLine,column:this.PROTECTED.lexer.currentColumn,length:this.PROTECTED.lexer.currentLength,index:this.PROTECTED.lexer.index-this.PROTECTED.lexer.currentLength,input:this.PROTECTED.lexer.statement.substr(this.PROTECTED.lexer.index-this.PROTECTED.lexer.currentLength,this.PROTECTED.lexer.currentLength)});const e=s[i].length-1;this.PROTECTED.orderedList.add({index:e,token:i,get detail(){return Object.assign(s[this.token][this.index],{token:this.token})}})}return s}},Set:class{static isSuperSet(e,t){if(t.size>e.size||0===t.size)return!1;let i=e.values(),s=i.next();for(;!s.done;){if(!e.has(s.value))return!1;s=i.next()}return!0}static concat(){let e=new Set(arguments[0]);for(let t=1;t<arguments.length;t++){let i=arguments[t].values(),s=i.next();for(;!s.done;)e.add(s.value),s=i.next()}return e}static intersection(e,t){let i=new Set,s=e.size<t.size?e:t,r=e.size<t.size?t:e,n=s.values(),a=n.next();for(;!a.done;)r.has(a.value)&&i.add(a.value),a=n.next();return i}static difference(e,t){let i=new Set(e),s=t.values(),r=s.next();for(;!r.done;)i.delete(r.value),r=s.next();return i}static equal(e,t){return 0===NGN.UTILITY.Set.difference(e,t).size}static equals(){NGN.WARN("NGN.UTILITY.Set.equals() should be equal() (no s at the end)."),NGN.UTILITY.Set.equal(...arguments)}static applyAll(){Set.prototype.isSuperSet=function(e){return NGN.UTILITY.Set.isSuperSet(this,e)},Set.prototype.concat=function(){return NGN.UTILITY.Set.concat(this,...arguments)},Set.prototype.intersection=function(){return NGN.UTILITY.Set.intersection(this,...arguments)},Set.prototype.difference=function(){return NGN.UTILITY.Set.difference(this,...arguments)},Set.prototype.equals=function(){return NGN.UTILITY.Set.equal(this,...arguments)}}}});let n;n=window.location.host;const a=function(e){let t=[],i=/^(.*)\:\/.*/.exec(e);(i=i.length>0?i[1]:null)&&(e=e.replace(new RegExp(`${i}\\:\\/+`,"i"),"")),e=e.split("/");for(let i=0;i<e.length;i++)".."===e[i]?t.pop():"."!==e[i]&&e[i].trim().length>0&&t.push(e[i]);t=t.join("/").replace(/:\/{3,50}/gi,"://");let s=/(.*:\/\/.*)[?](.*)/.exec(t),r=null===s?t:s[1],n=null!==s?s[2]:"";if(t=r,n.trim().length>0){let e={};n.split("&").forEach(t=>{let i=t.split("=");e[i[0]]=i.length>1?i[1]:null}),n=[],Object.keys(e).forEach((t,i)=>{n.push(`${t}${null!==e[t]?"="+encodeURIComponent(e[t]):""}`)}),t=`${t}?${n.join("&")}`}return i?`${i}://${t}`:t};let o=["127.0.0.1","localhost",window.location.host];o=NGN.dedupe(o);const l=["OPTIONS","HEAD","GET","POST","PUT","DELETE","TRACE","CONNECT"];class h{constructor(e){e=e||{},NGN.objectRequires(e,"url"),NGN.objectHasAny(e,"form","json")&&NGN.WARN("NET.Request",'"form" and "json" configuration properties are not valid. Use "body" instead.'),Object.defineProperties(this,{UrlPattern:NGN.privateconst(new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?")),uri:NGN.private(null),httpmethod:NGN.private(null),enforceMethodSafety:NGN.private(NGN.coalesce(e.enforceMethodSafety,e.enforcemethodsafety,!0)),headers:NGN.public(NGN.coalesceb(e.headers)),requestbody:NGN.public(NGN.coalesce(e.body)),user:NGN.private(NGN.coalesceb(e.username)),secret:NGN.private(NGN.coalesceb(e.password)),bearerAccessToken:NGN.private(NGN.coalesceb(e.accessToken)),withCredentials:NGN.private(NGN.coalesce(e.withCredentials,!1)),timeout:NGN.public(NGN.coalesce(e.timeout,3e4)),timer:NGN.private(null),isCrossOrigin:NGN.privateconst(function(e){return this.host!==n}),applyAuthorizationHeader:NGN.privateconst(()=>{null!==NGN.coalesceb(this.bearerAccessToken)?this.setHeader("Authorization",`Bearer ${this.bearerAccessToken}`,!0):NGN.coalesceb(this.user)&&NGN.coalesceb(this.secret)&&this.setHeader("Authorization",this.basicAuthToken(this.user,this.secret),!0)}),basicAuthToken:NGN.privateconst((e,t)=>"Basic "+NGN.global.btoa(`${e}:${t}`)),parseUri:NGN.privateconst(e=>{let t,i=e.match(this.UrlPattern);t=window.location.protocol.replace(":","").toLowerCase();let s={protocol:NGN.coalesce(i[2],t),hostname:NGN.coalesce(i[4],n),path:NGN.coalesceb(i[5],"/"),query:NGN.coalesceb(i[7]),hash:NGN.coalesceb(i[9])};if(s.hostname.indexOf("@")>0){let t=e.match(/^.*\/{1,2}(.*):(.*)@/i);s.hostname=s.hostname.split("@").pop(),this.user=t[1],this.secret=t[2],this.applyAuthorizationHeader()}return s.port=NGN.coalesce(s.hostname.match(/:([0-9]{1,6})/),"https"===s.protocol?443:80),s.hostname.indexOf(":")>0&&(s.hostname=s.hostname.split(":")[0]),"/"!==s.path.charAt(0)&&(s.path=`/${s.path}`),s}),uriParts:NGN.private(null),maximumRedirects:NGN.private(10),redirectAttempts:NGN.private(0),prepareBody:NGN.private(()=>{if(null!==this.requestbody){null===this.headers&&(this.headers={});let e=NGN.coalesceb(this.headers["Content-Type"],this.headers["content-type"],this.headers["Content-type"]);if("object"==typeof this.requestbody)if(NGN.objectHasExactly(this.requestbody,"form")){let e=this.requestbody.form,t=Object.keys(e),i=[];for(let s=0;s<t.length;s++){if(NGN.isFn(e[t[s]]))throw new Error("Invalid form data. Form data cannot be a complex data format such as an object or function.");"object"==typeof e[t[s]]?i.push(`${t[s]}=${encodeURIComponent(JSON.stringify(e[t[s]]))}`):i.push(`${t[s]}:${encodeURIComponent(e[t[s]])}`)}this.requestbody=i.join("&")}else this.requestbody=JSON.stringify(this.requestbody).trim(),this.setHeader("Content-Length",this.requestbody.length,!1),this.setHeader("Content-Type",NGN.coalesceb(e,"application/json"),!1);if("string"==typeof this.requestbody){if(null!==e){let e=/([^=]+)=([^&]+)/.exec(this.requestbody);null!==e&&"data:"!==this.requestbody.trim().substr(0,5).toLowerCase()&&"<"!==this.requestbody.trim().substr(0,1).toLowerCase()?this.setHeader("Content-Type","application/x-www-form-urlencoded",!1):(this.setHeader("Content-Type","text/plain"),"data:"===this.requestbody.trim().substr(0,5).toLowerCase()?null!==(e=/^data:(.*);/gi.exec(this.requestbody.trim()))&&this.setHeader("Content-Type",e[1]):/^<\?xml.*/gi.test(this.requestbody.trim())?this.setHeader("Content-Type","application/xml"):/^<html.*/gi.test(this.requestbody.trim())&&this.setHeader("Content-Type","text/html"))}this.setHeader("Content-Type",this.requestbody.length,!1)}else NGN.WARN("NET.Request.body",`The request body must cannot be ${typeof this.requestbody}. Please provide a string, object, or binary value for the body.`)}})}),e.maxRedirects&&(this.maxRedirects=e.maxRedirects),this.url=e.url,this.method=NGN.coalesceb(e.method,"GET"),this.prepareBody(),null!==NGN.coalesce(this.user,this.secret,this.bearerAccessToken)&&this.applyAuthorizationHeader()}get maxRedirects(){return this.maximumRedirects}set maxRedirects(e){e>25&&(e=25),e<0&&(e=0),this.maximumRedirects=e}get protocol(){return NGN.coalesce(this.uriParts.protocol,"http")}get host(){return NGN.coalesce(this.uriParts.hostname)}get hostname(){return this.host}get port(){return this.uriParts.port}get path(){return NGN.coalesce(this.uriParts.path,"/")}get query(){return NGN.coalesce(this.uriParts.query,"")}get queryParameters(){let e=this.query.split("&"),t={};for(let i=0;i<e.length;i++){let s=e[i].split("="),r=`__qp__${s[0]}__qp__`;Object.defineProperty(t,r,{enumerable:!1,configurable:!1,writable:!0,value:NGN.coalesceb(s[1])}),Object.defineProperty(t,s[0],{enumerable:!0,configurable:!1,get:()=>t[r],set:e=>{t[r]=e,this.setQueryParameter(s[0],e,!0)}})}return t}get hash(){return NGN.coalesce(this.uriParts.hash,"")}get url(){return this.uri}set url(e){if(null===NGN.coalesceb(e)&&NGN.WARN("NET.Request.url","A blank URL was identified for a request."),null===/^.*\:\/{2}/i.exec(e)&&null!==/^\.{1,2}\/.*/.exec(e)&&NGN.global.hasOwnProperty("location")){let t=NGN.global.location,i=`${t.host}${t.pathname}`;(i=i.split("/"))[i.length-1].indexOf(".")>=0&&i.pop(),i=(i=i.join("/")).substring(0,i.lastIndexOf("/")+1),e=`${NGN.global.location.protocol}//${i}/${e}`.replace(/\/{2,1000000}/i,"/")}this.uri=a(e.trim()),this.uriParts=this.parseUri(this.uri)}get method(){return this.httpmethod}set method(e){this.httpmethod!==e&&(null===NGN.coalesceb(e)&&NGN.WARN("NET.Request.method","No HTTP method specified."),e=e.trim().toUpperCase(),l.indexOf(e)<0&&NGN.WARN("NET.Request.method",`A non-standard HTTP method was recognized in a request: ${e}.`),this.httpmethod=e)}get body(){return this.requestbody}set body(e){this.requestbody=e,this.prepareBody()}get crossOriginRequest(){return this.isCrossOrigin(this.uri)}get username(){return NGN.coalesce(this.user)}set username(e){e=NGN.coalesceb(e),this.user!==e&&(this.user=e,null!==NGN.coalesceb(this.secret)&&this.applyAuthorizationHeader())}set password(e){e=NGN.coalesceb(e),this.secret!==e&&(this.secret=e,null!==NGN.coalesceb(this.user)&&this.applyAuthorizationHeader())}set accessToken(e){e=NGN.coalesceb(e),this.bearerAccessToken!==e&&(this.bearerAccessToken=e,this.applyAuthorizationHeader())}setHeader(e,t,i=!0){e=e.replace(/'|"/gi,"").toLowerCase(),(null===this.headers||void 0===this.headers[e]||i)&&(null===this.headers&&(this.headers={}),this.headers[e]=t)}getHeader(e){if(null!==this.headers&&this.headers.hasOwnProperty(e.toLowerCase()))return this.headers[e.toLowerCase()]}removeHeader(e){null!==this.headers&&(delete this.headers[e.toLowerCase()],delete this.headers[e])}setQueryParameter(e,t,i=!0){let s,r=new RegExp("^.*(\\?|&)("+e+".*)(&.*)$|^.*(\\?|&)("+e+".*)$","i");if(null!==r.exec(this.uri)){if(!i)return;null!==(s=r.exec(this.uri))&&(this.url=this.uri.replace(`${NGN.coalesceb(s[5],s[2])}`,`${e}${null!==t?"="+encodeURIComponent(t):""}`))}else this.url=`${this.uri}${0===this.query.length?"?":"&"}${e}${null!==t?"="+encodeURIComponent(t):""}`}removeQueryParameter(e){this.url=this.uri.replace(new RegExp(`${e}=(.[^&]+)|\\?${e}|&${e}`,"gi"),"")}startMonitor(){null===this.timer&&(this.timer=setTimeout(()=>{throw new Error("Timed out retrieving "+this.url)},this.timeout))}stopMonitor(){clearTimeout(this.timer),this.timer=null}send(e){let t=this.body;NGN.coalesce(t)&&this.enforceMethodSafety&&"OPTIONS|HEAD|GET".indexOf(this.method)>=0&&(t=null);let i=new XMLHttpRequest,s=!1,r=this;if(i.onreadystatechange=function(){s||i.readyState===XMLHttpRequest.DONE&&(s=!0,0===i.status&&NGN.WARN(`Request Error: ${r.method} ${r.url} (likely a CORS issue).`),NGN.isFn(e)&&e(i))},i.onerror=function(t){NGN.WARN("NET.error",t),!s&&NGN.isFn(e)&&e(i),s=!0},i.ontimeout=function(t){s=!0,e(i)},i.timeout=this.timeout,i.open(this.method,this.url,!0),i.withCredentials=this.withCredentials,null!==this.headers){let e=Object.keys(this.headers);for(let t=0;t<e.length;t++)i.setRequestHeader(e[t],this.headers[e[t]])}i.send(t)}}class A{constructor(){Object.defineProperties(this,{parseRequestConfiguration:NGN.private((e,t="GET")=>("string"==typeof e&&(e={url:e}),(e=e||{}).method=t,e.url=NGN.coalesceb(e.url,n),new NGN.NET.Request(e))),makeRequest:NGN.private(e=>{const t=this;return function(){let i,s=NGN.slice(arguments);NGN.isFn(s[s.length-1])&&(i=s.pop()),s.push(e);let r=t.parseRequestConfiguration(...s);t.send(r,i)}}),OPTIONS:NGN.privateconst(this.options.bind(this)),HEAD:NGN.privateconst(this.head.bind(this)),GET:NGN.privateconst(this.get.bind(this)),POST:NGN.privateconst(this.post.bind(this)),PUT:NGN.privateconst(this.put.bind(this)),DELETE:NGN.privateconst(this.delete.bind(this)),TRACE:NGN.privateconst(this.trace.bind(this)),JSON:NGN.privateconst(this.json.bind(this)),JSONP:NGN.privateconst(this.jsonp.bind(this))})}get Request(){return h}request(e,t){(e=e||{}).method=NGN.coalesceb(e.method,"GET"),NGN.isFn(this[e.method])?this.makeRequest(e.method)(...arguments):this.send(new NGN.NET.Request(e),t)}options(){this.makeRequest("OPTIONS").apply(this,arguments)}head(){this.makeRequest("HEAD").apply(this,arguments)}get(){this.makeRequest("GET").apply(this,arguments)}post(){this.makeRequest("POST").apply(this,arguments)}put(){this.makeRequest("PUT").apply(this,arguments)}delete(){this.makeRequest("DELETE").apply(this,arguments)}trace(){NGN.WARN("NGN.NET.Request.method","An HTTP TRACE request was made."),this.makeRequest("TRACE").apply(this,arguments)}json(e,t){if(!NGN.isFn(t))throw new Error("NGN.NET.json requires a callback method.");let i=this.parseRequestConfiguration({url:e});this.preflight(i),i.send(e=>{try{let i=JSON.parse(e.responseText);t(null,i)}catch(i){i.response=NGN.coalesce(e.responseText),t(i,null)}})}jsonp(e,t){const i="jsonp_callback_"+Math.round(1e5*Math.random());window[i]=(e=>(delete window[i],document.body.removeChild(s),t(null,e)));let s=document.createElement("script");s.src=e+(e.indexOf("?")>=0?"&":"?")+"callback="+i,s.addEventListener("error",e=>(delete window[i],t(new Error("The JSONP request was blocked. This may be the result of an invalid URL, cross origin restrictions, or the remote server may not be online.")))),document.body.appendChild(s)}send(e,t){this.preflight(e),e.send(t)}preflight(e){}}A.prototype.Resource=class extends A{constructor(e){super(),e=e||{},Object.defineProperties(this,{globalHeaders:NGN.private(NGN.coalesceb(e.headers,{})),globalCredentials:NGN.private(NGN.coalesceb(e.credentials,{})),user:NGN.private(NGN.coalesceb(e.username)),secret:NGN.private(NGN.coalesceb(e.password)),accesstoken:NGN.private(NGN.coalesceb(e.token,e.accessToken)),globalQuery:NGN.private(NGN.coalesceb(e.query,{})),baseUrl:NGN.private(NGN.coalesce(e.baseUrl,e.baseurl,`http://${n}/`)),nocache:NGN.private(NGN.coalesce(e.nocache,!1)),sslonly:NGN.public(NGN.coalesce(e.sslonly,!1))}),this.baseUrl.indexOf("://")<0||this.baseUrl.indexOf("://")>10?this.baseUrl=`http${this.sslonly?"s":""}://${this.baseUrl}`:this.sslonly&&(this.baseUrl=this.baseUrl.replace("http://","https://")),null!==this.accesstoken?this.credentials={accessToken:this.accesstoken}:null!==this.user&&null!==this.ssecret&&(this.credentials={username:this.user,password:this.secret})}get username(){return this.user}set username(e){this.user!==e&&(this.user=e,null!==this.secret&&(this.credentials={username:this.user,password:this.secret}))}set password(e){this.secret!==e&&(this.secret=e,null!==this.user&&(this.credentials={username:this.user,password:this.secret}))}get headers(){return this.globalHeaders}set headers(e){this.globalHeaders=e}set credentials(e){if(e.hasOwnProperty("accesstoken")||e.hasOwnProperty("accessToken")||e.hasOwnProperty("token"))e.accessToken=NGN.coalesce(e.accessToken,e.accesstoken,e.token),e.hasOwnProperty("username")&&delete e.username,e.hasOwnProperty("password")&&delete e.password;else if(!(e.hasOwnProperty("username")&&e.hasOwnProperty("password")||e.hasOwnProperty("accessToken")))throw new Error("Invalid credentials. Must contain an access token OR the combination of a username AND password.");this.globalCredentials=e,e.username&&(this.username=e.username),e.password&&(this.password=e.password)}get credentials(){return NGN.WARN("Credentials are write-only. An attempt to read credentials was denied."),{username:null,secret:null,password:null,accessToken:null}}get query(){return this.globalQuery}set query(e){this.globalQuery=e}prepareUrl(e){return e.indexOf("://")<0&&(e=a(`${this.baseUrl}/${e}`)),e.replace(/\/{2,5}/gi,"/").replace(/:\/{1}/i,"://")}preflight(e){e.url=this.prepareUrl(e.url);let t=Object.keys(this.globalQuery);if(t.length>0){let i=[];for(let e=0;e<t.length;e++)i.push(`${t[e]}=${encodeURIComponent(this.globalQuery[t[e]])}`);""===e.query?e.url=`${e.url}?${i.join("&")}`:e.url=`${e.url}&${i.join("&")}`}let i=Object.keys(this.globalHeaders);for(let t=0;t<i.length;t++)e.setHeader(i[t],this.globalHeaders[i[t]]);this.globalCredentials.accessToken?e.accessToken=this.globalCredentials.accessToken:this.globalCredentials.username&&(e.username=this.globalCredentials.username,e.password=this.globalCredentials.password),this.nocache&&e.setQueryParameter("nocache"+(new Date).getTime().toString()+Math.random().toString().replace(".",""),null)}};const c=new A;class d{static compare(e,t,i=[]){let s=[],r=NGN.typeof(e);if(r!==NGN.typeof(t))return[["m",i,e,t]];switch(console.log("Diffing:",r,e,t,"PATH",i.join(".")),r){case"object":let n=Object.keys(e);for(let r=0;r<n.length;r++){let a=Object.assign([],i);a.push(n[r]),t.hasOwnProperty(n[r])?"object"===NGN.typeof(e[n[r]])?s=s.concat(this.compare(e[n[r]],t[n[r]],a)):e[n[r]]!==t[n[r]]&&("array"===NGN.typeof(e[n[r]])&&"array"===NGN.typeof(t[n[r]])?s=s.concat(this.compare(e[n[r]],t[n[r]],a)):s.push(["m",a,e[n[r]],t[n[r]]])):s.push(["-",a,e[n[r]]])}(n=Object.keys(e)).unshift(t),n=NGN.getObjectExtraneousPropertyNames.apply(this,n);for(let e=0;e<n.length;e++){let r=Object.assign([],i);r.push(n[e]),s.push(["+",r,t[n[e]]])}break;case"array":s=this.compareArray(e,t);break;case"string":console.log("TO DO: Add String Diff");default:e!==t&&("undefined"!==NGN.typeof(e)&&"undefined"===NGN.typeof(t)?s.push(["-",i,e]):"undefined"===NGN.typeof(e)&&"undefined"!==NGN.typeof(t)?s.push(["+",i,t]):s.push(["m",i,e,t]))}return s}compareArray(e,t){return[]}static arraysHaveMatchByRef(e,t,i,s){for(let r=0;r<i;r++){let i=e[r];for(let e=0;e<s;e++){let s=t[e];if(r!==e&&i===s)return!0}}}static matchItems(e,t,i,s,r){let n=e[i],a=t[s];if(n===a)return!0;if("object"!=typeof n||"object"!=typeof a)return!1;let o,l,h=r.objectHash;return h?("number"==typeof i?(r.hashCache1=NGN.forceArray(r.hashCache1),void 0===(o=r.hashCache1[i])&&(r.hashCache1[i]=o=h(n,i))):o=h(n),void 0!==o&&("number"==typeof s?(r.hashCache2=NGN.forceArray(r.hashCache2),void 0===(l=r.hashCache2[s])&&(r.hashCache2[s]=l=h(a,s))):l=h(a),void 0!==l&&o===l)):r.matchByPosition&&i===s}static lcsDefaultMatch(e,t,i,s){return e[i]===t[s]}static lcsLengthMatrix(e,t,i,s){let r,n,a=e.length,o=t.length,l=[a+1];for(r=0;r<a+1;r++)for(l[r]=[o+1],n=0;n<o+1;n++)l[r][n]=0;for(l.match=i,r=1;r<a+1;r++)for(n=1;n<o+1;n++)i(e,t,r-1,n-1,s)?l[r][n]=l[r-1][n-1]+1:l[r][n]=Math.max(l[r-1][n],l[r][n-1]);return l}static lcsBacktrack(e,t,i,s,r,n){if(0===s||0===r)return{sequence:[],indices1:[],indices2:[]};if(e.match(t,i,s-1,r-1,n)){let a=backtrack(e,t,i,s-1,r-1,n);return a.sequence.push(t[s-1]),a.indices1.push(s-1),a.indices2.push(r-1),a}return e[s][r-1]>e[s-1][r]?backtrack(e,t,i,s,r-1,n):backtrack(e,t,i,s-1,r,n)}static lcsGet(e,t,i,s){s=s||{};let r=lengthMatrix(e,t,i||defaultMatch,s),n=backtrack(r,e,t,e.length,t.length,s);return"string"==typeof e&&"string"==typeof t&&(n.sequence=n.sequence.join("")),n}}let u=null;const T=function(){let e,t=[];for(let i=0;i<256;i++){e=i;for(let t=0;t<8;t++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t};class N{static diff(){return d.compare(...arguments)}static checksum(e){"object"==typeof e&&(e=JSON.stringify(this.serialize(e))),u||(u=T());let t=-1;for(let i=0;i<e.length;i++)t=t>>>8^u[255&(t^e.charCodeAt(i))];return(-1^t)>>>0}static UUID(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}static GUID(){let e=[];for(let t=0;t<256;t++)e[t]=(t<16?"0":"")+t.toString(16);const t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return e[255&t]+e[t>>8&255]+e[t>>16&255]+e[t>>24&255]+"-"+e[255&i]+e[i>>8&255]+"-"+e[i>>16&15|64]+e[i>>24&255]+"-"+e[63&s|128]+e[s>>8&255]+"-"+e[s>>16&255]+e[s>>24&255]+e[255&r]+e[r>>8&255]+e[r>>16&255]+e[r>>24&255]}static serialize(e){if("object"!=typeof e)throw new Error(`Cannot serialize ${NGN.typeof(e)} value. Must be an object.`);let t=Symbol("array.data");"array"===NGN.typeof(e)&&(e={[t]:e});let i={},s=Object.keys(e);for(let r=0;r<s.length;r++)if(void 0!==e[s[r]])switch(NGN.typeof(e[s[r]])){case"object":Object.defineProperty(i,s[r],NGN.public(NGN.DATA.UTIL.serialize(e[s[r]])));break;case"array":i[s[r]]=[];for(let t=0;t<e[s[r]].length;t++)i[s[r]].push(NGN.DATA.UTIL.serialize(e[s[r]]));break;case"date":Object.defineProperty(i,s[r],NGN.public(e[s[r]].toISOString()));break;case"symbol":t!==s[r]&&(i[s[r]]=e[s[r]].toString());break;case"regexp":Object.defineProperty(i,s[r],NGN.public(e[s[r]].toString()));break;case"weakmap":case"map":let n={};e[s[r]].forEach((e,t)=>{n[t.toString()]=this.serialize(e)}),i[s[r]]=n;break;case"weakset":case"set":if(0===e[s[r]].size){i[s[r]]=[];break}i[s[r]]=this.serialize(Array.from(e[s[r]].values()));break;case"function":break;default:i[s[r]]=e[s[r]]}return void 0!==i[t]?i[t]:i}static isDataModel(e){if(e instanceof NGN.DATA.Model||"model"===NGN.typeof(e))return!0;if(e.hasOwnProperty("prototype")&&null!==e.prototype){let t=e,i=0;for(;null!==t.prototype&&i<30;)if(i++,(t=t.prototype)instanceof NGN.DATA.Model||"model"===NGN.typeof(t))return!0}return e instanceof NGN.DATA.Entity}}class p{constructor(e=null,t=[],i=[null]){Object.defineProperties(this,{parent:NGN.private(e),leafs:NGN.private(t),nodes:NGN.private(i),METADATA:NGN.private({order:null,minOrder:null,compare:(e,t)=>e<t?-1:e>t?1:0})});for(let e=0;e<this.leafs.length;e++)this.leafs[e].parent=this;for(let e=0;e<this.nodes.length;e++)null!==this.nodes[e]&&(this.nodes[e].parent=this)}search(e){if(this.leafs.length>0){let t,i=this.leafs[0];if(0===this.METADATA.compare(i.key,e))return{leaf:i,index:0};if(this.METADATA.compare(e,i.key)<0)return null!==this.nodes[0]?this.nodes[0].search(e):{node:this,index:0};for(t=1;t<this.leafs.length;t++){let s=this.leafs[t];if(0===this.METADATA.compare(s.key,e))return{leaf:s,index:t};if(this.METADATA.compare(e,s.key)<0)return null!==this.nodes[t]?this.nodes[t].search(e):{node:this,index:t};i=s}return null!==this.nodes[t]?this.nodes[t].search(e):{node:this,index:t}}return{node:this,index:0}}get(e){let t=this.search(e);return t.leaf?t.leaf.value:void 0}put(e,t,i=!0){let s=this.search(e);if(s.leaf){if(!i)return;return void(s.leaf.value=t)}let r=s.node,n=s.index;r.leafs.splice(n,0,new f(r,e,t)),r.nodes.splice(n+1,0,null),r.leafs.length>this.METADATA.order&&r.split()}delete(e){var t=this.search(e);if(!t.leaf)return;let i=t.leaf.parent,s=t.index,r=i.nodes[s];if(null===r)i.leafs.splice(s,1),i.nodes.splice(s,1),i.balance();else{let e=r.leafs[r.leafs.length-1];r.delete(e.key),e.parent=i,i.leafs.splice(s,1,e)}return!0}balance(){if(this.parent instanceof E)return void(0===this.leafs.length&&null!==this.nodes[0]&&(this.parent.root=this.nodes[0],this.parent.root.parent=this.parent));if(this.leafs.length>=this.METADATA.minOrder)return;let e,t,i,s=this.parent.nodes.indexOf(this),r=s>0?this.parent.nodes[s-1]:null,n=this.parent.nodes.length>s+1?this.parent.nodes[s+1]:null;if(null!==n&&n.leafs.length>this.METADATA.minOrder)(e=this.parent.leafs[s]).parent=this,this.leafs.push(e),(t=n.leafs.shift()).parent=this.parent,this.parent.leafs[s]=t,null!==(i=n.nodes.shift())&&(i.parent=this),this.nodes.push(i);else if(null!==r&&r.leafs.length>this.METADATA.minOrder)(e=this.parent.leafs[s-1]).parent=this,this.leafs.unshift(e),(t=r.leafs.pop()).parent=this.parent,this.parent.leafs[s-1]=t,null!==(i=r.nodes.pop())&&(i.parent=this),this.nodes.unshift(i);else{let t;if(null!==n)e=this.parent.leafs[s],(t=new p(this.parent,this.leafs.concat([e],n.leafs),this.nodes.concat(n.nodes))).METADATA.order=this.METADATA.order,t.METADATA.minOrder=this.METADATA.minOrder,this.parent.leafs.splice(s,1),this.parent.nodes.splice(s,2,t);else{if(null===r)throw new Error(`Internal error: ${this.toString(!0)} has neither a left nor a right sibling`);e=this.parent.leafs[s-1],(t=new p(this.parent,r.leafs.concat([e],this.leafs),r.nodes.concat(this.nodes))).METADATA.minOrder=this.METADATA.minOrder,t.METADATA.order=this.METADATA.order,this.parent.leafs.splice(s-1,1),this.parent.nodes.splice(s-1,2,t)}this.parent.balance()}}split(){let e=Math.floor(this.leafs.length/2);if(this.parent instanceof E)this.nodes=[new p(this,this.leafs.slice(0,e),this.nodes.slice(0,e+1)),new p(this,this.leafs.slice(e+1),this.nodes.slice(e+1))],this.leafs=[this.leafs[e]];else{let t=this.leafs[e],i=new p(this.parent,this.leafs.slice(e+1),this.nodes.slice(e+1));this.leafs=this.leafs.slice(0,e),this.nodes=this.nodes.slice(0,e+1),this.parent.unsplit(t,i)}}unsplit(e,t){e.parent=this,t.parent=this;let i=this.leafs[0];if(this.METADATA.compare(e.key,i.key)<0)this.leafs.unshift(e),this.nodes.splice(1,0,t);else{let i;for(i=1;i<this.leafs.length;i++){let s=this.leafs[i];if(this.METADATA.compare(e.key,s.key)<0){this.leafs.splice(i,0,e),this.nodes.splice(i+1,0,t);break}}i===this.leafs.length&&(this.leafs.push(e),this.nodes.push(t))}this.leafs.length>this.METADATA.order&&this.split()}toString(e=!1){let t,i=[];for(t=0;t<this.leafs.length;t++)i.push(this.leafs[t].key);let s=`[${i.toString()}]${this.parent instanceof E?":*":":"}${this.parent}`;if(e)for(t=0;t<this.nodes.length;t++)s+=` -> ${this.nodes[t]}`;return s}}class f{constructor(e,t,i){Object.defineProperties(this,{parent:NGN.private(e),key:NGN.private(t),value:NGN.private(i)})}toString(){return this.key.toString()}}class E extends s{constructor(e=52){super(),e=e<1?1:e,Object.defineProperties(this,{root:NGN.private(new p(this)),BTREE:NGN.private({}),METADATA:NGN.private({order:e,minOrder:e>1?Math.floor(e/2):1,compare:(e,t)=>e<t?-1:e>t?1:0})}),this.root.METADATA.minOrder=this.METADATA.minOrder,this.root.METADATA.order=this.METADATA.order}validate(e){if(e instanceof E)return;let t;for(e.leafs.length+1!==e.nodes.length&&NGN.ERROR(`Illegal leaf/node count in ${e}: ${e.leafs.length}/${e.nodes.length}`),t=0;t<e.leafs.length;t++)e.leafs[t]||NGN.ERROR(`Illegal leaf in ${e} at ${t}: ${e.leafs[t]}`);for(t=0;t<e.nodes.length;t++)"undefined"===NGN.typeof(e.nodes[t])&&NGN.ERROR(`Illegal node in ${e} at ${t}: undefined`)}put(e,t,i=!0){if("number"!==NGN.typeof(e))throw new Error(`Illegal key: ${e}`);if(void 0===t)throw new Error(`Illegal value: ${t}`);return this.root.put(e,t,i)}get(e){if("number"!==NGN.typeof(e))throw new Error(`Illegal key: ${e}`);return this.root.get(e)}delete(e){if("number"!==NGN.typeof(e))throw new Error(`Illegal key: ${e}`);return this.root.delete(e)}walk(e,t,i){if(0===this.root.leafs.length)return;let s,r;if(NGN.isFn(e)?(i=e,e=t=null):NGN.isFn(t)&&(i=t,t=null),e=NGN.coalesce(e),t=NGN.coalesce(t),null===e){for(s=this.root;null!==s.nodes[0];)s=s.nodes[0];r=0}else{let t=this.root.search(e);if(t.leaf)r=(s=t.leaf.parent).leafs.indexOf(t.leaf);else if(s=t.node,(r=t.index)>=s.leafs.length){if(s.parent instanceof E||s.parent.nodes.indexOf(s)>=s.parent.leafs.length)return;s=s.parent}}for(;!(null!==t&&this.METADATA.compare(s.leafs[r].key,t)>0||0===s.leafs.length||i(s.leafs[r].key,s.leafs[r].value));)if(null!==s.nodes[r+1])for(s=s.nodes[r+1],r=0;null!==s.nodes[0];)s=s.nodes[0];else if(s.leafs.length>r+1)r++;else do{if(s.parent instanceof E)return;r=s.parent.nodes.indexOf(s),s=s.parent}while(r>=s.leafs.length)}walkDesc(e,t,i){let s,r;if(NGN.isFn(e)?(i=e,e=t=null):NGN.isFn(t)&&(i=t,t=null),e=NGN.coalesce(e),null===(t=NGN.coalesce(t))){for(s=this.root;null!==s.nodes[s.nodes.length-1];)s=s.nodes[s.nodes.length-1];r=s.leafs.length-1}else{let e=this.root.search(t);if(e.leaf)r=(s=e.leaf.parent).leafs.indexOf(e.leaf);else for(s=e.node,r=e.index-1;r<0;){if(s.parent instanceof E)return;if((r=s.parent.nodes.indexOf(s)-1)<0)return;s=s.parent}}for(;!(null!==e&&this.METADATA.compare(s.leafs[r].key,e)<0||i(s.leafs[r].key,s.leafs[r].value));)if(null!==s.nodes[r]){for(s=s.nodes[r];null!==s.nodes[s.nodes.length-1];)s=s.nodes[s.nodes.length-1];r=s.leafs.length-1}else if(r>0)r--;else do{if(s.parent instanceof E)return;r=s.parent.nodes.indexOf(s)-1,s=s.parent}while(r<0)}count(e,t){let i=0;return this.walk(void 0!==e?e:null,void 0!==t?t:null,(e,t)=>{i++}),i}toString(){return`Tree(${this.METADATA.order}) ${this.root.toString()}`}get length(){return this.count()}}class m{constructor(e,t=null,i=null){const s=NGN.typeof(e);Object.defineProperties(this,{RULE:NGN.private({type:s,validator:e,name:NGN.coalesce(t,`Untitled ${s.toUpperCase()} Validation`),scope:NGN.coalesce(i,this)})})}get name(){return this.RULE.name}get type(){return this.RULE.type}test(e){if(NGN.isFn(this.RULE.validator))return this.RULE.validator.apply(this.RULE.scope,[e]);switch(this.type){case"array":return-1!==this.RULE.validator.indexOf(e);case"regexp":return this.RULE.validator.test(e);default:return this.RULE.validator===e}}}class D extends s{constructor(e){if("string"==typeof(e=e||{})&&(e={name:e}),e.hasOwnProperty("pattern")&&"regexp"!==NGN.typeof(e.pattern))throw new Error("Invalid data field configuration. Pattern must be a valid JavaScript regular expression (RegExp).");void 0===e.type&&e.default&&(e.type=NGN.getType(NGN.typeof(e.default),String)),super(e);const t=Symbol("empty");if(Object.defineProperties(this,{METADATA:NGN.privateconst({required:NGN.coalesce(e.required,!1),hidden:NGN.coalesce(e.hidden,!1),fieldType:NGN.coalesce(e.identifier,!1)?"key":"data",isIdentifier:NGN.coalesce(e.identifier,!1),autocorrectInput:NGN.coalesce(e.autocorrectInput,!1),pattern:NGN.coalesceb(e.pattern),name:NGN.coalesce(e.name),description:NGN.coalesce(e.description,`${NGN.typeof(e.type)} field`),sourceName:NGN.coalesce(e.sourceName),default:NGN.coalesce(e.default),lastValue:Symbol("no.value"),dataType:NGN.coalesce(e.type,String),rules:NGN.coalesce(e.rule,e.rules,e.validators,[]),violatedRule:null,allowInvalid:NGN.coalesce(e.allowInvalid,!0),TRANSFORM:NGN.coalesce(e.transformer),RAWDATAPLACEHOLDER:t,RAW:t,ENUMERABLE_VALUES:null,REVERSE_ENUMERABLE_VALUES:null,IS_NEW:!0,EVENTS:new Set(["hidden","unhidden","update","invalid","valid","rule.add","rule.remove"]),AUDITABLE:NGN.coalesce(e.audit,!1),AUDITLOG:NGN.coalesce(e.audit,!1)?new NGN.DATA.TransactionLog(NGN.coalesce(e.auditMaxEntries,10)):null,model:null,setValue:(e,t=!1,i=!1)=>{if(null!==this.METADATA.TRANSFORM&&NGN.isFn(this.METADATA.TRANSFORM)&&(e=this.METADATA.TRANSFORM.call(this,e)),this.METADATA.autocorrectInput&&this.type!==NGN.typeof(e)&&(e=this.autoCorrectValue(e)),e===this.value)return;let s={field:this,old:"symbol"==typeof this.METADATA.RAW?void 0:this.METADATA.RAW,new:e},r=this.valid;if(this.METADATA.RAW=e,this.valid)!t&&null!==r&&r&&this.emit("valid",s);else{if(!this.METADATA.allowInvalid)throw this.METADATA.RAW=s.old,new Error(`"${e}" did not pass the ${this.METADATA.violatedRule} rule.`);s.reason=`"${e}" did not pass the ${this.METADATA.violatedRule} rule.`,NGN.WARN(s.reason),this.emit("invalid",s)}"symbol"==typeof this.METADATA.lastValue&&(this.METADATA.lastValue=e),i||this.virtual||!this.METADATA.AUDITABLE||(s.cursor=this.METADATA.AUDITLOG.commit(this.METADATA.RAW)),t||this.emit("update",s),r=null,s=null},commitPayload:e=>{this.METADATA.model&&(e.action="update",e.join=!0,this.increaseMaxListeners(3),this.METADATA.model.emit(["update",`${e.field}.update`,`update.${e.field}`],e),e=null)}})}),"array"!==NGN.typeof(this.METADATA.rules)&&(this.METADATA.rules=NGN.forceArray(this.METADATA.rules)),this.METADATA.rules.length>0)for(let e=0;e<this.METADATA.rules.length;e++)!NGN.isFn(this.METADATA.rules[e])||this.METADATA.rules[e]instanceof NGN.DATA.Rule||(this.METADATA.rules[e]=new NGN.DATA.Rule(this.METADATA.rules[e],`Custom Rule #${e+1}`));if(this.METADATA.dataType===String&&(null!==this.METADATA.pattern&&this.METADATA.rules.unshift(new NGN.DATA.Rule(e.pattern,`Pattern Match (${e.pattern.toString()})`)),e.nonempty&&this.METADATA.rules.unshift(new NGN.DATA.Rule(e=>e.trim().length>0,`No Blanks (${e.pattern.toString()})`))),this.METADATA.dataType!==Number&&this.METADATA.dataType!==Date&&this.METADATA.dataType!==String||(NGN.objectHasAny(e,"min","minimum","max","maximum")&&(e.range=NGN.forceArray(NGN.coalesce(e.range)),e.range.push([NGN.coalesce(e.min,e.minimum),NGN.coalesce(e.max,e.maximum)])),e.hasOwnProperty("range")&&this.METADATA.rules.unshift(new NGN.DATA.RangeRule("Numeric Range",e.range)),this.METADATA.dataType===Number&&(NGN.coalesce(e.pattern)&&this.METADATA.rules.unshift(new NGN.DATA.Rule(t=>e.pattern.test(t.toString()),`Numeric Pattern (${e.pattern.toString().substr(0,15)+(e.pattern.toString().length>15?"...":"")})`)),"number"===NGN.typeof(e.multipleOf)&&this.METADATA.rules.unshift(new NGN.DATA.Rule(t=>0===Math.abs(t%e.multipleOf),`Numeric Multiple of ${e.multipleOf}`)))),this.METADATA.dataType===Array&&(NGN.objectHasAny(e,"min","minimum")&&this.METADATA.rules.push(new NGN.DATA.Rule(t=>t.length>=NGN.coalesce(e.min,e.minimum),`${NGN.coalesce(e.min,e.minimum)} count minimum`)),NGN.objectHasAny(e,"max","maximum")&&this.METADATA.rules.push(new NGN.DATA.Rule(t=>t.length<=NGN.coalesce(e.max,e.maximum),`${NGN.coalesce(e.max,e.maximum)} count maximum`)),NGN.coalesce(e.unique,!1)&&this.METADATA.rules.push(new NGN.DATA.Rule(e=>NGN.dedupe(e).length===e.length,"Unique value constraint")),e.hasOwnProperty("listType")&&this.METADATA.rules.push(new NGN.DATA.Rule(t=>{for(let i=0;i<t.length;i++)if(NGN.typeof(t[i])!==NGN.typeof(e.listType))return!1;return!0},`${NGN.typeof(e.listType).toUpperCase()} list type constraint`)),e.hasOwnProperty("enum")&&this.METADATA.rules.push(new NGN.DATA.Rule(t=>e.enum.indexOf(t)>=0)),e.hasOwnProperty("tuples")&&this.METADATA.rules.push(new NGN.DATA.Rule(t=>{if(t.length<e.tuples.length)return!1;for(let i=0;i<e.tuples.length;i++){if(e.tuples[i].hasOwnProperty("type")&&NGN.typeof(t[i])!==NGN.typeof(e.tuples[i].type))return!1;if(e.tuples[i].hasOwnProperty("enum")&&e.tuples[i].enum.indexOf(t[i])<0)return!1}return!0},"Tuple constraint"))),NGN.objectHasAny(e,"enum","enumeration")&&(this.METADATA.ENUMERABLE_VALUES=new Set(NGN.forceArray(NGN.coalesce(e.enum,e.enumeration))),this.METADATA.rules.push(new NGN.DATA.Rule(e=>this.METADATA.ENUMERABLE_VALUES.has(e),"Enumerable Values"))),NGN.objectHasAny(e,"not","notin")&&(this.METADATA.REVERSE_ENUMERABLE_VALUES=new Set(NGN.forceArray(NGN.coalesce(e.not,e.notin))),this.METADATA.rules.push(new NGN.DATA.Rule(e=>!this.METADATA.REVERSE_ENUMERABLE_VALUES.has(e),"Rejected Values"))),e.type instanceof Array&&(0===e.type.length?(NGN.WARN(`No data type specified for ${this.name} field. Autoconverted to an array.`),e.type=Array):1===e.type.length&&(e.type=e.type[0])),e.type instanceof Array){let t=e.type.map(e=>NGN.typeof(e));this.METADATA.rules.unshift(new NGN.DATA.Rule(e=>t.indexOf(NGN.typeof(e))>=0,`${this.type.toUpperCase()} Multitype Check`))}else this.METADATA.rules.unshift(new NGN.DATA.Rule(e=>NGN.typeof(e)===NGN.typeof(this.METADATA.dataType),`${this.type.toUpperCase()} Type Check`));null!==NGN.coalesce(e.model)&&(this.model=e.model)}get sourceName(){return this.METADATA.sourceName}get auditable(){return this.METADATA.AUDITABLE}set auditable(e){(e=NGN.forceBoolean(e))!==this.METADATA.AUDITABLE&&(this.METADATA.AUDITABLE=e,this.METADATA.AUDITLOG=e?new NGN.DATA.TransactionLog:null,this.METADATA.AUDITLOG.relay("*",this,"transaction."))}get model(){return this.METADATA.model}set model(e){null===this.METADATA.model?e instanceof NGN.DATA.Entity?(this.METADATA.model=e,this.on("update",e=>this.METADATA.commitPayload(e))):NGN.WARN("Invalid model."):NGN.WARN("Cannot set model multiple times.")}get fieldType(){return this.METADATA.fieldType}get required(){return this.METADATA.required}set required(e){this.METADATA.required=NGN.forceBoolean(e)}get type(){return NGN.typeof(this.METADATA.dataType)}get hidden(){return this.METADATA.hidden}set hidden(e){let t=this.hidden,i=NGN.forceBoolean(e);t!==i&&(this.METADATA.hidden=i,this.emit(t?"unhidden":"hidden"))}get virtual(){return"virtual"===this.METADATA.fieldType}get identifier(){return this.METADATA.isIdentifier}set identifier(e){(e=NGN.forceBoolean(e))!==this.METADATA.isIdentifier&&(this.METADATA.isIdentifier=e,this.emit("keystatus.changed",this))}get name(){return this.METADATA.name}get isNew(){return this.METADATA.IS_NEW}get default(){return this.isIdentifier?NGN.coalesce(this.METADATA.autoid,this.METADATA.default):NGN.isFn(this.METADATA.default)&&"function"!==this.type?this.METADATA.default.apply(this):this.METADATA.default}get value(){return"symbol"!=typeof this.METADATA.RAW?this.METADATA.RAW:this.METADATA.default}set value(e){this.METADATA.setValue(e)}set silentValue(e){this.METADATA.setValue(e,!0)}get modified(){return"symbol"!=typeof this.META.lastValue&&this.METADATA.lastValue!==this.value}get valid(){if(this.required&&null===NGN.coalesce(this.METADATA.RAW))return this.METADATA.violatedRule="Data Required",NGN.WARN(`${this.METADATA.name} is a required field.`),!1;if(this.METADATA.rules.length>0)for(let e=0;e<this.METADATA.rules.length;e++)if(!this.METADATA.rules[e].test(this.METADATA.RAW))return this.METADATA.violatedRule=this.METADATA.rules[e].name,!1;return this.METADATA.violatedRule=null,!0}get violatedRule(){return NGN.coalesce(this.METADATA.violatedRule,"None")}get changelog(){return this.METADATA.AUDITABLE?this.METADATA.AUDITLOG.log:(NGN.WARN(`The changelog for the ${this.name} field is empty because auditing is disabled.`),[])}undo(e=1,t=!1){if(!this.METADATA.AUDITABLE)return void NGN.WARN(`The undo operation failed on the ${this.name} field because auditing is disabled.`);let i=this.METADATA.AUDITLOG.rollback(e);this.METADATA.setValue(this.METADATA.AUDITLOG.getCommit(i).value,t,!0)}redo(e=1,t=!1){if(!this.METADATA.AUDITABLE)return void NGN.WARN(`The redo operation failed on the ${this.name} field because auditing is disabled.`);let i=this.METADATA.AUDITLOG.advance(e);this.METADATA.setValue(this.METADATA.AUDITLOG.getCommit(i).value,t,!0)}hide(){this.hidden=!0}unhide(){this.hidden=!1}allowInvalid(){this.METADATA.allowInvalid=!0}disallowInvalid(){this.METADATA.allowInvalid=!1}autoCorrectValue(e){try{switch(this.type){case"number":e=NGN.forceNumber(e);break;case"boolean":e=NGN.forceBoolean(e);break;case"array":e=NGN.forceArray(e);break;case"string":e=e.toString();break;case"date":let t=NGN.typeof(e);if("date"!==t)if("number"===t){let t=new Date;t.setTime(e),e=t}else e=new Date(Date.parse(e))}}finally{return e}}}NGN.createException({name:"NGNDuplicateRecordError",message:"A duplicate record exists within the unique data set."});const g=NGN.deprecate(N,"NGN.DATA.util is now NGN.DATA.UTILITY");var M=Object.freeze({UTILITY:N,util:g,TransactionLog:class extends s{constructor(e){super(),Object.defineProperties(this,{METADATA:NGN.private({transaction:{},changeOrder:[],cursor:null,max:NGN.coalesce(e,10)})})}get length(){return this.METADATA.changeOrder.length}get cursor(){return this.METADATA.cursor}set cursor(e){if(null!==e&&!this.METADATA.transaction.hasOwnProperty(e))throw new Error("Cannot set cursor for transaction log (does not exist).");this.METADATA.cursor=e}get currentValue(){if(null!==this.METADATA.cursor)return this.getCommit(this.METADATA.cursor).value}get cursorIndex(){if(null!==this.METADATA.cursor)return this.METADATA.changeOrder.indexOf(this.METADATA.cursor)}commit(e){let t="symbol"==typeof e?Symbol(String(e)):Symbol(NGN.coalesce(e,NGN.typeof(e)).toString());if(this.METADATA.transaction[t]=[new Date,e],this.flush(),this.METADATA.changeOrder.push(t),this.METADATA.cursor=t,this.METADATA.max>0&&this.METADATA.changeOrder.length>this.METADATA.max){let e=this.METADATA.changeOrder.shift();delete this.METADATA.transaction[e]}return this.emit("commit",t,null),t}getCommit(e=null){if(this.METADATA.transaction.hasOwnProperty(e))return{timestamp:this.METADATA.transaction[e][0],value:this.METADATA.transaction[e][1]}}flush(){if(null===this.METADATA.cursor)return;let e=this.METADATA.changeOrder.indexOf(this.METADATA.cursor);if(0===e)return;let t=this.METADATA.changeOrder.splice(e+1);for(let e=0;e<t.length;e++)delete this.METADATA.transaction[t[e]];this.METADATA.cursor=this.METADATA.changeOrder[this.METADATA.changeOrder.length-1]}rollback(e=1){if(0===this.METADATA.changeOrder.length)return null;if("symbol"==typeof e)return this.cursor=e,e;if(e>=this.METADATA.changeOrder.length)this.METADATA.cursor=this.METADATA.changeOrder[0];else{if("number"==typeof e){if(e<=0)return this.METADATA.cursor;let t=this.METADATA.changeOrder.indexOf(this.METADATA.cursor);(t-=e)<=0&&(t=0),e=this.METADATA.changeOrder[t]}this.METADATA.cursor=e}return this.emit("rollback",this.METADATA.cursor,null),this.METADATA.cursor}advance(e=1){if(0===this.METADATA.changeOrder.length)return null;if("number"==typeof e){if(e<=0)return this.METADATA.cursor;let t=this.METADATA.changeOrder.indexOf(this.METADATA.cursor);(t+=e)>=this.METADATA.changeOrder.length&&(t=this.METADATA.changeOrder.length-1),e=this.METADATA.changeOrder[t]}return this.METADATA.cursor=e,this.emit("advance",this.METADATA.cursor,null),this.METADATA.cursor}reset(e=!1){this.METADATA.transaction={},this.METADATA.changeOrder=[],this.METADATA.cursor=null,e||this.emit("reset")}get log(){return this.METADATA.changeOrder.map(e=>({timestamp:this.METADATA.transaction[e][0],value:this.METADATA.transaction[e][1],activeCursor:this.METADATA.cursor===e}))}},Rule:m,RangeRule:class extends m{constructor(e,t,i=[]){"array"===NGN.typeof(t)&&(i=t,t=null),super(null,e,t),this.RULE.prepareRange=function(e){e=NGN.forceArray(e),"array"!==NGN.typeof(e[0])&&(e=[e]);for(let t=0;t<e.length;t++){if(2!==e[t].length){if("string"!==NGN.typeof(e[t][0]))throw new Error(`Invalid range: "${e[t].toString()}"`);e[t]=e[t][0].replace(/[^0-9->]/gi,"").split(/->{1,100}/)}"number"!==NGN.typeof(e[t][0])&&(e[t][0]=NGN.coalesce(e[t][0],"").replace(/null|none|any/gi,"")),"number"!==NGN.typeof(e[t][1])&&(e[t][1]=NGN.coalesce(e[t][1],"").replace(/null|none|any/gi,""))}return e},this.RULE.range=new Set,this.range=i,this.RULE.validator=(e=>{let t="string"===NGN.typeof(e),i=this.range;for(let s=0;s<i.length;s++){let r=NGN.coalesceb(i[s][0],t?e.length:e),n=NGN.coalesceb(i[s][1],t?e.length:e);if(t&&e.length>=r&&e.length<=n||!t&&e>=r&&e<=n)return!0}return!1})}get range(){return Array.from(this.RULE.range.values())}set range(e){this.RULE.range=new Set,this.addRange(e)}addRange(e){e=this.RULE.prepareRange(e);for(let t=0;t<e.length;t++){if(null!==NGN.coalesceb(e[t][0])&&null!==NGN.coalesceb(e[t][1])&&e[t][1]<e[t][0])throw new Error(`Invalid value "${e[t][0].toString()} -> ${e[t][1].toString()}". Minimum value cannot exceed maximum.`);this.RULE.range.add(e[t])}}removeRange(e){let t=this.range;e=this.RULE.prepareRange(e);for(let i=0;i<e.length;i++)for(let s=0;s<t.length;s++)e[i].toString()===t[s].toString()&&this.RULE.range.delete(t[s])}},Field:D,VirtualField:class extends D{constructor(e){(e=e||{}).model instanceof NGN.DATA.Entity||NGN.WARN("No model specified for the virtual field to reference."),delete e.required,delete e.default,delete e.min,delete e.minimum,delete e.max,delete e.maximum,delete e.range,delete e.rule,delete e.rules,delete e.validators,delete e.pattern,super(e),this.METADATA.AUDITABLE=!1,this.METADATA.fieldType="virtual",this.METADATA.caching=NGN.coalesce(e.cache,!0),this.METADATA.scope=NGN.coalesce(e.scope,e.model,this);const t=this,i=e.method;if(this.METADATA.virtualMethod=function(){return i.apply(t.METADATA.scope,...arguments)},this.METADATA.CACHEKEY=Symbol("no.cache"),this.METADATA.cachedValue=this.METADATA.CACHEKEY,this.METADATA.caching&&this.model){const e=/this(\.(.[^\W]+)|\[['"]{1}(.*)+['"]{1}\])/g;let t=new Set,s=i.toString(),r=e.exec(s);for(;null!==r;){let i=NGN.coalesce(r[2],r[3]);this.model.METADATA.knownFieldNames.has(i)&&t.add(i),s=s.replace(e,""),r=e.exec(s)}this.METADATA.model.pool("field.",{update:e=>{e.field&&t.has(e.field.name)&&(this.METADATA.cachedValue=this.METADATA.CACHEKEY,this.emit("cache.clear",this))},remove:e=>{t.has(e.name)&&(this.METADATA.cachedValue=this.METADATA.CACHEKEY,this.emit("cache.clear",this),NGN.ERROR(`The ${this.name} virtual field uses the ${e.name} field, which was removed. This virtual field may no longer work.`))},create:e=>{t.has(e.name)&&(this.METADATA.cachedValue=this.METADATA.CACHEKEY,this.emit("cache.clear",this),NGN.INFO(`The ${this.name} virtual field uses the ${e.name} field, which was added.`))}})}}get auditable(){return NGN.WARN("Virtual fields do not support the auditable property."),!1}set auditable(e){NGN.WARN("Virtual fields do not support the auditable property.")}get value(){return this.METADATA.caching?this.METADATA.cachedValue!==this.METADATA.CACHEKEY?this.METADATA.cachedValue:(this.METADATA.cachedValue=this.METADATA.virtualMethod(),this.METADATA.cachedValue):this.METADATA.virtualMethod()}set value(e){NGN.WARN("Cannot set the value of a virtual field (read only).")}get required(){return NGN.WARN("Virtual fields do not support the required property."),!1}set required(e){NGN.WARN("Virtual fields do not support the required property.")}get isNew(){return NGN.WARN("Virtual fields do not support the isNew property."),!1}get default(){NGN.WARN("Virtual fields do not have default values.")}set default(e){NGN.WARN("Virtual fields do not have default values.")}get violatedRule(){return"None"}get valid(){return NGN.WARN("Virtual fields are always valid."),!0}get modified(){return NGN.WARN("modified attribute does nothing on virtual fields."),!1}allowInvalid(){NGN.WARN("allowInvalid() unavailable for virtual fields.")}disallowInvalid(){NGN.WARN("disallowInvalid() unavailable for virtual fields.")}autocorrectInput(){NGN.WARN("autocorrectInput() unavailable for virtual fields.")}},Relationship:class extends D{constructor(e={}){let t=NGN.typeof(e.join);if(!e.join)throw new InvalidConfigurationError('Missing "join" configuration property.');if(["model","store"].indexOf(t)<0&&("array"!==t||"model"!==NGN.typeof(e.join[0])))throw new InvalidConfigurationError(`The join specified is not a valid NGN.DATA.Model, NGN.DATA.Store, or collection. It is a ${NGN.typeof(e.join)}"`);e.identifier=!1,super(e),this.METADATA.fieldType="join",this.METADATA.join=Symbol("relationship"),this.METADATA.applyMonitor=(()=>{"model"===this.METADATA.manner&&this.METADATA.join.pool("field.",{create:this.METADATA.commonModelEventHandler("field.create"),update:this.METADATA.commonModelEventHandler("field.update"),remove:this.METADATA.commonModelEventHandler("field.remove"),invalid:e=>{this.emit(["invalid",`invalid.${this.METADATA.name}.${e.field}`])},valid:e=>{this.emit(["valid",`valid.${this.METADATA.name}.${e.field}`])}})}),this.METADATA.commonModelEventHandler=(e=>{const t=this;return function(e){t.METADATA.commitPayload({field:`${t.name}.${e.field}`,old:NGN.coalesce(e.old),new:NGN.coalesce(e.new),join:!0,originalEvent:{event:this.event,record:t.METADATA.record}})}}),this.METADATA.commonStoreEventHandler=(e=>{const t=this;return function(e,i){let s=i?NGN.coalesce(i.old):t.data;"record.create"===this.event?s.pop():"record.delete"===this.event&&s.push(e.data),t.METADATA.commitPayload({field:t.name+(i?`.${i.field}`:""),old:i?NGN.coalesce(i.old):s,new:i?NGN.coalesce(i.new):t.data,join:!0,originalEvent:{event:this.event,record:e}})}}),this.value=NGN.coalesce(e.join),this.METADATA.AUDITABLE=!1,this.auditable=NGN.coalesce(e.audit,!1)}get manner(){return NGN.coalesce(this.METADATA.manner,"unknown")}get value(){return this.METADATA.join}set value(e){let t=this.METADATA.join;if(t===e)return;let i=NGN.typeof(e);if("array"===i){if(1!==e.length)throw new Error(`${this.METADATA.name} cannot refer to an empty data store/model collection. A record must be provided.`);this.METADATA.manner="store",e=new NGN.DATA.Store({model:e[0]})}else{if(!(["model","store"].indexOf(i)>=0))throw NGN.ERROR(`The "${this.METADATA.name}" relationship has an invalid record type. Only instances of NGN.DATA.Store, NGN.DATA.Model, or [NGN.DATA.Model] are supported." .`),new InvalidConfigurationError(`Invalid record configuration for "${this.METADATA.name}" field.`);this.METADATA.manner=i}if("unknown"===this.manner)throw new Error("Cannot set a relationship field to anything other than an NGN.DATA.Store, NGN.DATA.Model, or an array of NGN.DATA.Model collections. (Unknown manner of relationship)");this.METADATA.join="model"===i?new e:e,this.auditable=this.METADATA.AUDITABLE,this.METADATA.applyMonitor(),"symbol"!=typeof t&&this.emit("update",{old:t,new:e})}set auditable(e){(e=NGN.forceBoolean(e))!==this.METADATA.AUDITABLE&&(this.METADATA.AUDITABLE=e,this.METADATA.join.auditable=e)}undo(){"model"===this.METADATA.manner&&this.METADATA.join.undo(...arguments)}redo(){"model"===this.METADATA.manner&&this.METADATA.join.redo(...arguments)}},FieldMap:class{constructor(e={}){Object.defineProperties(this,{originalSource:NGN.privateconst(e),sourceMap:NGN.private(null),reverseMap:NGN.private(null),applyData:NGN.privateconst((e="map",t)=>{if("object"!==NGN.typeof(t))return t;let i=Object.keys(t);e="map"===e?this.inverse:this.map;for(let s=0;s<i.length;s++)e.hasOwnProperty(i[s])&&(t[e[i[s]]]=t[i[s]],delete t[i[s]]);return t})})}get map(){if(null===this.sourceMap){let e=Object.keys(this.originalSource);this.sourceMap={};for(let t=0;t<e.length;t++)"string"===NGN.typeof(e[t])&&"string"===NGN.typeof(this.originalSource[e[t]])&&(this.sourceMap[e[t]]=this.originalSource[e[t]])}return this.sourceMap}get inverse(){if(null===this.reverseMap){let e=Object.keys(this.originalSource);this.reverseMap={};for(let t=0;t<e.length;t++)"string"===NGN.typeof(e[t])&&"string"===NGN.typeof(this.originalSource[e[t]])&&(this.reverseMap[this.originalSource[e[t]]]=e[t])}return this.reverseMap}applyMap(e){return this.applyData("map",e)}applyInverseMap(e){return this.applyData("reverse",e)}},Model:function(e){if("object"!==NGN.typeof(e))throw new Error("Model must be configured.");let t=function(t,i=!1){let s=new NGN.DATA.Entity(e);return t&&s.load(t,i),s};const i=this;return Object.defineProperty(t.prototype,"CONFIGURATION",NGN.const(e)),Object.defineProperty(t.prototype,"ENTITY",{enumerable:!1,get:()=>i}),t},Entity:class extends s{constructor(e){e=NGN.coalesce(e,{}),super(),e.dataMap&&(e.fieldmap=e.dataMap,NGN.WARN('"dataMap" is deprecated. Use "map" instead.')),e.idAttribute&&(e.IdentificationField=e.idAttribute,NGN.WARN('"idAttribute" is deprecated. Use "IdentificationField" instead.'));const t=this;Object.defineProperties(this,{OID:NGN.private(Symbol("model.id")),METADATA:NGN.privateconst({name:NGN.coalesce(e.name,"Untitled Model"),description:NGN.coalesce(e.description,e.name,"Generic Data Model"),fields:Object.assign({},NGN.coalesce(e.fields,{})),knownFieldNames:new Set,invalidFieldNames:new Set,auditFieldNames:NGN.coalesce(e.audit,!1)?new Set:null,validators:NGN.coalesce(e.rules,e.rule,e.validators),validation:NGN.coalesce(e.validation,!0),autoid:NGN.coalesce(e.autoid,!1),IdentificationField:NGN.coalesce(e.IdentificationField,e.idField,"id"),expiration:null,expirationTimeout:null,created:Date.now(),store:null,AUDITABLE:!1,AUDITLOG:NGN.coalesce(e.audit,!1)?new NGN.DATA.TransactionLog:null,AUDIT_HANDLER:function(e){e.hasOwnProperty("cursor")&&t.METADATA.AUDITLOG.commit(t.METADATA.getAuditMap())},EVENTS:new Set(["field.update","field.create","field.remove","field.invalid","field.valid","field.hidden","field.unhidden","field.rule.add","field.rule.remove","rule.add","rule.remove","relationship.create","relationship.remove","expired","deleted","reset","load"]),applyField:(e,t=null,i=!1)=>{if(this.METADATA.knownFieldNames.has(e))return NGN.WARN(`Duplicate field "${e}" detected.`);if(this.hasOwnProperty(e)&&"id"!==e.toLowerCase())throw new ReservedWordError(`"${e}" cannot be used as a field name (reserved word).`);if(t instanceof NGN.DATA.Field){if(null===t.model)t.name=e,t.identifier=t.identifier=NGN.coalesce(t.identifier,this.METADATA.IdentificationField===e),this.METADATA.fields[e]=t,this.METADATA.fields[e].model=this;else if(t.model===this)t.identifier=NGN.coalesce(t.identifier,this.METADATA.IdentificationField===e),this.METADATA.fields[e]=t;else if(!(t instanceof NGN.DATA.Field))return NGN.WARN(`The "${t.name}" field cannot be applied because model is already specified.`)}else if(t instanceof NGN.DATA.Store||t instanceof NGN.DATA.Model){if(this.METADATA.IdentificationField===e)throw new InvalidConfigurationError(`"${e}" cannot be an ID. Relationship fields cannot be an identification field/attribute.`);this.METADATA.fields[e]=new NGN.DATA.Relationship({name:e,record:t,model:this})}else switch(NGN.typeof(t)){case"object":t.model=this,t.identifier=NGN.coalesce(t.identifier,this.METADATA.IdentificationField===e),t.name=e,this.METADATA.fields[e]=new NGN.DATA.Field(t);break;case"array":return this.METADATA.applyField(e,t[0],i);default:if(NGN.isFn(t)||null===t){if(NGN.isFn(t)&&["string","number","boolean","number","symbol","regexp","date","array","object"].indexOf(NGN.typeof(t))<0){this.METADATA.fields[e]=new NGN.DATA.VirtualField({name:e,identifier:this.METADATA.IdentificationField===e,model:this,method:t});break}this.METADATA.fields[e]=new NGN.DATA.Field({name:e,type:t,identifier:this.METADATA.IdentificationField===e,model:this});break}this.METADATA.fields[e]=new NGN.DATA.Field({name:e,type:NGN.isFn(t)?t:String,identifier:!NGN.isFn(t)&&NGN.coalesce(t.identifier,this.METADATA.IdentificationField===e),model:this})}return Object.defineProperty(this,e,{enumerable:!0,configurable:!0,get:()=>this.get(e),set:t=>this.set(e,t)}),this.METADATA.AUDITABLE&&"virtual"!==this.METADATA.fields[e].fieldType&&(this.METADATA.fields[e].auditable=!0,this.METADATA.auditFieldNames.add(e)),this.METADATA.knownFieldNames.add(e),this.METADATA.fields[e].relay("*",this,"field."),i||this.emit("field.create",this.METADATA.fields[e]),this.METADATA.fields[e]},applyChange:(e="undo",t=1,i=!1)=>{if(!this.METADATA.AUDITABLE)return void NGN.WARN(`The ${e} operation failed on the ${this.name} model because auditing is disabled.`);this.METADATA.AUDITLOG["undo"===e?"rollback":"advance"](t);let s=this.METADATA.AUDITLOG.currentValue;s&&this.METADATA.auditFieldNames.forEach(e=>{let t=this.METADATA.fields[e],r=t.METADATA.AUDITLOG;r.cursor!==s[e]&&("symbol"==typeof s[e]?r.cursor=s[e]:r.cursor=null,t.METADATA.setValue(NGN.coalesce(r.currentValue,t.default),i,!0))})},getAuditMap:()=>{let e={};return this.METADATA.auditFieldNames.forEach(t=>{e[t]=this.METADATA.fields[t].METADATA.AUDITLOG.cursor}),e},setSilent:NGN.deprecate(this.setSilentFieldValue,"setSilent has been deprecated. Use setSilentFieldValue instead."),DATAMAP:null}),MAP:NGN.get(()=>NGN.coalesce(this.METADATA.DATAMAP,this.METADATA.store instanceof NGN.DATA.Store?this.METADATA.store.map:null))}),e.fieldmap instanceof NGN.DATA.FieldMap?this.METADATA.DATAMAP=e.fieldmap:"object"===NGN.typeof(e.fieldmap)&&(this.METADATA.DATAMAP=new NGN.DATA.FieldMap(e.fieldmap));let i=Object.keys(this.METADATA.fields);for(let e=0;e<i.length;e++){let t=i[e];this.METADATA.knownFieldNames.has(t)?NGN.WARN(`Duplicate field "${t}" detected.`):this.METADATA.applyField(t,this.METADATA.fields[t],!0)}if(this.METADATA.autoid){let e=null;Object.defineProperty(this.METADATA,"IdentificationValue",NGN.get(()=>(null===e&&(e=NGN.DATA.UTILITY.UUID()),e)))}if(this.auditable=NGN.coalesce(e.audit,!1),this.on(["field.update","field.create","field.delete","field.hidden","field.unhidden"],()=>{this.METADATA.checksum&&(this.METADATA.checksum=null)}),e.expires&&(this.expires=e.expires),null!==this.METADATA.validators)switch(NGN.typeof(this.METADATA.validators)){case"object":let e=Object.keys(this.METADATA.validators),t=[];for(let i=0;i<e.length;i++)t.push(new NGN.DATA.Rule(this.METADATA.validators[e[i]],e[i],this));break;case"array":for(let e=0;e<this.METADATA.validators.length;e++){if(!this.METADATA.validators[e].hasOwnProperty("RULE"))throw new Error(`Invalid data rule configuration for ${this.name} model. Rule #${e} is not a valid NGN.DATA.Rule instance.`);this.METADATA.validators[e].RULE.scope=this}break;default:throw new Error(`Invalid data rule configuration for ${this.name} model. Expected an object or array of NGN.DATA.Rule instances. Received "${NGN.typeof(this.METADATA.validators)}"`)}}get name(){return this.METADATA.name}set auditable(e){(e=NGN.forceBoolean(e))!==this.METADATA.AUDITABLE&&(this.METADATA.AUDITABLE=e,this.METADATA.AUDITLOG=e?new NGN.DATA.TransactionLog:null,this.METADATA.auditFieldNames=e?new Set:null,this.METADATA.knownFieldNames.forEach(t=>{this.METADATA.fields[t].virtual||(this.METADATA.fields[t].auditable=e,e&&this.METADATA.auditFieldNames.add(t))}),e?this.on("field.transaction.*",e=>{this.METADATA.AUDIT_HANDLER({cursor:e})}):(this.METADATA.auditFieldNames.clear(),this.off("field.transaction.*")))}get id(){return this.get(this.METADATA.IdentificationField)}set id(e){this.set("id",e)}get ID(){return this.id}set ID(e){this.set("id",e)}get changelog(){return this.METADATA.AUDITLOG.log.map(e=>{let t={timestamp:e.timestamp,activeCursor:e.activeCursor,value:{}},i=e.value,s=Object.keys(i);for(let e=0;e<s.length;e++)"symbol"==typeof i[s[e]]?t.value[s[e]]=NGN.coalesce(this.METADATA.fields[s[e]].METADATA.AUDITLOG.getCommit(i[s[e]]).value,this.METADATA.fields[s[e]].default):t.value[s[e]]=NGN.coalesce(this.METADATA.fields[s[e]].default);return t})}get createDate(){return this.METADATA.created}get data(){return this.MAP?this.MAP.applyInverseMap(this.serializeFields()):this.serializeFields()}get unmappedData(){return this.serializeFields()}get representation(){return this.MAP?this.MAP.applyInverseMap(this.serializeFields(!1,!1)):this.serializeFields(!1,!1)}get unmappedRepresentation(){return this.serializeFields(!1,!1)}get checksum(){return this.METADATA.checksum=NGN.coalesce(this.METADATA.checksum,NGN.DATA.UTILITY.checksum(JSON.stringify(this.data))),this.METADATA.checksum}get expires(){return this.METADATA.expiration}set expires(e){if(null===e)return clearTimeout(this.METADATA.expirationTimeout),void(this.METADATA.expiration=null);let t=new Date;if(isNaN(e)||e instanceof Date){if(!(e instanceof Date)||e<=t)throw new Error(`${this.name} expiration (TTL) value must be a positive number (milliseconds) or future date.`);this.METADATA.expiration=e}else{if(e<0)return void(this.METADATA.expiration=null);if(0===e)return this.METADATA.expiration=t,void this.emit("expire");this.METADATA.expiration=new Date,this.METADATA.expiration.setTime(t.getTime()+e)}clearTimeout(this.METADATA.expirationTimeout),this.METADATA.expirationTimeout=setTimeout(()=>this.emit("expire"),this.METADATA.expiration.getTime()-t.getTime())}get expired(){return null!==this.METADATA.expiration&&this.METADATA.expiration<=new Date}get fieldDefinitions(){return this.METADATA.fields}serializeFields(e=!1,t=!0){if(0===this.METADATA.knownFieldNames.size)return{};let i=this.METADATA.knownFieldNames.keys(),s={},r=i.next();for(;!r.done;){let n=this.METADATA.fields[r.value];if((void 0===n.value||e&&r.value===this.IdentificationField||!n.virtual||!t&&n.virtual)&&!n.hidden)switch(NGN.typeof(n.value)){case"array":case"object":s[r.value]=NGN.DATA.UTILITY.serialize(n.value);break;default:s[r.value]=n.value}r=i.next()}return s}serialize(){return NGN.deprecate(this.serializeFields,"serialize is now serializeFields. Use NGN.DATA.UTILITY.serialize for generic object serialization.")}fieldExists(e){return this.METADATA.knownFieldNames.has(e)}get(e){return"id"!==e&&"ID"!==e&&e!==this.METADATA.IdentificationField||(e=this.METADATA.IdentificationField,!this.METADATA.autoid)?this.METADATA.knownFieldNames.has(e)?this.METADATA.fields[e].value:void NGN.WARN(`Cannot get "${e}". The field is not part of the model.`):this.METADATA.knownFieldNames.has(e)?NGN.coalesce(this.METADATA.fields[e].value,this.METADATA.IdentificationValue):this.METADATA.IdentificationValue}set(e,t){"id"!==e&&"ID"!==e||(e=this.METADATA.IdentificationField),this.METADATA.knownFieldNames.has(e)?this.METADATA.fields[e].value=t:NGN.WARN(`Cannot set "${e}". Unrecognized field name.`)}addField(e,t=null,i=!1){if(e instanceof NGN.DATA.Field)e=(t=e).name;else if("string"!=typeof e)throw new Error("Cannot add a non-string based field.");this.METADATA.applyField(e,t,i)}removeField(e,t=!1){if(this.METADATA.knownFieldNames.has(e)){this.METADATA.knownFieldNames.delete(e),this.METADATA.invalidFieldNames.delete(e);const i=this.METADATA.fields[e];delete this[e],delete this.METADATA.fields[e],t||this.emit("field.remove",i),null!==this.METADATA.store&&this.METADATA.store.emit(this.METADATA.store.PRIVATE.EVENT.DELETE_RECORD_FIELD,{record:this,field:i})}}getField(e){return"id"===e.toLowerCase()&&!this.METADATA.fields.hasOwnProperty(e)&&this.METADATA.fields.hasOwnProperty(this.METADATA.IdentificationField)?this.METADATA.fields[this.METADATA.IdentificationField]:this.METADATA.fields[e]}setSilentFieldValue(e,t){this.METADATA.fields[e].silentValue=t}undo(e=1,t=!1){this.METADATA.applyChange("undo",...arguments)}redo(e=1,t=!1){this.METADATA.applyChange("redo",...arguments)}load(e,t=!1){this.MAP&&(e=this.MAP.applyMap(e));let i=Object.keys(e);for(let s=0;s<i.length;s++)this.METADATA.knownFieldNames.has(i[s])?this.METADATA.fields[i[s]].METADATA.setValue(e[i[s]],t):NGN.WARN(`Failed to load ${i[s]} field of ${this.name} model. "${i[s]}" is not a recognized field.`);return t||this.emit("load"),this}next(e=1,t=!1){return 0===e?this:this.METADATA.store?("boolean"==typeof e&&(t=e,e=1),this.METADATA.store.getRecordSibling(this,e,t)):(NGN.WARN("Attempted to call next() on a model that does not belong to a store."),this)}previous(e=1,t=!1){return 0===e?this:this.METADATA.store?("boolean"==typeof e&&(t=e,e=1),this.METADATA.store.getRecordSibling(this,0-e,t)):(NGN.WARN("Attempted to call previous() on a model that does not belong to a store."),this)}destroy(){this.METADATA.store?this.METADATA.store.remove(this.OID):NGN.WARN("Attempted to call remove() on a model that does not belong to a store.")}},Index:class extends s{constructor(e=!1,t="Untitled Index"){super(),Object.defineProperties(this,{CREATE_EVENT:NGN.privateconst(Symbol("create")),REMOVE_EVENT:NGN.privateconst(Symbol("delete")),UPDATE_EVENT:NGN.privateconst(Symbol("update")),uniqueValues:NGN.privateconst(new Set),knownRecords:NGN.privateconst([]),name:NGN.const(t),isBTree:NGN.privateconst(e)});const i=this;this.on([this.CREATE_EVENT,this.REMOVE_EVENT,this.UPDATE_EVENT],function(e,t,s=!1){s||i.emit(this.event.toString().replace(/^Symbol\(|\)$/g,""),e)}),this.on(this.REMOVE_EVENT,(e,t)=>{if(0===this.recordsFor(t).length){let e=this.indexOf(t);e>=0&&(this.knownRecords.splice(e,1),this.uniqueValues.delete(t))}}),this.isBTree&&Object.defineProperty(this,"BTREE",NGN.privateconst(new NGN.DATA.BTree(2,t)))}get keys(){return 0===this.uniqueValues.size?[]:Array.from(this.uniqueValues.values())}add(e,t,i=!1){let s=-1;if(this.uniqueValues.has(e)?s=this.indexOf(e):(this.uniqueValues.add(e),this.knownRecords.push(new Set),s+=this.uniqueValues.size),this.knownRecords[s].add(t),this.isBTree){let t=e instanceof Date?e.getTime():e;void 0===this.BTREE.get(t)&&this.BTREE.put(t,s)}this.emit(this.CREATE_EVENT,t,e,i)}remove(e,t,i=!1){if(void 0!==t){let s=this.recordsOf(t);if(s&&s.delete(e))return!this.isBTree||s&&0!==s.size||this.BTREE.delete(t instanceof Date?t.getTime():t),void this.emit(this.REMOVE_EVENT,e,t,i);NGN.WARN(`Index value "${t}" not found in index.`)}let s=!1;for(let i=0;i<this.knownRecords.length;i++)if(this.knownRecords[i].delete(e)&&!s){s=!0,t=Array.from(this.uniqueValues.values())[i],this.isBTree&&this.BTREE.delete(t instanceof Date?t.getTime():t);break}s&&this.emit(this.REMOVE_EVENT,e,t,i)}update(e,t,i,s=!1){t!==i&&(this.remove(e,t,!0),this.add(i,e,!0),this.emit(this.UPDATE_EVENT,e,null,s))}reset(){this.uniqueValues.clear(),this.knownRecords.splice(0),this.isBTree&&this.BTREE.reset(),this.emit("reset")}indexOf(e){return Array.from(this.uniqueValues.keys()).indexOf(e)}recordsOf(e){let t=this.indexOf(e);return t<0?null:this.knownRecords[t]}recordsFor(e){let t=this.recordsOf(e);return null===t||0===t.size?[]:Array.from(t.values())}},Store:class extends s{constructor(e={}){if("model"===NGN.typeof(e))e={model:e};else if(!e.model||!NGN.DATA.UTILITY.isDataModel(e.model))throw new InvalidConfigurationError('Missing or invalid "model" configuration property.');super();const t=this;if(Object.defineProperties(this,{name:NGN.const(NGN.coalesce(e.name,"Untitled Data Store")),METADATA:NGN.private({records:[],Model:NGN.coalesce(e.model),allowDuplicates:NGN.coalesce(e.allowDuplicates,!0),errorOnDuplicate:NGN.coalesce(e.errorOnDuplicate,e.allowDuplicates,!1),allowInvalid:NGN.coalesce(e.allowInvalid,!0),errorOnInvalid:NGN.coalesce(e.errorOnInvalid,e.allowInvalid,!1),autoRemoveExpiredRecords:NGN.coalesce(e.autoRemoveExpiredRecords,!0),softDelete:NGN.coalesce(e.softDelete,!1),softDeleteTtl:NGN.coalesce(e.softDeleteTtl,-1),fifo:NGN.coalesce(e.FIFO,-1),lifo:NGN.coalesce(e.LIFO,-1),maxRecords:NGN.coalesce(e.maxRecords,-1),minRecords:NGN.coalesce(e.minRecords,0),autocompact:NGN.coalesce(e.autocompact,5e4),MAP:NGN.coalesce(e.fieldmap),EVENTS:new Set(["record.duplicate","record.create","record.update","record.delete","record.restored","record.purged","record.move","record.invalid","record.valid","clear","filter.create","filter.delete","index.create","index.delete","compact.start","compact.complete"]),AUDITABLE:NGN.coalesce(e.audit,!1),AUDITLOG:NGN.coalesce(e.audit,!1)?new NGN.DATA.TransactionLog:null,AUDIT_HANDLER:e=>{e.hasOwnProperty("cursor")&&this.METADATA.AUDITLOG.commit(this.METADATA.getAuditMap())},FIRSTRECORDINDEX:0,LASTRECORDINDEX:0,INDEX:null}),PRIVATE:NGN.privateconst({STUB:Symbol("record.stub"),INDEX:function(e,i){if("symbol"==typeof this.event)switch(this.event){case t.PRIVATE.EVENT.CREATE_RECORD:t.METADATA.INDEXFIELDS.forEach(i=>t.METADATA.INDEX[i].add(e[i],e.OID));break;case t.PRIVATE.EVENT.DELETE_RECORD:t.METADATA.INDEXFIELDS.forEach(i=>t.METADATA.INDEX[i].remove(e.OID,e[i]));break;case t.PRIVATE.EVENT.LOAD_RECORDS:for(let e=0;e<t.METADATA.records.length;e++)t.METADATA.INDEXFIELDS.forEach(i=>t.METADATA.INDEX[i].add(t.METADATA.records[e][i],t.METADATA.records[e].OID));break;case t.PRIVATE.EVENT.DELETE_RECORD_FIELD:t.METADATA.INDEXFIELDS.has(e.field.name)&&t.METADATA.INDEX[e.field.name].remove(e.record.OID,e.field.value)}else switch(this.event){case"record.update":t.METADATA.INDEXFIELDS.has(i.field.name)&&t.METADATA.INDEX[i.field.name].update(e.OID,i.old,i.new);break;case"clear":t.METADATA.INDEXFIELDS.forEach(e=>t.METADATA.INDEX[e].reset())}},RECORDMAP:new Map,ACTIVERECORDMAP:null,FILTEREDRECORDMAP:null,EVENT:{CREATE_RECORD:Symbol("record.create"),DELETE_RECORD:Symbol("record.delete"),DELETE_RECORD_FIELD:Symbol("records.field.delete"),LOAD_RECORDS:Symbol("records.load")},checkModelIndexField:e=>{let t=this.METADATA.Model.prototype.CONFIGURATION;if(!t.fields||!t.fields.hasOwnProperty(e))throw new Error(`Cannot create index for unrecognized field "${e}".`);if(null!==t.fields[e]){if(["model","store","entity","function"].indexOf(NGN.typeof(t.fields[e]))>=0)throw new Error(`Cannot create index for "${e}" field. Only basic NGN.DATA.Field types can be indexed. Relationship and virtual fields cannot be indexed.`);if("object"===NGN.typeof(t.fields[e])&&["model","store","entity","function"].indexOf(NGN.typeof(NGN.coalesce(t.fields[e].type)))>=0)throw new Error(`Cannot create index for "${e}" field. Only basic NGN.DATA.Field types can be indexed. Relationship and virtual fields cannot be indexed.`)}},getModelFieldType:e=>{let t=this.METADATA.Model.prototype.CONFIGURATION;return null===t.fields[e]?NGN.typeof(t.fields[e]):t.fields[e].type?NGN.typeof(t.fields[e].type):t.fields[e].default?NGN.typeof(t.fields[e].default):NGN.typeof(NGN.coalesce(t.fields[e]))},addRecord:(e,i=!1)=>{const s=new t.METADATA.Model(e);if(!(s instanceof NGN.DATA.Entity))throw new Error(`Only a NGN.DATA.Model or JSON object may be used in NGN.DATA.Store#add. Received a "${NGN.typeof(e)}" value.`);if(!t.METADATA.allowInvalid&&!s.valid&&(NGN.WARN(`An attempt to add invalid data to the "${this.name}" store was prevented. The following fields are invalid: ${Array.from(s.METADATA.invalidFieldNames.keys()).join(", ")}`),i||this.emit("record.invalid",s),this.METADATA.errorOnInvalid))throw new Error(`Invalid data cannot be added to the "${this.name}" store.`);if(!t.METADATA.allowDuplicates)for(let e=0;e<this.METADATA.records.length;e++)if(this.METADATA.records[e].checksum===s.checksum){if(NGN.WARN(`An attempt to add a duplicate record to the "${this.name}" store was prevented.`),i||this.emit("record.duplicate",s),this.METADATA.errorOnDuplicate)throw new Error(`Duplicate records are not allowed in the "${this.name}" data store.`);break}return t.METADATA.lifo>0&&t.METADATA.records.length+1>t.METADATA.lifo?t.remove(t.METADATA.records.length-1,i):this.METADATA.fifo>0&&t.METADATA.records.length+1>t.METADATA.fifo&&t.remove(0,i),s.on("*",function(){switch(this.event){case"field.invalid":case"field.valid":return t.emit(this.event.replace("field.","record."),s)}}),delete s.METADATA.store,Object.defineProperty(s.METADATA,"store",NGN.get(()=>t)),t.METADATA.records.push(s),t.PRIVATE.RECORDMAP.set(s.OID,t.METADATA.records.length-1),s},convertStubToRecord:(e,t)=>{if(t.hasOwnProperty(this.PRIVATE.STUB)){let i=this.PRIVATE.addRecord(t.metadata,!1);return i.OID=t.OID,this.METADATA.records[e]=i,i}return t}}),delete:NGN.const(NGN.deprecate(this.remove,"Store.delete is deprecated. Use Store.remove instead."))}),Object.defineProperties(this.PRIVATE,{ACTIVERECORDS:NGN.get(()=>null===this.PRIVATE.ACTIVERECORDMAP?this.PRIVATE.RECORDMAP:this.PRIVATE.ACTIVERECORDMAP),FILTEREDRECORDS:NGN.get(()=>null===this.PRIVATE.FILTEREDRECORDMAP?this.PRIVATE.RECORDMAP:this.PRIVATE.FILTEREDRECORDMAP)}),Object.freeze(this.PRIVATE.EVENT),this.METADATA.lifo>0&&this.METADATA.fifo>0)throw new InvalidConfigurationError("NGN.DATA.Store can be configured to use FIFO or LIFO, but not both simultaneously.");this.METADATA.lifo>0||this.METADATA.fifo>0?(this.METADATA.minRecords=0,this.METADATA.maxRecords=-1):this.METADATA.minRecords=this.METADATA.minRecords<0?0:this.METADATA.minRecords,NGN.coalesce(e.index)&&"object"===NGN.typeof(this.METADATA.Model.prototype.CONFIGURATION.fields)&&this.createIndex(e.index),this.METADATA.autocompact<100&&(this.METADATA.DELETECOUNT=0,this.on(this.PRIVATE.EVENTS.DELETE_RECORD,()=>{this.METADATA.DELETECOUNT++,this.METADATA>=this.METADATA.autocompact&&(this.METADATA.DELETECOUNT=0,this.compact())}))}get snapshots(){return NGN.coalesce(this.snapshotarchive,[])}get history(){return NGN.WARN("history is deprecated. Use NGN.DATA.Store#changelog instead."),this.changelog}get recordCount(){return NGN.WARN("recordCount is deprecated. Use NGN.DATA.Store#size instead."),this.size}get size(){return this.PRIVATE.ACTIVERECORDS.size}get length(){return this.METADATA.records.length}get first(){let e=NGN.coalesce(this.METADATA.records[this.METADATA.FIRSTRECORDINDEX]);return this.PRIVATE.convertStubToRecord(this.METADATA.FIRSTRECORDINDEX,e)}get last(){let e=NGN.coalesce(this.METADATA.records[this.METADATA.LASTRECORDINDEX]);return this.PRIVATE.convertStubToRecord(this.METADATA.LASTRECORDINDEX,e)}get data(){const e=this.PRIVATE.ACTIVERECORDS;if(0===e.size)return[];let t=this.PRIVATE.convertStubToRecord(this.METADATA.FIRSTRECORDINDEX,this.METADATA.records[this.METADATA.FIRSTRECORDINDEX]);null===this.METADATA.MAP&&(this.METADATA.MAP=NGN.coalesce(t.MAP));let i=null;if(t instanceof NGN.DATA.Entity){let e=t.fieldDefinitions,s=Object.keys(e);i={},s.forEach(t=>{e[t].hidden||e[t].virtual||(i[t]=e[t].default)})}const s=[];return e.forEach(e=>{if(null!==this.METADATA.records[e])if(this.METADATA.records[e].hasOwnProperty(this.PRIVATE.STUB)){let t=Object.assign({},i),r=Object.assign(t,this.METADATA.records[e].metadata);null!==this.METADATA.MAP?s.push(this.METADATA.MAP.applyInverseMap(r)):s.push(r)}else s.push(this.METADATA.records[e].data)}),s}get representation(){const e=[];return this.PRIVATE.ACTIVERECORDS.forEach(t=>{null!==this.METADATA.records[t]&&e.push(this.METADATA.records[t].representation)}),e}get auditable(){return this.METADATA.AUDITABLE}set auditable(e){(e=NGN.forceBoolean(e))!==this.METADATA.AUDITABLE&&(this.METADATA.AUDITABLE=e,this.METADATA.AUDITLOG=e?new NGN.DATA.TransactionLog:null)}get model(){return this.METADATA.Model}get map(){return this.METADATA.MAP}get indexedFieldNames(){return this.METADATA.INDEXFIELDS?Array.from(this.METADATA.INDEXFIELDS):[]}add(e,t=!1){if("array"===NGN.typeof(e)){let i=new Array(e.length);for(let s=0;s<e.length;s++)i[s]=this.add(e[s],t);return i}if(this.METADATA.maxRecords>0&&this.METADATA.records.length+1>this.METADATA.maxRecords)throw new Error("Maximum record count exceeded.");if(e instanceof this.METADATA.Model)e=e.data;else if("string"===NGN.typeof(e)&&(e=JSON.parse(e)),"object"!=typeof e)throw new Error(`${NGN.typeof(e)} is an invalid data type (must be an object conforming to the ${this.METADATA.Model.name} field configuration).`);const i=this.PRIVATE.addRecord(e);return this.METADATA.LASTRECORDINDEX=this.METADATA.records.length-1,this.emit(this.PRIVATE.EVENT.CREATE_RECORD,i),t||this.emit("record.create",i),i}remove(e,t=!1){if(0===this.METADATA.records.length)return void NGN.INFO(`"${this.name}" store called remove(), but the store contains no records.`);if("array"===NGN.typeof(e)){let t=new Array(e.length);for(let i=0;i<e.length;i++)t[i]=this.remove(e[i]);return t}if(this.minRecords>0&&this.METADATA.records.length-1<this.minRecords)throw new Error("Removing this record would violate the minimum record count.");let i;switch(NGN.typeof(e)){case"number":if(e<0||!this.METADATA.records[e])return NGN.ERROR(`Record removal failed (record not found at index ${(e||"undefined").toString()}).`),null;i=e;break;default:if(!(e instanceof NGN.DATA.Entity))return NGN.ERROR("Invalid record value passed to Store.remove() method."),null;e=e.OID;case"symbol":if((i=this.PRIVATE.ACTIVERECORDS.get(e))<0)return NGN.ERROR(`Record removal failed. Record OID not found ("${e.toString()}").`),null}null===this.PRIVATE.ACTIVERECORDMAP&&(this.PRIVATE.ACTIVERECORDMAP=new Map(this.PRIVATE.RECORDMAP));const s=this.METADATA.records[i];if(null===s)return NGN.WARN("Specified record does not exist."),null;let r=this.PRIVATE.ACTIVERECORDS.get(s.OID);if(isNaN(r))return NGN.WARN(`Record not found for "${s.OID.toString()}".`),null;if(this.PRIVATE.ACTIVERECORDS.delete(s.OID),this.METADATA.softDelete?this.METADATA.softDeleteTtl>=0&&(s.once("expired",()=>{this.METADATA.records[this.PRIVATE.RECORDMAP.get(s.OID)]=null,this.PRIVATE.RECORDMAP.delete(s.OID),t||this.emit("record.purge",s)}),s.expires=this.METADATA.softDeleteTtl):(this.METADATA.records[this.PRIVATE.RECORDMAP.get(s.OID)]=null,this.PRIVATE.RECORDMAP.delete(s.OID)),this.METADATA.LASTRECORDINDEX===r){if(this.PRIVATE.ACTIVERECORDS.size<=1)this.METADATA.LASTRECORDINDEX=this.PRIVATE.ACTIVERECORDS.values().next().value,this.METADATA.FIRSTRECORDINDEX=this.METADATA.LASTRECORDINDEX;else if(0!==r)for(let e=r-1;e>=0;e--){if(0===e){this.METADATA.LASTRECORDINDEX=0;break}const t=this.METADATA.records[e];if(null!==t&&this.PRIVATE.ACTIVERECORDS.has(t.OID)){this.METADATA.LASTRECORDINDEX=this.PRIVATE.ACTIVERECORDS.get(t.OID);break}}}else if(this.METADATA.FIRSTRECORDINDEX===r){let e=this.PRIVATE.ACTIVERECORDS.size;for(let t=r+1;t<e;t++){const e=this.METADATA.records[t];if(null!==e&&this.PRIVATE.ACTIVERECORDS.has(e.OID)){this.METADATA.FIRSTRECORDINDEX=this.PRIVATE.ACTIVERECORDS.get(e.OID);break}}}return this.emit(this.PRIVATE.EVENT.DELETE_RECORD,s),t||this.emit("record.delete",s),s}createIndex(e){if("array"===NGN.typeof(e)){for(let t=0;t<e.length;t++)this.createIndex(e[t]);return}if(this.METADATA.INDEXFIELDS||(this.METADATA.INDEXFIELDS=new Set,this.on([this.PRIVATE.EVENT.CREATE_RECORD,this.PRIVATE.EVENT.DELETE_RECORD,this.PRIVATE.EVENT.LOAD_RECORDS,this.PRIVATE.EVENT.DELETE_RECORD_FIELD,"clear"],this.PRIVATE.INDEX)),this.METADATA.INDEXFIELDS.has(e))return;this.METADATA.INDEX=NGN.coalesce(this.METADATA.INDEX,{}),this.PRIVATE.checkModelIndexField(e),this.METADATA.INDEXFIELDS.add(e);let t=["number","date"].indexOf(this.PRIVATE.getModelFieldType(e))>=0;this.METADATA.INDEX[e]=new NGN.DATA.Index(t,`${e.toUpperCase()} ${t?"BTREE ":""}INDEX`),this.METADATA.records.length>0&&this.PRIVATE.INDEX.apply({event:this.PRIVATE.EVENT.LOAD_RECORDS}),this.emit("index.created",e)}removeIndex(e=null){if(this.METADATA.INDEXFIELDS)if(null===NGN.coalesce(e)&&(e=this.indexedFieldNames),"array"!==NGN.typeof(e))this.METADATA.INDEXFIELDS.delete(e),delete this.METADATA.INDEX[e],this.emit("index.delete",e),0===this.METADATA.INDEXFIELDS.size&&(this.METADATA.INDEX=null,delete this.METADATA.INDEXFIELDS,this.off([this.PRIVATE.EVENT.CREATE_RECORD,this.PRIVATE.EVENT.DELETE_RECORD,this.PRIVATE.EVENT.LOAD_RECORDS,this.PRIVATE.EVENT.DELETE_RECORD_FIELD],this.PRIVATE.INDEX));else for(let t=0;t<e.length;t++)this.removeIndex(e[t])}getRecordSibling(e,t=1,i=!1){let s=this.size;if(0===s)return NGN.WARN("Attempted to execute getRecordSibling with no active records."),null;if(Math.abs(t)>s&&(t%=s),1===s||0===t)return e;let r=Array.from(this.PRIVATE.ACTIVERECORDS),n=r.findIndex(t=>e.OID===t[0]);if(n<0)throw new Error("Record not found.");return((n+=t)>=r.length||n<0)&&i&&(t>0?n%=r.length:n=r.length-Math.abs(n)),n<0||n>=r.length?null:this.METADATA.records[r[n][1]]}indexOf(e){return this.PRIVATE.RECORDMAP.get(e.OID)}contains(e){return this.PRIVATE.ACTIVERECORDS.has(e.OID)}getIndexRecords(e,t){if(this.METADATA.INDEX&&this.METADATA.INDEX.hasOwnProperty(e)){let i=this.METADATA.INDEX[e].recordsFor(t),s=new Array(i.length);for(let e=0;e<i.length;e++)s[e]=this.METADATA.records[this.PRIVATE.RECORDMAP.get(i[e])];return s}return[]}getRecord(e=0){return"symbol"==typeof e&&(e=this.PRIVATE.ACTIVERECORDS.get(e)),e<0?(NGN.WARN("Cannot retrieve a record for a negative index."),null):e>=this.PRIVATE.ACTIVERECORDS.size?(NGN.WARN("Cannot retrieve a record for an out-of-scope index (index greater than total record count.)"),null):this.METADATA.records[Array.from(this.PRIVATE.ACTIVERECORDS)[e][1]]}clear(e=!0,t=!1){this.METADATA.ARCHIVE&&(e?delete this.METADATA.ARCHIVE:this.METADATA.ARCHIVE=this.records),this.METADATA.records=[],this.PRIVATE.RECORDMAP=new Map,this.PRIVATE.ACTIVERECORDMAP=null,this.PRIVATE.FILTEREDRECORDMAP=null,this.METADATA.LASTRECORDINDEX=0,this.METADATA.FIRSTRECORDINDEX=0,this.METADATA.AUDITABLE&&this.METADATA.AUDITLOG.reset(),t||this.emit("clear")}clearEvents(){super.clear(...arguments)}replaceModel(e){NGN.deprecate(()=>{this.model=e},"replaceModel has been deprected. Set the model directly instead.")}snapshot(){this.METADATA.snapshotarchive=NGN.coalesce(this.METADATA.snapshotarchive,[]);let e=this.data,t={id:NGN.DATA.UTILITY.GUID(),timestamp:(new Date).toISOString(),checksum:NGN.DATA.UTILITY.checksum(JSON.stringify(e)).toString(),modelChecksums:this.data.map(e=>NGN.DATA.UTILITY.checksum(JSON.stringify(e)).toString()),data:e};return this.METADATA.snapshotarchive.unshift(t),this.emit("snapshot",t),t}clearSnapshots(){this.snapshotarchive=null}load(e){let t;if(console.time("load"),this.METADATA.allowDuplicates)t=e;else{let i=new Set;t=[];for(let s=0;s<e.length;s++)if(i.has(JSON.stringify(e[s]))){if(this.METADATA.errorOnDuplicate)throw new NGNDuplicateRecordError}else i.add(JSON.stringify(e[s])),t.push(e[s])}let i=t.length+this.METADATA.records.length;if(this.METADATA.maxRecords>0&&i>this.METADATA.maxRecords)throw new Error("Maximum record count exceeded.");if(i>4e6)throw new Error("Maximum load size exceeded. A store may contain a maximum of 4M records.");for(let e=0;e<t.length;e++){let i=Symbol("model.id");this.METADATA.records.push({[this.PRIVATE.STUB]:!0,OID:i,metadata:t[e]}),this.PRIVATE.RECORDMAP.set(i,this.METADATA.records.length-1)}this.METADATA.LASTRECORDINDEX=this.METADATA.records.length-1}compact(){if(this.emit("compact.start"),this.METADATA.records.length<100)return this.emit("compact.complete"),void(0!==this.METADATA.records.length&&NGN.WARN(`compact() called on ${this.name} with fewer than 100 elements.`));let e=[],t=[],i=0;for(let s=0;s<this.METADATA.records.length;s++)null===this.METADATA.records[s]?(i++,0===t.length&&t.push(s)):(i>0&&(this.PRIVATE.RECORDMAP.set(this.METADATA.records[s].OID,s-i),this.METADATA.FIRSTRECORDINDEX===s&&(this.METADATA.FIRSTRECORDINDEX=s-i),this.METADATA.LASTRECORDINDEX===s&&(this.METADATA.LASTRECORDINDEX=s-i)),1===t.length&&(t.push(s-1),e.push(t),t=[]));for(i=0;e.length>0;)this.METADATA.records.splice(e[0][0]-i,e[0][1]-e[0][0]+1),i+=e[0][1]-e[0][0]+1,e.shift();this.PRIVATE.ACTIVERECORDMAP=null,this.emit("compact.complete")}forEach(e){if(!NGN.isFn(e))throw new Error(`A ${NGN.typeof(e)} was applied to ${this.name}'s each() method when a function was expected.`);this.PRIVATE.ACTIVERECORDS.forEach((t,i,s)=>{e(this.METADATA.records[t])})}},BTree:E,JSONSchema:class extends s{constructor(e={},t=null){switch(super(),Object.defineProperties(this,{METADATA:NGN.private({schema:e,ID:null,name:null}),PRIVATE:NGN.privateconst({MODELS:null,NET:NGN.coalesce(t,NGN.NET),parsed:!1,extractCommonPropertyAttributes:(e,t=[])=>{let i={};if(e.pattern&&(i.pattern=e.pattern),e.description&&(i.description=e.description),e.default&&(i.default=e.default),!e.$ref)if(e.type)switch("array"===NGN.typeof(e.type)?"array":e.type.trim().toLowerCase()){case"string":let s=NGN.coalesce(e.format,"unknown").trim().toLowerCase();switch(i.type=String,s){case"date":case"date-time":case"datetime":case"format-time":i.type=Date;break;case"ipv4":case"ipv6":i.pattern=NGN.coalesce(e.pattern,/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$|^(([a-zA-Z]|[a-zA-Z][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z]|[A-Za-z][A-Za-z0-9\-]*[A-Za-z0-9])$|^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$/);break;case"email":i.pattern=NGN.coalesce(e.pattern,/^[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+(?:[A-Z]{2}|com|org|net|gov|mil|biz|info|mobi|name|aero|jobs|museum)\b$/);break;case"hostname":i.pattern=NGN.coalesce(e.pattern,/^([a-zA-Z0-9]+(-[a-zA-Z0-9]+)*)+(\.([a-zA-Z0-9]+(-[a-zA-Z0-9]+)*))*$/);break;case"uri":i.pattern=NGN.coalesce(e.pattern,/(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9]\.[^\s]{2,})/)}break;case"integer":i.type=Number,i.pattern=/^\d+$/;break;case"number":i.type=Number;break;case"object":if(e.properties){let s=new NGN.DATA.JSONSchema(e);s.name=`${NGN.coalesce(this.name,"untitled")}_${NGN.coalesce(s.name,"submodel")}${t.length+1}`,s.getModelDefinitions(e=>{e[e.length-1].name=s.name,t=e.concat(t)}),i={$model:s.name}}else i.type=Object;break;default:i.type=String}else i.type=String;return i.type!==String&&i.type!==Number||(NGN.coalesce(e.minLength,e.minimum)&&(i.min=NGN.coalesce(e.minLength,e.minimum)),NGN.coalesce(e.maxLength,e.maximum)&&(i.max=NGN.coalesce(e.maxLength,e.maximum)),e.type===Number&&(e.multipleOf&&(i.multipleOf=e.multipleOf),e.exclusiveMinimum&&(i.min=e.exclusiveMinimum+1e-131),e.exclusiveMaximum&&(i.max=e.exclusiveMaximum-1e-131))),i.type===Array&&(e.hasOwnProperty("minItems")&&(i.min=e.minItems),e.hasOwnProperty("maxItems")&&(i.max=e.maxItems),e.hasOwnProperty("items")&&("array"===NGN.typeof(e.items)?i.tuples=e.items:(e.items.hasOwnProperty("type")&&(i.listType=NGN.getType(e.items.type)),e.items.hasOwnProperty("enum")&&(i.enum=e.items.enum)))),i},extractModelDefinitions:(e,t=[],i)=>{if(NGN.isFn(t)&&(i=t,t=[]),"object"===e.type){let s=NGN.coalesce(e.name,this.name,"Untitled");e.hasOwnProperty("$schema")&&null===s&&this.METADATA.URL&&(s=this.METADATA.URL.split(/\/|\\/).pop().replace(".json",""));let r={name:s,description:NGN.coalesce(e.description,"No description."),fields:{}};e.hasOwnProperty("$schema")&&(this.METADATA.ID=NGN.coalesce(e.$id,e.$schema));let n=new NGN.Tasks;if(e.hasOwnProperty("allOf"))for(let i=0;i<e.allOf.length;i++)n.add(`Identify base schema: ${e.allOf}`,s=>{let n=NGN.coalesce(e.allOf[i].$ref,e.allOf[i].$schema);if(null!==n)new NGN.DATA.JSONSchema(n).getModelDefinitions(e=>{let i=e.pop();Object.assign(r.fields,i.fields),e.length>0&&(t=e.concat(t)),this.METADATA.name=NGN.coalesce(this.METADATA.name,i.name),s()});else if(e.allOf[i].hasOwnProperty("properties")){let t=Object.keys(e.allOf[i].properties);for(let s=0;s<t.length;s++)r.fields[t[s]]=this.extractCommonPropertyAttributes(e.allOf[i].properties[t[s]]);s()}});n.add("Identify attributes",i=>{e.hasOwnProperty("dependencies")&&Object.keys(e.dependencies).forEach(t=>{let i=null,s=e.dependencies[t];"array"===NGN.typeof(s)?i=s:s.hasOwnProperty("required")&&(i=s.required),null!==i&&(r.rules[`${t} dependency on "${i.join(", ")}"`]=function(){if(null!==NGN.coalesce(this[t]))for(let e=0;e<i.length;e++)if(null===NGN.coalesce(this[i[e]]))return!1;return!0})});let s=Object.keys(e.properties),n=new NGN.Tasks;if(s.length>0)for(let i=0;i<s.length;i++){let a=s[i],o=e.properties[a];r.fields[a]=this.PRIVATE.extractCommonPropertyAttributes(o,t),o.$ref&&n.add(e=>{new NGN.DATA.JSONSchema(o.$ref).getModelDefinitions(i=>{t=i.concat(t),r.fields[a]={$model:i[i.length-1].name},e()})}),r.fields[a].required=NGN.coalesce(e.required,"").indexOf(a)>=0}n.on("complete",()=>{t.push(r),i()}),n.run(!0)}),n.on("complete",()=>i(t)),n.run(!0)}else i(t)}})}),this.once("parsed",()=>{this.PRIVATE.parsed=!0,this.METADATA.ID=NGN.coalesce(this.METADATA.schema.id,this.METADATA.schema.$schema)}),NGN.typeof(e)){case"string":this.METADATA.URL=e,this.PRIVATE.NET.json(e,(e,t)=>{if(e)throw e;this.METADATA.schema=t,this.METADATA.name=NGN.coalesce(t.name,this.METADATA.URL.split(/\/|\\/).pop().replace(".json","")),this.emit("parsed")});break;case"object":this.METADATA.name=NGN.coalesce(e.name,"Untitled"),this.emit("parsed");break;default:throw new Error("Invalid schema definition.")}}get id(){if(this.METADATA.ID)return this.METADATA.ID;let e,t=NGN.coalesce(this.METADATA.URL);return null!==t?t:(e=NGN.coalesce(this.PRIVATE.NET.baseUrl,window.location.origin),this.METADATA.ID=this.PRIVATE.NET.normalizeUrl(`${e}/${NGN.coalesce(this.name,"untitled").toLowerCase()}.json`),this.METADATA.ID)}get name(){return this.METADATA.name}set name(e){this.METADATA.name=NGN.coalesce(e,"Untitled")}getModelDefinitions(e){this.PRIVATE.parsed?this.PRIVATE.MODELS?e(this.PRIVATE.MODELS):this.PRIVATE.extractModelDefinitions(this.METADATA.schema,[],t=>{this.PRIVATE.MODELS=t,e(t)}):this.once("parsed",()=>{this.getModelDefinitions(e)})}}});i.extend("EventEmitter",i.public(s)),i.extend("BUS",i.const(new i.EventEmitter)),i.extend("Task",i.const(class extends s{constructor(e){super(e=e||{}),Object.defineProperties(this,{name:NGN.const(NGN.coalesce(e.name,"Unknown")),callback:NGN.privateconst(e.callback),number:NGN.const(parseInt(e.number,10)),timer:NGN.private(null),_status:NGN.private(null),bus:NGN.private(e.buz),_skip:NGN.private(!1)}),this.on("timeout",()=>{this._status="timedout"}),this.on("skip",()=>{this._status="skipped"})}get status(){return this._status}get skipped(){return this._skip}run(e){if(this.skipped)return this.emit("skip",this),void(e&&"dev"===e&&NGN.WARN("SKIPPED "+this.name));this.emit("start",this),e&&"dev"===e&&NGN.INFO("Executing "+this.name+":"),this._status="running";const t=this,i={name:this.name,number:this.number,timeout:function(e){t.timer=setTimeout(function(){t.emit("timeout",t)},e)}};this.callback.apply(i,[function(){t._status="complete",t.emit("complete",t)}]),0===this.callback.length&&(t._status="complete",t.emit("complete",t))}skip(){"running"===this._status?NGN.WARN(`Cannot skip step: ${this.name} is currently running.`):"timedout"===this._status?NGN.WARN(`Cannot skip step: ${this.name} timed out.`):"complete"===this._status&&NGN.WARN(`Cannot skip step: ${this.name} already completed.`),this._skip=!0}})),i.extend("Queue",i.const(class extends s{constructor(e="production"){super(),Object.defineProperties(this,{steps:NGN.private([]),completed:NGN.private(0),timeout:NGN.private(null),_mode:NGN.private(e),_cancel:NGN.private(!1),processing:NGN.private(!1),timer:NGN.private(null),sequential:NGN.private(!1)}),this.on("taskcomplete",e=>{this.sequential||"completed"===e.status||(e._status="complete",this.completed++,"dev"===this.mode&&NGN.INFO(e.name+" completed."),this.completed===this.steps.length&&(this.processing=!1,Object.keys(this.steps).forEach(e=>{clearTimeout(this.steps[e].timer)}),this.emit("complete")))}),this.on("aborting",()=>{this._cancel=!0})}get list(){return this.steps.map(function(e){return{id:e.number,name:e.name,status:e.status}})}get mode(){return this._mode}set mode(e){"dev"===e.toLowerCase().substr(0,3)?this._mode="dev":this._mode="production"}get cancelled(){return this._cancel}onTimeout(){let e=[];this.steps.length>0&&this.steps.forEach(t=>{e.push(t.name,null===t.status?"NOT STARTED":t.status)}),this.emit("timeout",{process:e}),e=null}add(e,t){if(this.processing)return NGN.WARN("Cannot add a step while processing.");if("function"==typeof e&&(t=e,e="Step "+(parseInt(this.steps.length)+1)),"function"!=typeof t)throw new Error("No processing method defined for step "+(parseInt(this.steps.length)+1)+".");const i=new NGN.Task({name:e,callback:t,number:(this.steps.length>0?this.steps[this.steps.length-1].number:0)+1});return i.on("complete",e=>this.emit("taskcomplete",e)),i.on("timeout",e=>{"running"!==e.status&&"timedout"!==e.status||this.emit("tasktimeout",e)}),this.steps.push(i),this.emit("taskcreate",i),i}getAt(e){return this.steps[e]}get(e){let t=this.steps.filter(t=>t.name===e);return 1===t.length?t[0]:1===(t=this.steps.filter(t=>t.number===e)).length?t[0]:void 0}remove(e){if(this.processing)return NGN.WARN("Cannot add a step while processing.");let t=this.steps.filter(t=>t.name===e);return 1===t.length?(this.steps=this.steps.filter(t=>t.name!==e),this.emit("taskremove",t[0]),t[0]):1===(t=this.steps.filter(t=>t.number===e)).length?(this.steps=this.steps.filter(t=>t.number!==e),this.emit("taskremove",t[0]),t[0]):void 0}removeAt(e){return this.processing?NGN.WARN("Cannot add a step while processing."):"number"!=typeof e?console.error("Failed to remove step: "+e):e<0||e>=this.steps.length?console.error("Step index "+e+" could not be found or does not exist."):this.steps.splice(e,1)[0]}reset(){if(this.processing)return NGN.WARN("Cannot reset a running queue. Abort or wait for the process to complete before resetting.");this.steps.forEach(e=>{e._skip=!1})}process(e=!1){if(this.processing)return NGN.WARN("Cannot start processing (already running). Please wait for this process to complete before calling process() again.");if(0===this.steps.length)return this.emit("complete");if(this.processing=!0,this._cancel=!1,null!==this.timeout&&(this.timer=setTimeout(()=>this.onTimeout(),this.timeout)),this.sequential="boolean"==typeof e&&e,this.sequential){let e=this.steps,t=new NGN.EventEmitter;t.on("taskcomplete",()=>{if(e.length>0){const i=e.shift();if(i.skipped)return t.emit("taskcomplete");i.on("complete",()=>t.emit("taskcomplete")),i.on("start",()=>this.emit("taskstart",i)),i.run(this.mode)}else this.emit("complete")});let i=e.shift();i.on("complete",()=>t.emit("taskcomplete")),i.on("start",()=>this.emit("taskstart",i)),i.run(this.mode)}else for(let e=0;e<this.steps.length;e++)this.steps[e].run(this.mode)}run(){this.process(...arguments)}abort(){this.emit("aborting"),this.each(e=>{["completed","running","timedout"].indexOf(e.status)<0&&!e.skipped&&e.skip()}),this.once("complete",()=>this.emit("aborted"))}each(e){for(let t=0;t<this.steps.length;t++)e(this.steps[t])}cancel(){this.abort(...arguments)}})),i.extend("Tasks",i.deprecate(i.Queue,"NGN.Tasks is now NGN.Queue")),i.extend("NET",i.const(c)),i.extend("UTILITY",i.const(r)),i.extend("DATA",i.const(M)),Object.defineProperty(i,"version",{enumerable:!0,writable:!1,configurable:!1,value:"2.0.0"})}();
//# sourceMappingURL=ngn.min.js.map
